name: Build AIT

on:
  workflow_call:
    inputs:
      ref:
        description: 'Git ref to checkout'
        type: string
        required: true
      version:
        description: 'SDK version for AIT filename'
        type: string
        required: true

jobs:
  # =====================================================
  # AIT Build - macOS
  # =====================================================
  build-macos:
    name: AIT Build (macOS, Unity ${{ matrix.unity-version }})
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 60

    # NOTE: job-level concurrency 제거됨
    # - self-hosted runner는 동시에 1개 job만 실행하므로 별도 동시성 제어 불필요
    # - job-level concurrency + cancel-in-progress: false 조합은
    #   "higher priority waiting request"로 인한 예기치 않은 취소 유발

    strategy:
      fail-fast: false
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2", "6000.3"]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref }}

      - name: Clean Previous Build Artifacts
        run: |
          PROJECT_PATH="Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}"
          echo "Cleaning previous build artifacts..."
          rm -rf "${PROJECT_PATH}/ait-build" 2>/dev/null || true
          rm -rf "${PROJECT_PATH}/webgl" 2>/dev/null || true
          echo "Done."

      - name: Detect Unity Installation
        id: unity
        run: |
          UNITY_BASE="/Applications/Unity/Hub/Editor"
          UNITY_VERSION_PATTERN="${{ matrix.unity-version }}"

          echo "Searching for Unity ${UNITY_VERSION_PATTERN}.x in ${UNITY_BASE}..."

          UNITY_DIR=$(ls -d "${UNITY_BASE}/${UNITY_VERSION_PATTERN}"* 2>/dev/null | sort -rV | head -1)

          if [ -z "$UNITY_DIR" ]; then
            echo "::error::Unity ${UNITY_VERSION_PATTERN}.x not found"
            echo "Available versions:"
            ls -la "${UNITY_BASE}" 2>/dev/null || echo "Unity Hub Editor directory not found"
            exit 1
          fi

          UNITY_PATH="${UNITY_DIR}/Unity.app/Contents/MacOS/Unity"

          if [ ! -f "$UNITY_PATH" ]; then
            echo "::error::Unity executable not found at ${UNITY_PATH}"
            exit 1
          fi

          DETECTED_VERSION=$(basename "${UNITY_DIR}")
          echo "✓ Found Unity ${DETECTED_VERSION}"
          echo "  Path: ${UNITY_PATH}"

          echo "UNITY_PATH=${UNITY_PATH}" >> $GITHUB_OUTPUT
          echo "UNITY_VERSION=${DETECTED_VERSION}" >> $GITHUB_OUTPUT

      - name: Update BuildConfig SDK Version
        run: |
          VERSION="${{ inputs.version }}"
          BUILD_CONFIG_DIR="WebGLTemplates/AITTemplate/BuildConfig"
          BUILD_CONFIG="${BUILD_CONFIG_DIR}/package.json"
          LOCK_FILE="${BUILD_CONFIG_DIR}/pnpm-lock.yaml"

          echo "Updating @apps-in-toss/web-framework to ${VERSION}"

          # sed로 버전 업데이트 (jq가 없는 환경에서도 작동)
          sed -i '' 's/"@apps-in-toss\/web-framework": "[^"]*"/"@apps-in-toss\/web-framework": "'"$VERSION"'"/' "$BUILD_CONFIG"

          echo "Updated BuildConfig:"
          cat "$BUILD_CONFIG"

          # pnpm-lock.yaml 삭제 후 재생성 (frozen-lockfile 호환성 유지)
          rm -f "$LOCK_FILE"
          echo "Regenerating pnpm-lock.yaml..."
          cd "$BUILD_CONFIG_DIR"
          npx pnpm@9 install --lockfile-only
          echo "✓ pnpm-lock.yaml regenerated"

      - name: Build Unity WebGL
        env:
          AIT_DEBUG_CONSOLE: "true"
        run: |
          UNITY_PATH="${{ steps.unity.outputs.UNITY_PATH }}"
          PROJECT_PATH="${{ github.workspace }}/Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}"

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Unity Build Configuration"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Unity Version: ${{ steps.unity.outputs.UNITY_VERSION }}"
          echo "Unity Path: ${UNITY_PATH}"
          echo "Project Path: ${PROJECT_PATH}"
          echo "SDK Version: ${{ inputs.version }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          "$UNITY_PATH" -quit -batchmode -nographics \
            -projectPath "$PROJECT_PATH" \
            -executeMethod E2EBuildRunner.CommandLineBuild \
            -buildTarget WebGL \
            -logFile -

      - name: Verify Build Output
        run: |
          DIST_PATH="Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/dist"
          AIT_BUILD_PATH="Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build"

          if [ ! -d "$DIST_PATH" ]; then
            echo "❌ Build output not found at $DIST_PATH"
            exit 1
          fi

          echo "✅ dist/ 폴더 확인됨"
          echo ""
          echo "dist/ 내용:"
          ls -la "$DIST_PATH"
          echo ""
          echo "dist/web/ 내용:"
          ls -la "$DIST_PATH/web" || true
          echo ""

          # .ait 파일 확인 (dist/ 또는 ait-build/ 폴더에서)
          AIT_FILE=$(find "$DIST_PATH" -maxdepth 1 -name "*.ait" -type f 2>/dev/null | head -1)
          if [ -z "$AIT_FILE" ]; then
            AIT_FILE=$(find "$AIT_BUILD_PATH" -maxdepth 1 -name "*.ait" -type f 2>/dev/null | head -1)
          fi

          if [ -z "$AIT_FILE" ]; then
            echo "❌ .ait 파일이 생성되지 않았습니다!"
            echo "ait-build/ 루트 내용:"
            ls -la "$AIT_BUILD_PATH"
            echo ""
            echo "::error::.ait 파일 미생성 - 배포에 필요한 파일이 없습니다"
            exit 1
          fi

          echo "✅ .ait 파일 생성 확인: $AIT_FILE"

      # ait deploy는 ait-build/ 디렉토리 내에서 실행되어야 함
      # 배포에 필요한 파일만 업로드 (node_modules, public 등 제외하여 용량 절감)

      - name: Upload AIT Package
        uses: actions/upload-artifact@v6
        with:
          name: ait-build-macos-${{ matrix.unity-version }}
          path: |
            Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/dist/
            Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/*.ait
            Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/package.json
            Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/pnpm-lock.yaml
            Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/granite.config.ts
          if-no-files-found: error
          retention-days: 7

  # =====================================================
  # AIT Build - Windows
  # =====================================================
  build-windows:
    name: AIT Build (Windows, Unity ${{ matrix.unity-version }})
    runs-on: [self-hosted, Windows, X64, enabled]
    timeout-minutes: 60

    # NOTE: job-level concurrency 제거됨
    # - self-hosted runner는 동시에 1개 job만 실행하므로 별도 동시성 제어 불필요
    # - job-level concurrency + cancel-in-progress: false 조합은
    #   "higher priority waiting request"로 인한 예기치 않은 취소 유발

    strategy:
      fail-fast: false
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2", "6000.3"]

    steps:
      - name: Configure Git Long Paths
        shell: cmd
        run: |
          @echo off
          setlocal enabledelayedexpansion
          set MAX_RETRIES=5
          set RETRY=0
          :retry_loop
          git config --global core.longPaths true 2>nul && (
            echo Git longPaths configured successfully
            exit /b 0
          )
          set /a RETRY+=1
          if !RETRY! LSS %MAX_RETRIES% (
            echo Retry !RETRY!/%MAX_RETRIES%...
            timeout /t 2 /nobreak >nul
            goto retry_loop
          )
          echo Git longPaths configuration completed
          exit /b 0

      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref }}

      - name: Exclude Project from Windows Defender
        shell: cmd
        continue-on-error: true
        run: |
          @echo off
          powershell -Command "Add-MpPreference -ExclusionPath '${{ github.workspace }}' -ErrorAction SilentlyContinue" 2>nul
          powershell -Command "Add-MpPreference -ExclusionPath 'C:\Program Files\Unity' -ErrorAction SilentlyContinue" 2>nul
          echo Windows Defender exclusions configured (or skipped if no admin rights)
          exit /b 0

      - name: Clean Previous Build Artifacts
        shell: cmd
        run: |
          @echo off
          set "PROJECT_PATH=Tests~\E2E\SampleUnityProject-${{ matrix.unity-version }}"
          echo Cleaning previous build artifacts...
          if exist "%PROJECT_PATH%\ait-build" rmdir /s /q "%PROJECT_PATH%\ait-build"
          if exist "%PROJECT_PATH%\webgl" rmdir /s /q "%PROJECT_PATH%\webgl"
          echo Done.

      - name: Detect Unity Installation
        id: unity
        shell: cmd
        run: |
          @echo off
          setlocal enabledelayedexpansion

          set "UNITY_BASE=C:\Program Files\Unity\Hub\Editor"
          set "VERSION_PATTERN=${{ matrix.unity-version }}"

          echo Searching for Unity %VERSION_PATTERN%.x in %UNITY_BASE%...

          set "UNITY_DIR="
          for /d %%d in ("%UNITY_BASE%\%VERSION_PATTERN%*") do (
            set "UNITY_DIR=%%d"
          )

          if not defined UNITY_DIR (
            echo ::error::Unity %VERSION_PATTERN%.x not found
            echo Available versions:
            dir /b "%UNITY_BASE%" 2>nul
            exit /b 1
          )

          set "UNITY_PATH=%UNITY_DIR%\Editor\Unity.exe"

          if not exist "%UNITY_PATH%" (
            echo ::error::Unity executable not found at %UNITY_PATH%
            exit /b 1
          )

          for %%i in ("%UNITY_DIR%") do set "DETECTED_VERSION=%%~nxi"
          echo Found Unity %DETECTED_VERSION%
          echo   Path: %UNITY_PATH%

          echo UNITY_PATH=%UNITY_PATH%>> %GITHUB_OUTPUT%
          echo UNITY_VERSION=%DETECTED_VERSION%>> %GITHUB_OUTPUT%

      - name: Update BuildConfig SDK Version
        shell: bash
        run: |
          VERSION="${{ inputs.version }}"
          BUILD_CONFIG_DIR="WebGLTemplates/AITTemplate/BuildConfig"
          BUILD_CONFIG="${BUILD_CONFIG_DIR}/package.json"
          LOCK_FILE="${BUILD_CONFIG_DIR}/pnpm-lock.yaml"

          echo "Updating @apps-in-toss/web-framework to ${VERSION}"

          # sed로 버전 업데이트 (jq가 없는 환경에서도 작동)
          sed -i 's/"@apps-in-toss\/web-framework": "[^"]*"/"@apps-in-toss\/web-framework": "'"$VERSION"'"/' "$BUILD_CONFIG"

          echo "Updated BuildConfig:"
          cat "$BUILD_CONFIG"

          # pnpm-lock.yaml 삭제 후 재생성 (frozen-lockfile 호환성 유지)
          rm -f "$LOCK_FILE"
          echo "Regenerating pnpm-lock.yaml..."
          cd "$BUILD_CONFIG_DIR"
          npx pnpm@9 install --lockfile-only
          echo "✓ pnpm-lock.yaml regenerated"

      - name: Build Unity WebGL
        shell: powershell -ExecutionPolicy Bypass -File {0}
        env:
          AIT_DEBUG_CONSOLE: "true"
        run: |
          $unityPath = "${{ steps.unity.outputs.UNITY_PATH }}"
          $projectPath = "${{ github.workspace }}\Tests~\E2E\SampleUnityProject-${{ matrix.unity-version }}"

          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          Write-Host "Unity Build Configuration"
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          Write-Host "Unity Version: ${{ steps.unity.outputs.UNITY_VERSION }}"
          Write-Host "Unity Path: $unityPath"
          Write-Host "Project Path: $projectPath"
          Write-Host "SDK Version: ${{ inputs.version }}"
          Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          $logFile = "$env:TEMP\unity-build-${{ matrix.unity-version }}.log"
          Write-Host "Starting Unity build..."
          Write-Host "Log file: $logFile"

          $unityProcess = Start-Process -FilePath $unityPath -ArgumentList @(
            "-quit", "-batchmode", "-nographics",
            "-projectPath", $projectPath,
            "-executeMethod", "E2EBuildRunner.CommandLineBuild",
            "-buildTarget", "WebGL",
            "-logFile", $logFile
          ) -PassThru -NoNewWindow

          Write-Host "Waiting for Unity build to complete..."
          $lastSize = 0
          while (-not $unityProcess.HasExited) {
            Start-Sleep -Seconds 2
            if (Test-Path $logFile) {
              $content = Get-Content $logFile -Raw -ErrorAction SilentlyContinue
              if ($content -and $content.Length -gt $lastSize) {
                $newContent = $content.Substring($lastSize)
                Write-Host $newContent
                $lastSize = $content.Length
              }
            }
          }

          if (Test-Path $logFile) {
            $content = Get-Content $logFile -Raw -ErrorAction SilentlyContinue
            if ($content -and $content.Length -gt $lastSize) {
              Write-Host $content.Substring($lastSize)
            }
          }

          if ($unityProcess.ExitCode -ne 0) {
            Write-Host "::error::Unity build failed with exit code: $($unityProcess.ExitCode)"
            exit $unityProcess.ExitCode
          }

          Write-Host "Unity build completed successfully"

      - name: Verify Build Output
        shell: cmd
        run: |
          @echo off
          setlocal enabledelayedexpansion
          set "DIST_PATH=Tests~\E2E\SampleUnityProject-${{ matrix.unity-version }}\ait-build\dist"
          set "AIT_BUILD_PATH=Tests~\E2E\SampleUnityProject-${{ matrix.unity-version }}\ait-build"

          if not exist "%DIST_PATH%" (
            echo ::error::Build output not found at %DIST_PATH%
            exit /b 1
          )

          echo ✅ dist\ 폴더 확인됨
          echo.
          echo dist\ 내용:
          dir "%DIST_PATH%"
          echo.
          echo dist\web\ 내용:
          dir "%DIST_PATH%\web" 2>nul
          echo.

          REM .ait 파일 확인 (dist\ 또는 ait-build\ 폴더에서)
          set "AIT_FILE="
          for %%f in ("%DIST_PATH%\*.ait") do (
            set "AIT_FILE=%%f"
            goto :found_ait
          )
          for %%f in ("%AIT_BUILD_PATH%\*.ait") do (
            set "AIT_FILE=%%f"
            goto :found_ait
          )

          echo ❌ .ait 파일이 생성되지 않았습니다!
          echo ait-build\ 루트 내용:
          dir "%AIT_BUILD_PATH%"
          echo.
          echo ::error::.ait 파일 미생성 - 배포에 필요한 파일이 없습니다
          exit /b 1

          :found_ait
          echo ✅ .ait 파일 생성 확인: !AIT_FILE!

      # ait deploy는 ait-build/ 디렉토리 내에서 실행되어야 함
      # 배포에 필요한 파일만 업로드 (node_modules, public 등 제외하여 용량 절감)

      - name: Upload AIT Package
        uses: actions/upload-artifact@v6
        with:
          name: ait-build-windows-${{ matrix.unity-version }}
          path: |
            Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/dist/
            Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/*.ait
            Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/package.json
            Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/pnpm-lock.yaml
            Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/granite.config.ts
          if-no-files-found: error
          retention-days: 7
