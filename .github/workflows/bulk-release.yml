name: Bulk Release

on:
  workflow_dispatch:
    inputs:
      versions:
        description: '버전 목록 (콤마 구분, 예: 1.5.0,1.6.0,1.7.0) - 비어있으면 모든 release/v* 태그 대상'
        required: false
        type: string
      max_parallel:
        description: '동시 실행 버전 수 (기본: 2)'
        required: false
        type: number
        default: 2

jobs:
  # =====================================================
  # 버전 목록 준비
  # =====================================================
  prepare-versions:
    name: 버전 목록 준비
    runs-on: ubuntu-latest

    outputs:
      versions: ${{ steps.extract.outputs.versions }}
      version_count: ${{ steps.extract.outputs.count }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: 버전 추출
        id: extract
        run: |
          INPUT_VERSIONS="${{ inputs.versions }}"

          if [ -n "$INPUT_VERSIONS" ]; then
            echo "=== 입력된 버전 사용 ==="
            # 콤마로 구분된 버전을 줄바꿈으로 변환 후 정렬
            VERSIONS=$(echo "$INPUT_VERSIONS" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sort -V)
          else
            echo "=== Git 태그에서 버전 추출 ==="
            # release/v* 태그에서 버전 추출
            VERSIONS=$(git tag -l 'release/v*' | sed 's/release\/v//' | sort -V)
          fi

          # 버전이 없으면 에러
          if [ -z "$VERSIONS" ]; then
            echo "::error::릴리즈할 버전이 없습니다"
            exit 1
          fi

          # 버전 목록 출력
          echo "발견된 버전:"
          echo "$VERSIONS"
          echo ""

          # JSON 배열로 변환
          JSON_VERSIONS=$(echo "$VERSIONS" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "JSON 배열: ${JSON_VERSIONS}"

          # 버전 개수
          COUNT=$(echo "$VERSIONS" | grep -c .)
          echo "총 ${COUNT}개 버전"

          # 출력 설정
          echo "versions=${JSON_VERSIONS}" >> $GITHUB_OUTPUT
          echo "count=${COUNT}" >> $GITHUB_OUTPUT

      - name: 버전 목록 요약
        run: |
          echo "## 일괄 릴리즈 대상 버전" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| # | 버전 |" >> $GITHUB_STEP_SUMMARY
          echo "|---|------|" >> $GITHUB_STEP_SUMMARY

          VERSIONS='${{ steps.extract.outputs.versions }}'
          INDEX=1
          for VERSION in $(echo "$VERSIONS" | jq -r '.[]'); do
            echo "| ${INDEX} | v${VERSION} |" >> $GITHUB_STEP_SUMMARY
            INDEX=$((INDEX + 1))
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**총 ${{ steps.extract.outputs.count }}개 버전**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**동시 실행 수**: ${{ inputs.max_parallel || 2 }}" >> $GITHUB_STEP_SUMMARY

  # =====================================================
  # 각 버전별 릴리즈 실행 (병렬)
  # =====================================================
  release-versions:
    name: 릴리즈 v${{ matrix.version }}
    needs: prepare-versions
    if: needs.prepare-versions.outputs.version_count > 0

    strategy:
      fail-fast: false
      max-parallel: ${{ fromJSON(inputs.max_parallel || '2') }}
      matrix:
        version: ${{ fromJSON(needs.prepare-versions.outputs.versions) }}

    uses: ./.github/workflows/release.yml
    with:
      version: ${{ matrix.version }}
      skip_notification: true
    secrets: inherit

  # =====================================================
  # 결과 요약
  # =====================================================
  summary:
    name: 일괄 릴리즈 요약
    runs-on: ubuntu-latest
    needs: [prepare-versions, release-versions]
    if: always()

    steps:
      - name: 배포 결과 아티팩트 다운로드
        uses: actions/download-artifact@v4
        with:
          pattern: deploy-results-*
          path: all-deploy-results/
        continue-on-error: true

      - name: 통합 배포 알림 전송
        env:
          DEPLOY_WEBHOOK_URL: "https://ipd-public-gateway.core.toss-internal.com/api-public/v3/ipd-public-gateway/webhooks/ipd-corp-core-automation-webhook/8b6db539-6cb4-4b99-b2a8-8981c43b2592"
        run: |
          VERSIONS='${{ needs.prepare-versions.outputs.versions }}'

          # 최신 버전 확인 (배열의 마지막 요소)
          LATEST_VERSION=$(echo "$VERSIONS" | jq -r '.[-1]')
          echo "최신 버전: ${LATEST_VERSION}"

          # 모든 배포 결과 수집
          ALL_RESULTS=""
          HAS_ANY_RESULT=false

          if [ -d "all-deploy-results" ]; then
            echo "=== 배포 결과 수집 ==="
            for dir in all-deploy-results/deploy-results-*/; do
              if [ -d "$dir" ] && [ -f "${dir}deploy-results.txt" ]; then
                echo "처리 중: $dir"
                HAS_ANY_RESULT=true

                # 파일에서 버전과 결과 추출
                FILE_VERSION=$(grep "^version=" "${dir}deploy-results.txt" | cut -d= -f2)
                echo "  버전: ${FILE_VERSION}"

                # RESULTS 섹션 이후의 내용 추출
                RESULTS=$(sed -n '/^---RESULTS---$/,$ p' "${dir}deploy-results.txt" | tail -n +2)

                if [ -n "$RESULTS" ]; then
                  # 각 결과 줄에 버전 정보 추가
                  while IFS= read -r line; do
                    if [ -n "$line" ]; then
                      # 결과 라인이 해당 버전의 것인지 확인 (다른 버전 결과 필터링)
                      # 형식: "macOS - 2021.3: URL" 또는 이미 버전이 포함된 경우 스킵
                      PLATFORM=$(echo "$line" | cut -d: -f1 | xargs)
                      STATUS=$(echo "$line" | cut -d: -f2- | xargs)

                      # 이미 버전 정보가 포함되어 있는지 확인 (예: "macOS - 2021.3-v1.6.1")
                      if echo "$PLATFORM" | grep -qE '\-v[0-9]+\.[0-9]+\.[0-9]+'; then
                        # 이미 버전 정보 포함 - 해당 버전과 일치하는 경우만 추가
                        if echo "$PLATFORM" | grep -q "\-v${FILE_VERSION}$"; then
                          ALL_RESULTS="${ALL_RESULTS}${PLATFORM}: ${STATUS}\n"
                        fi
                        # 다른 버전의 결과는 무시
                      else
                        # 버전 정보 없음 - 버전 추가
                        ALL_RESULTS="${ALL_RESULTS}${PLATFORM}-v${FILE_VERSION}: ${STATUS}\n"
                      fi
                    fi
                  done <<< "$RESULTS"
                fi
              fi
            done
          fi

          if [ "$HAS_ANY_RESULT" = false ]; then
            echo "::warning::수집된 배포 결과가 없습니다"
            ALL_RESULTS="배포 결과 없음"
          fi

          echo ""
          echo "=== 통합 배포 결과 ==="
          echo -e "$ALL_RESULTS"
          echo ""

          echo "=== 배포 알림 전송 ==="
          echo "버전: ${LATEST_VERSION}"

          # jq로 안전한 JSON 생성
          JSON_PAYLOAD=$(jq -n \
            --arg version "$LATEST_VERSION" \
            --arg urls "$(echo -e "$ALL_RESULTS")" \
            '{version: $version, urlsForEdition: $urls}')

          echo "전송할 JSON:"
          echo "$JSON_PAYLOAD"

          # HTTP 상태 코드 확인하여 실패 처리
          HTTP_STATUS=$(curl -s -o /tmp/webhook_response.txt -w "%{http_code}" -X POST "$DEPLOY_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")

          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "✅ 통합 알림 전송 완료 (HTTP ${HTTP_STATUS})"
          else
            echo "::error::알림 전송 실패 (HTTP ${HTTP_STATUS})"
            cat /tmp/webhook_response.txt
            exit 1
          fi

      - name: 결과 요약 생성
        run: |
          echo "## 일괄 릴리즈 결과" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          RELEASE_RESULT="${{ needs.release-versions.result }}"
          VERSIONS='${{ needs.prepare-versions.outputs.versions }}'
          VERSION_COUNT="${{ needs.prepare-versions.outputs.version_count }}"

          # 릴리즈 결과에 따른 상태 표시
          case "$RELEASE_RESULT" in
            success)
              echo "### ✅ 모든 릴리즈 성공" >> $GITHUB_STEP_SUMMARY
              ;;
            failure)
              echo "### ❌ 일부 릴리즈 실패" >> $GITHUB_STEP_SUMMARY
              ;;
            cancelled)
              echo "### ⚠️ 릴리즈 취소됨" >> $GITHUB_STEP_SUMMARY
              ;;
            skipped)
              echo "### ⏭️ 릴리즈 스킵됨" >> $GITHUB_STEP_SUMMARY
              ;;
            *)
              echo "### ❓ 알 수 없는 상태: ${RELEASE_RESULT}" >> $GITHUB_STEP_SUMMARY
              ;;
          esac

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**처리된 버전 (${VERSION_COUNT}개)**:" >> $GITHUB_STEP_SUMMARY

          for VERSION in $(echo "$VERSIONS" | jq -r '.[]'); do
            TAG_NAME="release/v${VERSION}"
            RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${TAG_NAME}"
            echo "- [v${VERSION}](${RELEASE_URL})" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "개별 릴리즈 상세 결과는 위의 각 job에서 확인하세요." >> $GITHUB_STEP_SUMMARY
