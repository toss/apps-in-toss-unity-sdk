name: Preview Deploy

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # =====================================================
  # ÏΩîÎ©òÌä∏ ÌååÏã± Î∞è ÎπåÎìú ÎåÄÏÉÅ Í≤∞Ï†ï
  # =====================================================
  parse-command:
    name: Parse Command
    runs-on: ubuntu-latest
    # PR ÏΩîÎ©òÌä∏ÏóêÏÑú /previewÎ°ú ÏãúÏûëÌïòÎäî Í≤ΩÏö∞ÏóêÎßå Ïã§Ìñâ
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/preview')

    outputs:
      should_run: ${{ steps.parse.outputs.should_run }}
      targets: ${{ steps.parse.outputs.targets }}
      pr_number: ${{ github.event.issue.number }}
      pr_head_ref: ${{ steps.pr.outputs.head_ref }}
      pr_head_sha: ${{ steps.pr.outputs.head_sha }}
      comment_id: ${{ github.event.comment.id }}

    steps:
      - name: Add Reaction to Comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api "repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions" \
            -X POST \
            -f content="eyes"

      - name: Get PR Info
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_DATA=$(gh api "repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}")
          HEAD_REF=$(echo "$PR_DATA" | jq -r '.head.ref')
          HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')

          echo "head_ref=${HEAD_REF}" >> $GITHUB_OUTPUT
          echo "head_sha=${HEAD_SHA}" >> $GITHUB_OUTPUT
          echo "PR branch: ${HEAD_REF}, SHA: ${HEAD_SHA}"

      - name: Parse Preview Command
        id: parse
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          echo "Comment: ${COMMENT_BODY}"

          # /preview Îã§ÏùåÏùò Ïù∏ÏûêÎì§ Ï∂îÏ∂ú
          ARGS=$(echo "$COMMENT_BODY" | sed 's|^/preview||' | xargs)
          echo "Args: ${ARGS}"

          # Í∏∞Î≥∏Í∞í: macOS + Unity 6000.2 (Îπ†Î•∏ ÌîÑÎ¶¨Î∑∞)
          if [ -z "$ARGS" ]; then
            TARGETS='[{"os":"macos","unity-version":"6000.2"}]'
            echo "Using default: macOS + Unity 6000.2"
          else
            # Ïù∏Ïûê ÌååÏã±: macos-6000.3 windows-2021.3 ÌòïÏãù
            TARGETS="["
            FIRST=true
            for ARG in $ARGS; do
              # os-version ÌòïÏãù ÌååÏã±
              OS=$(echo "$ARG" | cut -d'-' -f1)
              VERSION=$(echo "$ARG" | cut -d'-' -f2-)

              # OS Í≤ÄÏ¶ù
              if [ "$OS" != "macos" ] && [ "$OS" != "windows" ]; then
                echo "::warning::Invalid OS: ${OS}, skipping"
                continue
              fi

              # Î≤ÑÏ†Ñ Í≤ÄÏ¶ù (2021.3, 2022.3, 6000.0, 6000.2, 6000.3)
              if ! echo "$VERSION" | grep -qE '^(2021\.3|2022\.3|6000\.0|6000\.2|6000\.3)$'; then
                echo "::warning::Invalid Unity version: ${VERSION}, skipping"
                continue
              fi

              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                TARGETS="${TARGETS},"
              fi
              TARGETS="${TARGETS}{\"os\":\"${OS}\",\"unity-version\":\"${VERSION}\"}"
            done
            TARGETS="${TARGETS}]"
          fi

          echo "Parsed targets: ${TARGETS}"

          # Ïú†Ìö®Ìïú ÌÉÄÍ≤üÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
          TARGET_COUNT=$(echo "$TARGETS" | jq 'length')
          if [ "$TARGET_COUNT" -eq 0 ]; then
            echo "::error::No valid build targets found"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "targets=${TARGETS}" >> $GITHUB_OUTPUT

      - name: Post Starting Comment
        if: steps.parse.outputs.should_run == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TARGETS='${{ steps.parse.outputs.targets }}'
          PR_NUMBER="${{ github.event.issue.number }}"

          # ÌÉÄÍ≤ü Î™©Î°ùÏùÑ ÏùΩÍ∏∞ Ï¢ãÏùÄ ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
          TARGET_LIST=$(echo "$TARGETS" | jq -r '.[] | "- \(.os) / Unity \(.["unity-version"])"')

          COMMENT_BODY=$(cat <<EOF
          ## üöÄ Preview Build Started

          **Build targets:**
          ${TARGET_LIST}

          **PR:** #${PR_NUMBER}
          **Commit:** \`${{ steps.pr.outputs.head_sha }}\`
          **Workflow:** [View Progress](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          _Building... This may take 10-30 minutes._
          EOF
          )

          gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            -X POST \
            -f body="$COMMENT_BODY"

  # =====================================================
  # ÎπåÎìú Îß§Ìä∏Î¶≠Ïä§ ÏÉùÏÑ±
  # =====================================================
  build:
    name: Build (${{ matrix.target.os }}, Unity ${{ matrix.target.unity-version }})
    needs: parse-command
    if: needs.parse-command.outputs.should_run == 'true'

    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJson(needs.parse-command.outputs.targets) }}

    uses: ./.github/workflows/unity-build.yml
    with:
      ref: ${{ needs.parse-command.outputs.pr_head_ref }}
      os: ${{ matrix.target.os }}
      unity-version: ${{ matrix.target.unity-version }}
      run-build: true
      run-e2e-test: false
      run-benchmark: false

  # =====================================================
  # Î∞∞Ìè¨ Î∞è PR ÏΩîÎ©òÌä∏
  # =====================================================
  deploy:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: [parse-command, build]
    if: success()

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install AIT CLI
        run: |
          pnpm install -g @apps-in-toss/web-framework
          ait --version || echo "AIT CLI installed"

      - name: Download Build Artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: ait-build-*
          path: ait-builds/

      - name: List Downloaded Artifacts
        run: |
          echo "=== Downloaded Artifacts ==="
          ls -la ait-builds/ || echo "No artifacts found"
          for dir in ait-builds/*/; do
            echo "--- ${dir} ---"
            ls -la "$dir" 2>/dev/null || true
          done

      - name: Deploy All Builds
        id: deploy
        env:
          AIT_DEPLOY_KEY: ${{ secrets.AIT_DEPLOY_KEY }}
        run: |
          if [ -z "$AIT_DEPLOY_KEY" ]; then
            echo "::error::AIT_DEPLOY_KEY is not set"
            exit 1
          fi

          DEPLOY_RESULTS=""
          HAS_SUCCESS=false

          for build_dir in ait-builds/ait-build-*/; do
            if [ -d "$build_dir" ]; then
              BUILD_NAME=$(basename "$build_dir")
              OS=$(echo "$BUILD_NAME" | sed 's/ait-build-\([^-]*\)-.*/\1/')
              UNITY_VERSION=$(echo "$BUILD_NAME" | sed 's/ait-build-[^-]*-//')

              case "$OS" in
                macos) OS_DISPLAY="macOS" ;;
                windows) OS_DISPLAY="Windows" ;;
                *) OS_DISPLAY="$OS" ;;
              esac

              echo ""
              echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
              echo "Deploying: ${OS_DISPLAY} - Unity ${UNITY_VERSION}"

              DEPLOY_OUTPUT=$(cd "${build_dir}" && timeout 300 ait deploy --api-key "$AIT_DEPLOY_KEY" 2>&1) && DEPLOY_STATUS=0 || DEPLOY_STATUS=$?

              echo "$DEPLOY_OUTPUT"

              if [ $DEPLOY_STATUS -eq 0 ]; then
                # URL Ï∂îÏ∂ú (ANSI Ïù¥Ïä§ÏºÄÏù¥ÌîÑ ÏãúÌÄÄÏä§ Ï†úÍ±∞)
                CLEANED_OUTPUT=$(echo "$DEPLOY_OUTPUT" | sed 's/\x1b\[[0-9;]*m//g' | tr -d '\r')
                DEPLOY_URL=$(echo "$CLEANED_OUTPUT" | grep -oE 'intoss-private://[^[:space:]]+' | head -1 || true)

                if [ -n "$DEPLOY_URL" ]; then
                  echo "‚úÖ Deploy success: ${DEPLOY_URL}"
                  DEPLOY_RESULTS="${DEPLOY_RESULTS}| ${OS_DISPLAY} | ${UNITY_VERSION} | ‚úÖ | \`${DEPLOY_URL}\` |\n"
                  HAS_SUCCESS=true
                else
                  # intoss-private URLÏù¥ ÏóÜÏúºÎ©¥ Îã§Î•∏ URL ÏãúÎèÑ
                  DEPLOY_URL=$(echo "$CLEANED_OUTPUT" | grep -oE 'https?://[^[:space:]]+' | head -1 || echo "SUCCESS")
                  DEPLOY_RESULTS="${DEPLOY_RESULTS}| ${OS_DISPLAY} | ${UNITY_VERSION} | ‚úÖ | ${DEPLOY_URL} |\n"
                  HAS_SUCCESS=true
                fi
              else
                echo "‚ùå Deploy failed (exit code: $DEPLOY_STATUS)"
                DEPLOY_RESULTS="${DEPLOY_RESULTS}| ${OS_DISPLAY} | ${UNITY_VERSION} | ‚ùå | Failed |\n"
              fi
            fi
          done

          # Í≤∞Í≥º Ï†ÄÏû•
          echo "deploy_results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DEPLOY_RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ "$HAS_SUCCESS" = true ]; then
            echo "has_success=true" >> $GITHUB_OUTPUT
          else
            echo "has_success=false" >> $GITHUB_OUTPUT
          fi

      - name: Post Deploy Results to PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ needs.parse-command.outputs.pr_number }}"
          DEPLOY_RESULTS='${{ steps.deploy.outputs.deploy_results }}'
          HEAD_SHA="${{ needs.parse-command.outputs.pr_head_sha }}"

          COMMENT_BODY=$(cat <<EOF
          ## üéâ Preview Deploy Complete

          **Commit:** \`${HEAD_SHA}\`

          | OS | Unity | Status | URL |
          |----|-------|--------|-----|
          $(echo -e "$DEPLOY_RESULTS")

          ---
          <details>
          <summary>üì± How to test</summary>

          1. Copy the \`intoss-private://\` URL above
          2. Open Toss app on your device
          3. Paste the URL in browser or use deep link

          </details>

          _Triggered by /preview command_
          EOF
          )

          gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            -X POST \
            -f body="$COMMENT_BODY"

      - name: Add Success Reaction
        if: steps.deploy.outputs.has_success == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api "repos/${{ github.repository }}/issues/comments/${{ needs.parse-command.outputs.comment_id }}/reactions" \
            -X POST \
            -f content="rocket"

  # =====================================================
  # Ïã§Ìå® Ïãú ÏïåÎ¶º
  # =====================================================
  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [parse-command, build, deploy]
    if: failure()

    steps:
      - name: Post Failure Comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ needs.parse-command.outputs.pr_number }}"

          if [ -z "$PR_NUMBER" ]; then
            echo "::warning::PR number not available, skipping failure comment"
            exit 0
          fi

          COMMENT_BODY=$(cat <<EOF
          ## ‚ùå Preview Deploy Failed

          The preview build or deployment failed. Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          _Triggered by /preview command_
          EOF
          )

          gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            -X POST \
            -f body="$COMMENT_BODY"

      - name: Add Failure Reaction
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          COMMENT_ID="${{ needs.parse-command.outputs.comment_id }}"
          if [ -n "$COMMENT_ID" ]; then
            gh api "repos/${{ github.repository }}/issues/comments/${COMMENT_ID}/reactions" \
              -X POST \
              -f content="-1"
          fi
