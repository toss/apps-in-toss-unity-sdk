name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: '릴리즈 버전 (예: 1.6.0) - 필수'
        required: true
        type: string

jobs:
  # =====================================================
  # 버전 결정
  # =====================================================
  release:
    name: 버전 결정
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.version.outputs.tag_name }}

    steps:
      - name: 버전 결정
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "입력된 버전: ${VERSION}"

          # Semver 형식 검증
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z][a-zA-Z0-9.]*)?$'; then
            echo "::error::올바른 버전 형식이 아닙니다: ${VERSION}"
            exit 1
          fi

          echo "버전 검증 통과: ${VERSION}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag_name=release/v${VERSION}" >> $GITHUB_OUTPUT

  # =====================================================
  # SDK Runtime 재생성 (Orphan Commit)
  # main branch를 건드리지 않고 orphan commit 생성
  # =====================================================
  regenerate-sdk:
    name: SDK Runtime 재생성
    runs-on: ubuntu-latest
    needs: release

    outputs:
      ref: ${{ steps.commit.outputs.ref }}
      sha: ${{ steps.commit.outputs.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: web-framework 버전 업데이트 및 SDK 재생성
        working-directory: sdk-runtime-generator~
        run: |
          VERSION="${{ needs.release.outputs.version }}"

          echo "=== web-framework v${VERSION} 업데이트 ==="

          # 캐시 정리 후 강제 업데이트 (캐시로 인한 오래된 버전 문제 방지)
          pnpm store prune
          pnpm update "@apps-in-toss/web-framework@${VERSION}" --force --registry https://registry.npmjs.org

          # 설치된 버전 검증
          INSTALLED_VERSION=$(pnpm list @apps-in-toss/web-framework --json | jq -r '.[0].dependencies["@apps-in-toss/web-framework"].version')
          echo "요청 버전: ${VERSION}"
          echo "설치된 버전: ${INSTALLED_VERSION}"
          if [ "$INSTALLED_VERSION" != "$VERSION" ]; then
            echo "::error::버전 불일치! 요청: ${VERSION}, 설치됨: ${INSTALLED_VERSION}"
            exit 1
          fi
          echo "✅ 버전 검증 완료: ${INSTALLED_VERSION}"

          echo "SDK 코드 생성 중..."
          pnpm generate

          echo "SDK 코드 생성 완료"

      - name: 루트 package.json 버전 업데이트
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          jq --arg v "$VERSION" '.version = $v' package.json > tmp.json
          mv tmp.json package.json
          echo "package.json 버전: ${VERSION}"

      - name: Git 설정
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Orphan Commit 생성 및 Push
        id: commit
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          # refs/heads/ 경로 사용 (refs/builds/는 GitHub GC에 의해 삭제될 수 있음)
          BUILD_REF="refs/heads/_build/release-v${VERSION}"

          echo "=== Orphan Commit 생성 ==="

          # 모든 변경사항을 staging에 추가
          git add -A

          # Orphan commit 생성 (부모 없는 커밋)
          TREE=$(git write-tree)
          COMMIT=$(git commit-tree "$TREE" -m "빌드: SDK v${VERSION} 재생성

          - @apps-in-toss/web-framework v${VERSION} 기반 SDK 코드 재생성
          - package.json 버전 동기화

          Generated at: $(date -u +%Y-%m-%dT%H:%M:%SZ)")

          echo "Orphan commit SHA: ${COMMIT}"

          # 임시 ref로 push (main은 건드리지 않음)
          git push origin "${COMMIT}:${BUILD_REF}" --force

          echo "ref=${BUILD_REF}" >> $GITHUB_OUTPUT
          echo "sha=${COMMIT}" >> $GITHUB_OUTPUT
          echo "Orphan commit push 완료: ${BUILD_REF}"

  # =====================================================
  # AIT 빌드 - macOS
  # =====================================================
  build-ait-macos:
    name: AIT 빌드 (macOS)
    needs: [release, regenerate-sdk]
    strategy:
      fail-fast: false
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2", "6000.3"]

    uses: ./.github/workflows/unity-build.yml
    with:
      ref: ${{ needs.regenerate-sdk.outputs.ref }}
      os: macos
      unity-version: ${{ matrix.unity-version }}
      web-framework-version: ${{ needs.release.outputs.version }}
      run-build: true
      run-e2e-test: false
      run-benchmark: false
    secrets:
      AIT_AD_INTERSTITIAL_ID: ${{ secrets.AIT_AD_INTERSTITIAL_ID }}
      AIT_AD_REWARDED_ID: ${{ secrets.AIT_AD_REWARDED_ID }}

  # =====================================================
  # AIT 빌드 - Windows
  # =====================================================
  build-ait-windows:
    name: AIT 빌드 (Windows)
    needs: [release, regenerate-sdk]
    strategy:
      fail-fast: false
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2", "6000.3"]

    uses: ./.github/workflows/unity-build.yml
    with:
      ref: ${{ needs.regenerate-sdk.outputs.ref }}
      os: windows
      unity-version: ${{ matrix.unity-version }}
      web-framework-version: ${{ needs.release.outputs.version }}
      run-build: true
      run-e2e-test: false
      run-benchmark: false
    secrets:
      AIT_AD_INTERSTITIAL_ID: ${{ secrets.AIT_AD_INTERSTITIAL_ID }}
      AIT_AD_REWARDED_ID: ${{ secrets.AIT_AD_REWARDED_ID }}

  # =====================================================
  # 릴리즈 태그 생성 (UPM 패키지 정리 포함)
  # AIT 빌드 성공 후에만 실행 → 빌드 실패 시 릴리즈 방지
  # main branch는 건드리지 않고 orphan commit에서 태그 생성
  # =====================================================
  create-release-tag:
    name: 릴리즈 태그 생성
    runs-on: ubuntu-latest
    needs: [release, regenerate-sdk, build-ait-macos, build-ait-windows]
    if: success()

    steps:
      - name: Checkout (Orphan Ref)
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.regenerate-sdk.outputs.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: UPM 패키지 정리
        run: |
          echo "=== UPM 패키지 정리 ==="

          # 불필요한 디렉토리 제거 (~ 접미사 디렉토리는 Unity가 무시하므로 .meta 없음)
          rm -rf .github/
          rm -rf Tests~/
          rm -rf Tools~/
          rm -rf sdk-runtime-generator~/
          rm -rf scripts~/

          # 불필요한 파일 제거
          rm -f .gitignore
          rm -f .mcp.json
          rm -f CLAUDE.md
          rm -f run-local-tests.sh

          # 해당 .meta 파일도 제거
          rm -f .gitignore.meta
          rm -f .mcp.json.meta
          rm -f CLAUDE.md.meta
          rm -f run-local-tests.sh.meta

          echo "정리된 파일 목록:"
          ls -la
          echo ""
          echo "Runtime/ 내용:"
          ls -la Runtime/ || true
          echo ""
          echo "Editor/ 내용:"
          ls -la Editor/ || true

      - name: Git 설정
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: 릴리즈 태그 생성 (Orphan Commit)
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          TAG_NAME="${{ needs.release.outputs.tag_name }}"
          BUILD_REF="${{ needs.regenerate-sdk.outputs.ref }}"

          echo "=== 릴리즈 태그 생성: ${TAG_NAME} ==="

          # 정리된 상태로 새 orphan commit 생성
          git add -A
          TREE=$(git write-tree)
          RELEASE_COMMIT=$(git commit-tree "$TREE" -m "릴리즈: v${VERSION} (UPM 패키지)

          Apps in Toss Unity SDK v${VERSION}
          - @apps-in-toss/web-framework v${VERSION} 기반
          - UPM 패키지용 정리된 릴리즈
          - 개발/테스트 파일 제외

          Generated at: $(date -u +%Y-%m-%dT%H:%M:%SZ)")

          echo "릴리즈 commit SHA: ${RELEASE_COMMIT}"

          # 기존 태그가 있으면 삭제 (upsert)
          git push origin --delete "${TAG_NAME}" 2>/dev/null || true

          # 태그 생성 및 푸시
          git tag -f "${TAG_NAME}" "${RELEASE_COMMIT}" -m "릴리즈: v${VERSION}

          Apps in Toss Unity SDK v${VERSION}
          - @apps-in-toss/web-framework v${VERSION} 기반

          Generated at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

          git push -f origin "refs/tags/${TAG_NAME}:refs/tags/${TAG_NAME}"
          echo "태그 푸시 완료: ${TAG_NAME}"

          # 임시 빌드 ref 정리
          git push origin --delete "${BUILD_REF}" 2>/dev/null || echo "빌드 ref 정리 스킵 (이미 없거나 권한 없음)"

      - name: GitHub Release 생성/업데이트
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          TAG_NAME="${{ needs.release.outputs.tag_name }}"

          RELEASE_BODY=$(cat <<EOF
          ## Apps in Toss Unity SDK v${VERSION}

          \`@apps-in-toss/web-framework\` v${VERSION} 기반으로 생성된 Unity SDK입니다.

          ### 설치 방법

          \`Packages/manifest.json\`에 다음을 추가하세요:

          \`\`\`json
          {
            "dependencies": {
              "im.toss.apps-in-toss-unity-sdk": "https://github.com/${{ github.repository }}.git#${TAG_NAME}"
            }
          }
          \`\`\`

          ### 지원 Unity 버전

          | 버전 | 상태 |
          |------|------|
          | Unity 6000.3 (Unity 6.3) | ✅ 지원 |
          | Unity 6000.2 (Unity 6 LTS) | ✅ 지원 |
          | Unity 6000.0 (Unity 6) | ✅ 지원 |
          | Unity 2022.3 LTS | ✅ 지원 |
          | Unity 2021.3 LTS | ✅ 지원 (최소 버전) |

          ### 주요 기능

          - Apps in Toss 플랫폼에 최적화된 WebGL 빌드 자동화
          - 커스텀 Build & Deploy 윈도우를 통한 Unity Editor 통합
          - 플랫폼별 브릿지 코드가 포함된 커스텀 WebGL 템플릿 (AITTemplate)
          - granite 빌드 시스템을 사용한 Vite 기반 빌드 파이프라인
          - 플랫폼 기능을 위한 종합 C# API (결제, 사용자 인증, 기기 API 등)

          ### 문서

          - [Unity Editor 설정](https://github.com/${{ github.repository }}#readme)
          EOF
          )

          # 기존 릴리즈가 있으면 삭제 (upsert) - 태그는 유지 (이미 푸시됨)
          gh release delete "${TAG_NAME}" --yes 2>/dev/null || true

          # 태그 기반으로 릴리즈 생성 (태그가 이미 올바른 커밋을 가리킴)
          gh release create "${TAG_NAME}" \
            --title "v${VERSION}" \
            --notes "$RELEASE_BODY"

          echo "GitHub Release 생성 완료"
          echo "URL: https://github.com/${{ github.repository }}/releases/tag/${TAG_NAME}"

      - name: 릴리즈 요약
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          TAG_NAME="${{ needs.release.outputs.tag_name }}"

          echo "## 릴리즈 완료" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 항목 | 값 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| 버전 | v${VERSION} |" >> $GITHUB_STEP_SUMMARY
          echo "| 태그 | \`${TAG_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 릴리즈 | [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${TAG_NAME}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### UPM 설치" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}.git#${TAG_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    outputs:
      version: ${{ needs.release.outputs.version }}
      tag_name: ${{ needs.release.outputs.tag_name }}

  # =====================================================
  # AIT 패키지 배포
  # =====================================================
  deploy-ait:
    name: AIT 패키지 배포
    runs-on: ubuntu-latest
    needs: [build-ait-macos, build-ait-windows, create-release-tag]
    if: success()
    timeout-minutes: 30

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install AIT CLI
        run: |
          pnpm install -g @apps-in-toss/web-framework
          ait --version || echo "AIT CLI installed"

      - name: AIT 빌드 결과물 다운로드
        uses: actions/download-artifact@v7
        with:
          pattern: ait-build-*
          path: ait-builds/

      - name: 다운로드된 빌드 확인
        id: check-packages
        run: |
          echo "=== 다운로드된 AIT 빌드 결과물 ==="
          if [ -d "ait-builds" ]; then
            echo "빌드 목록:"
            ls -la ait-builds/
            echo ""

            BUILD_COUNT=0
            for build_dir in ait-builds/ait-build-*/; do
              if [ -d "$build_dir" ]; then
                echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
                echo "빌드: $(basename $build_dir)"
                ls -la "$build_dir"
                if [ -d "${build_dir}dist" ]; then
                  echo "dist/ 폴더:"
                  ls -la "${build_dir}dist" | head -10
                  BUILD_COUNT=$((BUILD_COUNT + 1))
                fi
              fi
            done

            echo "package_count=${BUILD_COUNT}" >> $GITHUB_OUTPUT

            if [ "$BUILD_COUNT" -gt 0 ]; then
              echo "✅ ${BUILD_COUNT}개 AIT 빌드 발견"
            else
              echo "::warning::유효한 AIT 빌드가 없습니다"
            fi
          else
            echo "::warning::ait-builds 디렉토리가 없습니다"
            echo "package_count=0" >> $GITHUB_OUTPUT
          fi

      - name: AIT 빌드 배포
        id: deploy
        if: steps.check-packages.outputs.package_count > 0
        env:
          AIT_DEPLOY_KEY: ${{ secrets.AIT_DEPLOY_KEY }}
        run: |
          VERSION="${{ needs.create-release-tag.outputs.version }}"

          echo "=== AIT 빌드 배포 ==="
          echo "버전: ${VERSION}"
          echo ""

          if [ -z "$AIT_DEPLOY_KEY" ]; then
            echo "::error::AIT_DEPLOY_KEY가 설정되지 않았습니다."
            echo "deploy_results=" >> $GITHUB_OUTPUT
            exit 1
          fi

          # 배포 결과 저장용 변수
          DEPLOY_RESULTS=""
          HAS_FAILURE=false

          for build_dir in ait-builds/ait-build-*/; do
            if [ -d "$build_dir" ]; then
              BUILD_NAME=$(basename "$build_dir")
              # ait-build-{os}-{unity-version} 형식에서 OS와 버전 추출
              OS=$(echo "$BUILD_NAME" | sed 's/ait-build-\([^-]*\)-.*/\1/')
              UNITY_VERSION=$(echo "$BUILD_NAME" | sed 's/ait-build-[^-]*-//')

              # OS 이름 정규화
              case "$OS" in
                macos) OS_DISPLAY="macOS" ;;
                windows) OS_DISPLAY="Windows" ;;
                *) OS_DISPLAY="$OS" ;;
              esac

              echo ""
              echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
              echo "배포: ${OS_DISPLAY} - Unity ${UNITY_VERSION}"
              echo "경로: ${build_dir}"

              # ait deploy는 현재 디렉토리에서 실행되어야 함
              # dist/ 폴더 안에서 실행
              if [ -d "${build_dir}" ]; then
                echo "배포 디렉토리: ${build_dir}"

                # ait deploy 실행 (작업 디렉토리를 build_dir로 변경)
                # 5분(300초) 타임아웃 설정 - 배포 서버 응답 대기
                DEPLOY_OUTPUT=$(cd "${build_dir}" && timeout 300 ait deploy --api-key "$AIT_DEPLOY_KEY" 2>&1) && DEPLOY_STATUS=0 || DEPLOY_STATUS=$?

                echo "$DEPLOY_OUTPUT"

                if [ $DEPLOY_STATUS -eq 124 ]; then
                  # timeout 명령어의 타임아웃 종료 코드
                  echo "❌ 배포 타임아웃 (5분 초과)"
                  DEPLOY_RESULTS="${DEPLOY_RESULTS}${OS_DISPLAY} - ${UNITY_VERSION}: TIMEOUT\n"
                  HAS_FAILURE=true
                elif [ $DEPLOY_STATUS -eq 0 ]; then
                  # 배포 성공 - URL 추출 시도 (ANSI 이스케이프 시퀀스 제거 후 파싱)
                  CLEANED_OUTPUT=$(echo "$DEPLOY_OUTPUT" | sed 's/\x1b\[[0-9;]*m//g' | tr -d '\r')
                  DEPLOY_URL=$(echo "$CLEANED_OUTPUT" | grep -oE 'intoss-private://[^[:space:]]+' | head -1 || true)
                  if [ -z "$DEPLOY_URL" ]; then
                    DEPLOY_URL=$(echo "$CLEANED_OUTPUT" | grep -oE 'https?://[^[:space:]]+' | head -1 || echo "SUCCESS")
                  fi
                  echo "✅ 배포 성공: ${DEPLOY_URL}"
                  DEPLOY_RESULTS="${DEPLOY_RESULTS}${OS_DISPLAY} - ${UNITY_VERSION}: ${DEPLOY_URL}\n"
                else
                  echo "❌ 배포 실패 (exit code: $DEPLOY_STATUS)"
                  DEPLOY_RESULTS="${DEPLOY_RESULTS}${OS_DISPLAY} - ${UNITY_VERSION}: FAILED\n"
                  HAS_FAILURE=true
                fi
              else
                echo "::warning::빌드 디렉토리가 없습니다: ${build_dir}"
                DEPLOY_RESULTS="${DEPLOY_RESULTS}${OS_DISPLAY} - ${UNITY_VERSION}: FAILED (no build dir)\n"
                HAS_FAILURE=true
              fi
            fi
          done

          # 결과 저장
          echo "deploy_results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DEPLOY_RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ "$HAS_FAILURE" = true ]; then
            echo "has_failure=true" >> $GITHUB_OUTPUT
          else
            echo "has_failure=false" >> $GITHUB_OUTPUT
          fi

          # Step Summary 작성
          echo "## AIT 배포 결과" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 플랫폼 | Unity 버전 | 상태 |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----------|------|" >> $GITHUB_STEP_SUMMARY

          echo -e "$DEPLOY_RESULTS" | while IFS= read -r line; do
            if [ -n "$line" ]; then
              PLATFORM=$(echo "$line" | cut -d: -f1 | xargs)
              STATUS=$(echo "$line" | cut -d: -f2- | xargs)
              if [[ "$STATUS" == *"FAILED"* ]]; then
                echo "| ${PLATFORM} | ❌ ${STATUS} |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| ${PLATFORM} | ✅ ${STATUS} |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: 배포 알림 전송
        if: always() && steps.check-packages.outputs.package_count > 0
        env:
          DEPLOY_WEBHOOK_URL: "https://ipd-public-gateway.core.toss-internal.com/api-public/v3/ipd-public-gateway/webhooks/ipd-corp-core-automation-webhook/8b6db539-6cb4-4b99-b2a8-8981c43b2592"
        run: |
          VERSION="${{ needs.create-release-tag.outputs.version }}"
          DEPLOY_RESULTS="${{ steps.deploy.outputs.deploy_results }}"

          if [ -z "$DEPLOY_RESULTS" ]; then
            DEPLOY_RESULTS="배포 결과 없음"
          fi

          echo "=== 배포 알림 전송 ==="
          echo "버전: ${VERSION}"
          echo "결과:"
          echo -e "$DEPLOY_RESULTS"

          # jq로 안전한 JSON 생성
          JSON_PAYLOAD=$(jq -n \
            --arg version "$VERSION" \
            --arg urls "$(echo -e "$DEPLOY_RESULTS")" \
            '{version: $version, urlsForEdition: $urls}')

          echo "전송할 JSON:"
          echo "$JSON_PAYLOAD"

          # HTTP 상태 코드 확인하여 실패 처리
          HTTP_STATUS=$(curl -s -o /tmp/webhook_response.txt -w "%{http_code}" -X POST "$DEPLOY_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")

          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "✅ 알림 전송 완료 (HTTP ${HTTP_STATUS})"
          else
            echo "::error::알림 전송 실패 (HTTP ${HTTP_STATUS})"
            cat /tmp/webhook_response.txt
            exit 1
          fi
