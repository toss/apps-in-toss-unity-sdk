name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ë¦´ë¦¬ì¦ˆ ë²„ì „ (ì˜ˆ: 1.6.0) - í•„ìˆ˜'
        required: true
        type: string

  # update/ ë¸Œëœì¹˜ê°€ mainì— ë¨¸ì§€ë˜ë©´ ìë™ ë¦´ë¦¬ì¦ˆ
  push:
    branches:
      - main
    paths:
      - 'package.json'

  # bulk-release.ymlì—ì„œ í˜¸ì¶œìš©
  workflow_call:
    inputs:
      version:
        description: 'ë¦´ë¦¬ì¦ˆ ë²„ì „'
        required: true
        type: string
      skip_notification:
        description: 'bulk-releaseì—ì„œ í˜¸ì¶œ ì‹œ ê°œë³„ ì•Œë¦¼ ìŠ¤í‚µ'
        required: false
        type: boolean
        default: false
    secrets:
      AIT_DEPLOY_KEY:
        required: true
      AIT_AD_INTERSTITIAL_ID:
        required: false
      AIT_AD_REWARDED_ID:
        required: false

jobs:
  # =====================================================
  # ë²„ì „ ê²°ì •
  # =====================================================
  release:
    name: ë²„ì „ ê²°ì •
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.version.outputs.tag_name }}
      skip: ${{ steps.version.outputs.skip }}

    steps:
      - name: Checkout (push ì´ë²¤íŠ¸ìš©)
        if: github.event_name == 'push'
        uses: actions/checkout@v6

      - name: ë²„ì „ ê²°ì •
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # push ì´ë²¤íŠ¸: package.jsonì—ì„œ ë²„ì „ ì½ê¸°
          # workflow_dispatch/workflow_call: inputsì—ì„œ ë²„ì „ ë°›ê¸°
          if [ "${{ github.event_name }}" = "push" ]; then
            VERSION=$(cat package.json | jq -r '.version')
            echo "package.jsonì—ì„œ ë²„ì „ ì½ê¸°: ${VERSION}"

            # ì´ë¯¸ ë¦´ë¦¬ì¦ˆ íƒœê·¸ê°€ ì¡´ì¬í•˜ë©´ ìŠ¤í‚µ
            TAG_NAME="release/v${VERSION}"
            if git ls-remote --tags origin | grep -q "refs/tags/${TAG_NAME}$"; then
              echo "ì´ë¯¸ ë¦´ë¦¬ì¦ˆ íƒœê·¸ê°€ ì¡´ì¬í•©ë‹ˆë‹¤: ${TAG_NAME}"
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "version=${VERSION}" >> $GITHUB_OUTPUT
              echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
              exit 0
            fi
          else
            VERSION="${{ inputs.version }}"
            echo "ì…ë ¥ëœ ë²„ì „: ${VERSION}"
          fi

          # Semver í˜•ì‹ ê²€ì¦
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z][a-zA-Z0-9.]*)?$'; then
            echo "::error::ì˜¬ë°”ë¥¸ ë²„ì „ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤: ${VERSION}"
            exit 1
          fi

          echo "ë²„ì „ ê²€ì¦ í†µê³¼: ${VERSION}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag_name=release/v${VERSION}" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

  # =====================================================
  # SDK Runtime ì¬ìƒì„± (Orphan Commit)
  # main branchë¥¼ ê±´ë“œë¦¬ì§€ ì•Šê³  orphan commit ìƒì„±
  # =====================================================
  regenerate-sdk:
    name: SDK Runtime ì¬ìƒì„±
    runs-on: ubuntu-latest
    needs: release
    if: needs.release.outputs.skip != 'true'

    outputs:
      ref: ${{ steps.commit.outputs.ref }}
      sha: ${{ steps.commit.outputs.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: web-framework ë²„ì „ ì—…ë°ì´íŠ¸ ë° SDK ì¬ìƒì„±
        working-directory: sdk-runtime-generator~
        run: |
          VERSION="${{ needs.release.outputs.version }}"

          echo "=== web-framework v${VERSION} ì—…ë°ì´íŠ¸ ==="

          # ìºì‹œ ì •ë¦¬ í›„ ê°•ì œ ì—…ë°ì´íŠ¸ (ìºì‹œë¡œ ì¸í•œ ì˜¤ë˜ëœ ë²„ì „ ë¬¸ì œ ë°©ì§€)
          pnpm store prune
          pnpm update "@apps-in-toss/web-framework@${VERSION}" --force --registry https://registry.npmjs.org

          # ì„¤ì¹˜ëœ ë²„ì „ ê²€ì¦
          INSTALLED_VERSION=$(pnpm list @apps-in-toss/web-framework --json | jq -r '.[0].dependencies["@apps-in-toss/web-framework"].version')
          echo "ìš”ì²­ ë²„ì „: ${VERSION}"
          echo "ì„¤ì¹˜ëœ ë²„ì „: ${INSTALLED_VERSION}"
          if [ "$INSTALLED_VERSION" != "$VERSION" ]; then
            echo "::error::ë²„ì „ ë¶ˆì¼ì¹˜! ìš”ì²­: ${VERSION}, ì„¤ì¹˜ë¨: ${INSTALLED_VERSION}"
            exit 1
          fi
          echo "âœ… ë²„ì „ ê²€ì¦ ì™„ë£Œ: ${INSTALLED_VERSION}"

          echo "SDK ì½”ë“œ ìƒì„± ì¤‘..."
          pnpm generate

          echo "SDK ì½”ë“œ ìƒì„± ì™„ë£Œ"

      - name: ë£¨íŠ¸ package.json ë²„ì „ ì—…ë°ì´íŠ¸
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          jq --arg v "$VERSION" '.version = $v' package.json > tmp.json
          mv tmp.json package.json
          echo "package.json ë²„ì „: ${VERSION}"

      - name: Git ì„¤ì •
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ë¦´ë¦¬ì¦ˆìš© í…ŒìŠ¤íŠ¸ ì½”ë“œ ì œì™¸
        run: |
          echo "=== ë¦´ë¦¬ì¦ˆ ë¹Œë“œìš© í…ŒìŠ¤íŠ¸ ì½”ë“œ ì œì™¸ ==="

          SHARED_RUNTIME="Tests~/E2E/SharedScripts/Runtime"

          # SharedScripts/Runtimeì˜ .cs íŒŒì¼ ì‚­ì œ (API í˜¸í™˜ì„± ë¬¸ì œê°€ ìˆëŠ” ì½”ë“œ)
          if [ -d "$SHARED_RUNTIME" ]; then
            echo "SharedScripts/Runtime .cs íŒŒì¼ ì‚­ì œ ì¤‘..."
            find "$SHARED_RUNTIME" -name "*.cs" -type f -delete
          fi

          # E2EBuildRunner.csê°€ ì˜ì¡´í•˜ëŠ” ìµœì†Œ ìŠ¤í… íŒŒì¼ ìƒì„±
          # E2EBootstrapperHelper.cs (E2EBuildRunnerì—ì„œ AddComponentë¡œ ì‚¬ìš©)
          cat > "${SHARED_RUNTIME}/E2EBootstrapperHelper.cs" << 'STUB_EOF'
          using UnityEngine;
          // ë¦´ë¦¬ì¦ˆ ë¹Œë“œìš© ìŠ¤í… - ì‹¤ì œ ê¸°ëŠ¥ ì—†ìŒ
          public class E2EBootstrapperHelper : MonoBehaviour
          {
              void Start() { }
          }
          STUB_EOF

          # E2EBootstrapper.cs (E2EBootstrapperHelperì—ì„œ í˜¸ì¶œ)
          cat > "${SHARED_RUNTIME}/E2EBootstrapper.cs" << 'STUB_EOF'
          using UnityEngine;
          // ë¦´ë¦¬ì¦ˆ ë¹Œë“œìš© ìŠ¤í… - ì‹¤ì œ ê¸°ëŠ¥ ì—†ìŒ
          public static class E2EBootstrapper
          {
              public static void Initialize() { }
          }
          STUB_EOF

          echo "ìŠ¤í… íŒŒì¼ ìƒì„± ì™„ë£Œ"
          echo ""
          echo "SharedScripts/Runtime ë‚´ìš©:"
          ls -la "$SHARED_RUNTIME"

          # Plugins í´ë” .cs íŒŒì¼ ì‚­ì œ
          SHARED_PLUGINS="Tests~/E2E/SharedScripts/Plugins"
          if [ -d "$SHARED_PLUGINS" ]; then
            find "$SHARED_PLUGINS" -name "*.cs" -type f -delete
          fi

          echo ""
          echo "SharedScripts Editor í´ë” í™•ì¸:"
          ls -la Tests~/E2E/SharedScripts/Editor/

      - name: Orphan Commit ìƒì„± ë° Push
        id: commit
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          # refs/heads/ ê²½ë¡œ ì‚¬ìš© (refs/builds/ëŠ” GitHub GCì— ì˜í•´ ì‚­ì œë  ìˆ˜ ìˆìŒ)
          BUILD_REF="refs/heads/_build/release-v${VERSION}"

          echo "=== Orphan Commit ìƒì„± ==="

          # ëª¨ë“  ë³€ê²½ì‚¬í•­ì„ stagingì— ì¶”ê°€
          git add -A

          # Orphan commit ìƒì„± (ë¶€ëª¨ ì—†ëŠ” ì»¤ë°‹)
          TREE=$(git write-tree)
          COMMIT=$(git commit-tree "$TREE" -m "ë¹Œë“œ: SDK v${VERSION} ì¬ìƒì„±

          - @apps-in-toss/web-framework v${VERSION} ê¸°ë°˜ SDK ì½”ë“œ ì¬ìƒì„±
          - package.json ë²„ì „ ë™ê¸°í™”

          Generated at: $(date -u +%Y-%m-%dT%H:%M:%SZ)")

          echo "Orphan commit SHA: ${COMMIT}"

          # ì„ì‹œ refë¡œ push (mainì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
          git push origin "${COMMIT}:${BUILD_REF}" --force

          echo "ref=${BUILD_REF}" >> $GITHUB_OUTPUT
          echo "sha=${COMMIT}" >> $GITHUB_OUTPUT
          echo "Orphan commit push ì™„ë£Œ: ${BUILD_REF}"

  # =====================================================
  # AIT ë¹Œë“œ - macOS
  # =====================================================
  build-ait-macos:
    name: AIT ë¹Œë“œ (macOS)
    needs: [release, regenerate-sdk]
    if: needs.release.outputs.skip != 'true'
    strategy:
      fail-fast: false
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2", "6000.3"]

    uses: ./.github/workflows/unity-build.yml
    with:
      ref: ${{ needs.regenerate-sdk.outputs.ref }}
      os: macos
      unity-version: ${{ matrix.unity-version }}
      web-framework-version: ${{ needs.release.outputs.version }}
      sdk-version: ${{ needs.release.outputs.version }}
      run-build: true
      run-e2e-test: false
      run-benchmark: false
    secrets:
      AIT_AD_INTERSTITIAL_ID: ${{ secrets.AIT_AD_INTERSTITIAL_ID }}
      AIT_AD_REWARDED_ID: ${{ secrets.AIT_AD_REWARDED_ID }}

  # =====================================================
  # AIT ë¹Œë“œ - Windows
  # =====================================================
  build-ait-windows:
    name: AIT ë¹Œë“œ (Windows)
    needs: [release, regenerate-sdk]
    if: needs.release.outputs.skip != 'true'
    strategy:
      fail-fast: false
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2", "6000.3"]

    uses: ./.github/workflows/unity-build.yml
    with:
      ref: ${{ needs.regenerate-sdk.outputs.ref }}
      os: windows
      unity-version: ${{ matrix.unity-version }}
      web-framework-version: ${{ needs.release.outputs.version }}
      sdk-version: ${{ needs.release.outputs.version }}
      run-build: true
      run-e2e-test: false
      run-benchmark: false
    secrets:
      AIT_AD_INTERSTITIAL_ID: ${{ secrets.AIT_AD_INTERSTITIAL_ID }}
      AIT_AD_REWARDED_ID: ${{ secrets.AIT_AD_REWARDED_ID }}

  # =====================================================
  # ë¦´ë¦¬ì¦ˆ íƒœê·¸ ìƒì„± (UPM íŒ¨í‚¤ì§€ ì •ë¦¬ í¬í•¨)
  # AIT ë¹Œë“œ ì„±ê³µ í›„ì—ë§Œ ì‹¤í–‰ â†’ ë¹Œë“œ ì‹¤íŒ¨ ì‹œ ë¦´ë¦¬ì¦ˆ ë°©ì§€
  # main branchëŠ” ê±´ë“œë¦¬ì§€ ì•Šê³  orphan commitì—ì„œ íƒœê·¸ ìƒì„±
  # =====================================================
  create-release-tag:
    name: ë¦´ë¦¬ì¦ˆ íƒœê·¸ ìƒì„±
    runs-on: ubuntu-latest
    needs: [release, regenerate-sdk, build-ait-macos, build-ait-windows]
    if: success()

    steps:
      - name: Checkout (Orphan Ref)
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.regenerate-sdk.outputs.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ë¦´ë¦¬ì¦ˆ ì •ë³´ ì£¼ì…
        id: release-info
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          RELEASE_DATETIME=$(date -u +"%Y%m%d_%H%M")
          COMMIT_HASH=$(git rev-parse --short=7 HEAD)
          FULL_COMMIT_HASH=$(git rev-parse HEAD)

          echo "=== ë¦´ë¦¬ì¦ˆ ì •ë³´ ì£¼ì… ==="
          echo "ë²„ì „: ${VERSION}"
          echo "ë¦´ë¦¬ì¦ˆ ì¼ì‹œ: ${RELEASE_DATETIME}"
          echo "ì»¤ë°‹ í•´ì‹œ: ${COMMIT_HASH}"

          # outputsë¡œ ë‚´ë³´ë‚´ê¸°
          echo "release_datetime=${RELEASE_DATETIME}" >> $GITHUB_OUTPUT
          echo "commit_hash=${COMMIT_HASH}" >> $GITHUB_OUTPUT
          echo "full_commit_hash=${FULL_COMMIT_HASH}" >> $GITHUB_OUTPUT

          # package.json description ì—…ë°ì´íŠ¸
          jq --arg dt "$RELEASE_DATETIME" --arg hash "$COMMIT_HASH" \
             '.description = "Apps in Toss Mini App Unity Engine Adapter SDK Package. (Released: " + $dt + ", " + $hash + ")"' \
             package.json > tmp.json && mv tmp.json package.json

          # AITVersionConstants.cs ì—…ë°ì´íŠ¸
          printf '%s\n' \
            '// Auto-generated during release' \
            'namespace AppsInToss' \
            '{' \
            '    internal static class AITVersionConstants' \
            '    {' \
            "        public const string Version = \"${VERSION}\";" \
            "        public const string ReleaseDateTime = \"${RELEASE_DATETIME}\";" \
            "        public const string CommitHash = \"${COMMIT_HASH}\";" \
            '    }' \
            '}' \
            > Runtime/Helpers/AITVersionConstants.cs

          echo "package.json description:"
          cat package.json | jq '.description'

      - name: UPM íŒ¨í‚¤ì§€ ì •ë¦¬
        run: |
          echo "=== UPM íŒ¨í‚¤ì§€ ì •ë¦¬ ==="

          # ë¶ˆí•„ìš”í•œ ë””ë ‰í† ë¦¬ ì œê±° (~ ì ‘ë¯¸ì‚¬ ë””ë ‰í† ë¦¬ëŠ” Unityê°€ ë¬´ì‹œí•˜ë¯€ë¡œ .meta ì—†ìŒ)
          rm -rf .github/
          rm -rf Tests~/
          rm -rf Tools~/
          rm -rf sdk-runtime-generator~/
          rm -rf scripts~/

          # ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œê±°
          rm -f .gitignore
          rm -f .mcp.json
          rm -f CLAUDE.md
          rm -f run-local-tests.sh

          # í•´ë‹¹ .meta íŒŒì¼ë„ ì œê±°
          rm -f .gitignore.meta
          rm -f .mcp.json.meta
          rm -f CLAUDE.md.meta
          rm -f run-local-tests.sh.meta

          echo "ì •ë¦¬ëœ íŒŒì¼ ëª©ë¡:"
          ls -la
          echo ""
          echo "Runtime/ ë‚´ìš©:"
          ls -la Runtime/ || true
          echo ""
          echo "Editor/ ë‚´ìš©:"
          ls -la Editor/ || true

      - name: Git ì„¤ì •
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ë¦´ë¦¬ì¦ˆ íƒœê·¸ ìƒì„± (Orphan Commit)
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          TAG_NAME="${{ needs.release.outputs.tag_name }}"
          BUILD_REF="${{ needs.regenerate-sdk.outputs.ref }}"

          echo "=== ë¦´ë¦¬ì¦ˆ íƒœê·¸ ìƒì„±: ${TAG_NAME} ==="

          # ì •ë¦¬ëœ ìƒíƒœë¡œ ìƒˆ orphan commit ìƒì„±
          git add -A
          TREE=$(git write-tree)
          RELEASE_COMMIT=$(git commit-tree "$TREE" -m "ë¦´ë¦¬ì¦ˆ: v${VERSION} (UPM íŒ¨í‚¤ì§€)

          Apps in Toss Unity SDK v${VERSION}
          - @apps-in-toss/web-framework v${VERSION} ê¸°ë°˜
          - UPM íŒ¨í‚¤ì§€ìš© ì •ë¦¬ëœ ë¦´ë¦¬ì¦ˆ
          - ê°œë°œ/í…ŒìŠ¤íŠ¸ íŒŒì¼ ì œì™¸

          Generated at: $(date -u +%Y-%m-%dT%H:%M:%SZ)")

          echo "ë¦´ë¦¬ì¦ˆ commit SHA: ${RELEASE_COMMIT}"

          # ê¸°ì¡´ íƒœê·¸ê°€ ìˆìœ¼ë©´ ì‚­ì œ (upsert)
          git push origin --delete "${TAG_NAME}" 2>/dev/null || true

          # íƒœê·¸ ìƒì„± ë° í‘¸ì‹œ
          git tag -f "${TAG_NAME}" "${RELEASE_COMMIT}" -m "ë¦´ë¦¬ì¦ˆ: v${VERSION}

          Apps in Toss Unity SDK v${VERSION}
          - @apps-in-toss/web-framework v${VERSION} ê¸°ë°˜

          Generated at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

          git push -f origin "refs/tags/${TAG_NAME}:refs/tags/${TAG_NAME}"
          echo "íƒœê·¸ í‘¸ì‹œ ì™„ë£Œ: ${TAG_NAME}"

          # ì„ì‹œ ë¹Œë“œ ref ì •ë¦¬
          git push origin --delete "${BUILD_REF}" 2>/dev/null || echo "ë¹Œë“œ ref ì •ë¦¬ ìŠ¤í‚µ (ì´ë¯¸ ì—†ê±°ë‚˜ ê¶Œí•œ ì—†ìŒ)"

      - name: GitHub Release ìƒì„±/ì—…ë°ì´íŠ¸
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          TAG_NAME="${{ needs.release.outputs.tag_name }}"
          RELEASE_DATETIME="${{ steps.release-info.outputs.release_datetime }}"
          COMMIT_HASH="${{ steps.release-info.outputs.commit_hash }}"
          FULL_COMMIT_HASH="${{ steps.release-info.outputs.full_commit_hash }}"

          RELEASE_BODY=$(cat <<EOF
          ## Apps in Toss Unity SDK v${VERSION}

          ğŸ“… **Released**: ${RELEASE_DATETIME} (UTC)
          ğŸ”— **Commit**: [\`${COMMIT_HASH}\`](https://github.com/${{ github.repository }}/commit/${FULL_COMMIT_HASH})

          \`@apps-in-toss/web-framework\` v${VERSION} ê¸°ë°˜ìœ¼ë¡œ ìƒì„±ëœ Unity SDKì…ë‹ˆë‹¤.

          ### ì„¤ì¹˜ ë°©ë²•

          \`Packages/manifest.json\`ì— ë‹¤ìŒì„ ì¶”ê°€í•˜ì„¸ìš”:

          \`\`\`json
          {
            "dependencies": {
              "im.toss.apps-in-toss-unity-sdk": "https://github.com/${{ github.repository }}.git#${TAG_NAME}"
            }
          }
          \`\`\`

          ### ì§€ì› Unity ë²„ì „

          | ë²„ì „ | ìƒíƒœ |
          |------|------|
          | Unity 6000.3 (Unity 6.3) | âœ… ì§€ì› |
          | Unity 6000.2 (Unity 6 LTS) | âœ… ì§€ì› |
          | Unity 6000.0 (Unity 6) | âœ… ì§€ì› |
          | Unity 2022.3 LTS | âœ… ì§€ì› |
          | Unity 2021.3 LTS | âœ… ì§€ì› (ìµœì†Œ ë²„ì „) |

          ### ì£¼ìš” ê¸°ëŠ¥

          - Apps in Toss í”Œë«í¼ì— ìµœì í™”ëœ WebGL ë¹Œë“œ ìë™í™”
          - ì»¤ìŠ¤í…€ Build & Deploy ìœˆë„ìš°ë¥¼ í†µí•œ Unity Editor í†µí•©
          - í”Œë«í¼ë³„ ë¸Œë¦¿ì§€ ì½”ë“œê°€ í¬í•¨ëœ ì»¤ìŠ¤í…€ WebGL í…œí”Œë¦¿ (AITTemplate)
          - granite ë¹Œë“œ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•œ Vite ê¸°ë°˜ ë¹Œë“œ íŒŒì´í”„ë¼ì¸
          - í”Œë«í¼ ê¸°ëŠ¥ì„ ìœ„í•œ ì¢…í•© C# API (ê²°ì œ, ì‚¬ìš©ì ì¸ì¦, ê¸°ê¸° API ë“±)

          ### ë¬¸ì„œ

          - [Unity Editor ì„¤ì •](https://github.com/${{ github.repository }}#readme)
          EOF
          )

          # ê¸°ì¡´ ë¦´ë¦¬ì¦ˆê°€ ìˆìœ¼ë©´ ì‚­ì œ (upsert) - íƒœê·¸ëŠ” ìœ ì§€ (ì´ë¯¸ í‘¸ì‹œë¨)
          gh release delete "${TAG_NAME}" --yes 2>/dev/null || true

          # íƒœê·¸ ì „íŒŒ ëŒ€ê¸° (GitHub API ë™ê¸°í™”)
          echo "íƒœê·¸ ì „íŒŒ ëŒ€ê¸° ì¤‘ (5ì´ˆ)..."
          sleep 5

          # íƒœê·¸ ê¸°ë°˜ìœ¼ë¡œ ë¦´ë¦¬ì¦ˆ ìƒì„± (--verify-tagë¡œ íƒœê·¸ í™•ì¸)
          gh release create "${TAG_NAME}" \
            --title "v${VERSION}" \
            --notes "$RELEASE_BODY" \
            --verify-tag

          echo "GitHub Release ìƒì„± ì™„ë£Œ"
          echo "URL: https://github.com/${{ github.repository }}/releases/tag/${TAG_NAME}"

      - name: ë¦´ë¦¬ì¦ˆ ìš”ì•½
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          TAG_NAME="${{ needs.release.outputs.tag_name }}"

          echo "## ë¦´ë¦¬ì¦ˆ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ë²„ì „ | v${VERSION} |" >> $GITHUB_STEP_SUMMARY
          echo "| íƒœê·¸ | \`${TAG_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¦´ë¦¬ì¦ˆ | [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${TAG_NAME}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### UPM ì„¤ì¹˜" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/${{ github.repository }}.git#${TAG_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    outputs:
      version: ${{ needs.release.outputs.version }}
      tag_name: ${{ needs.release.outputs.tag_name }}

  # =====================================================
  # AIT íŒ¨í‚¤ì§€ ë°°í¬
  # =====================================================
  deploy-ait:
    name: AIT íŒ¨í‚¤ì§€ ë°°í¬
    runs-on: ubuntu-latest
    needs: [build-ait-macos, build-ait-windows, create-release-tag]
    if: success()
    timeout-minutes: 30

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install AIT CLI
        run: |
          pnpm install -g @apps-in-toss/web-framework
          ait --version || echo "AIT CLI installed"

      - name: AIT ë¹Œë“œ ê²°ê³¼ë¬¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v7
        with:
          pattern: ait-build-*-v${{ needs.create-release-tag.outputs.version }}
          path: ait-builds/

      - name: ë‹¤ìš´ë¡œë“œëœ ë¹Œë“œ í™•ì¸
        id: check-packages
        run: |
          echo "=== ë‹¤ìš´ë¡œë“œëœ AIT ë¹Œë“œ ê²°ê³¼ë¬¼ ==="
          if [ -d "ait-builds" ]; then
            echo "ë¹Œë“œ ëª©ë¡:"
            ls -la ait-builds/
            echo ""

            BUILD_COUNT=0
            for build_dir in ait-builds/ait-build-*/; do
              if [ -d "$build_dir" ]; then
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ë¹Œë“œ: $(basename $build_dir)"
                ls -la "$build_dir"
                if [ -d "${build_dir}dist" ]; then
                  echo "dist/ í´ë”:"
                  ls -la "${build_dir}dist" | head -10
                  BUILD_COUNT=$((BUILD_COUNT + 1))
                fi
              fi
            done

            echo "package_count=${BUILD_COUNT}" >> $GITHUB_OUTPUT

            if [ "$BUILD_COUNT" -gt 0 ]; then
              echo "âœ… ${BUILD_COUNT}ê°œ AIT ë¹Œë“œ ë°œê²¬"
            else
              echo "::warning::ìœ íš¨í•œ AIT ë¹Œë“œê°€ ì—†ìŠµë‹ˆë‹¤"
            fi
          else
            echo "::warning::ait-builds ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
            echo "package_count=0" >> $GITHUB_OUTPUT
          fi

      - name: AIT ë¹Œë“œ ë°°í¬
        id: deploy
        if: steps.check-packages.outputs.package_count > 0
        env:
          AIT_DEPLOY_KEY: ${{ secrets.AIT_DEPLOY_KEY }}
        run: |
          VERSION="${{ needs.create-release-tag.outputs.version }}"

          echo "=== AIT ë¹Œë“œ ë°°í¬ ==="
          echo "ë²„ì „: ${VERSION}"
          echo ""

          if [ -z "$AIT_DEPLOY_KEY" ]; then
            echo "::error::AIT_DEPLOY_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "deploy_results=" >> $GITHUB_OUTPUT
            exit 1
          fi

          # ë°°í¬ ê²°ê³¼ ì €ì¥ìš© ë³€ìˆ˜
          DEPLOY_RESULTS=""
          HAS_FAILURE=false

          for build_dir in ait-builds/ait-build-*/; do
            if [ -d "$build_dir" ]; then
              BUILD_NAME=$(basename "$build_dir")
              # ait-build-{os}-{unity-version} í˜•ì‹ì—ì„œ OSì™€ ë²„ì „ ì¶”ì¶œ
              OS=$(echo "$BUILD_NAME" | sed 's/ait-build-\([^-]*\)-.*/\1/')
              UNITY_VERSION=$(echo "$BUILD_NAME" | sed 's/ait-build-[^-]*-//')

              # OS ì´ë¦„ ì •ê·œí™”
              case "$OS" in
                macos) OS_DISPLAY="macOS" ;;
                windows) OS_DISPLAY="Windows" ;;
                *) OS_DISPLAY="$OS" ;;
              esac

              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ë°°í¬: ${OS_DISPLAY} - Unity ${UNITY_VERSION}"
              echo "ê²½ë¡œ: ${build_dir}"

              # ait deployëŠ” í˜„ì¬ ë””ë ‰í† ë¦¬ì—ì„œ ì‹¤í–‰ë˜ì–´ì•¼ í•¨
              # dist/ í´ë” ì•ˆì—ì„œ ì‹¤í–‰
              if [ -d "${build_dir}" ]; then
                echo "ë°°í¬ ë””ë ‰í† ë¦¬: ${build_dir}"

                # ait deploy ì‹¤í–‰ (ì‘ì—… ë””ë ‰í† ë¦¬ë¥¼ build_dirë¡œ ë³€ê²½)
                # 5ë¶„(300ì´ˆ) íƒ€ì„ì•„ì›ƒ ì„¤ì • - ë°°í¬ ì„œë²„ ì‘ë‹µ ëŒ€ê¸°
                DEPLOY_OUTPUT=$(cd "${build_dir}" && timeout 300 ait deploy --api-key "$AIT_DEPLOY_KEY" 2>&1) && DEPLOY_STATUS=0 || DEPLOY_STATUS=$?

                echo "$DEPLOY_OUTPUT"

                if [ $DEPLOY_STATUS -eq 124 ]; then
                  # timeout ëª…ë ¹ì–´ì˜ íƒ€ì„ì•„ì›ƒ ì¢…ë£Œ ì½”ë“œ
                  echo "âŒ ë°°í¬ íƒ€ì„ì•„ì›ƒ (5ë¶„ ì´ˆê³¼)"
                  DEPLOY_RESULTS="${DEPLOY_RESULTS}${OS_DISPLAY} - ${UNITY_VERSION}: TIMEOUT\n"
                  HAS_FAILURE=true
                elif [ $DEPLOY_STATUS -eq 0 ]; then
                  # ë°°í¬ ì„±ê³µ - URL ì¶”ì¶œ ì‹œë„ (ANSI ì´ìŠ¤ì¼€ì´í”„ ì‹œí€€ìŠ¤ ì œê±° í›„ íŒŒì‹±)
                  CLEANED_OUTPUT=$(echo "$DEPLOY_OUTPUT" | sed 's/\x1b\[[0-9;]*m//g' | tr -d '\r')
                  DEPLOY_URL=$(echo "$CLEANED_OUTPUT" | grep -oE 'intoss-private://[^[:space:]]+' | head -1 || true)
                  if [ -z "$DEPLOY_URL" ]; then
                    DEPLOY_URL=$(echo "$CLEANED_OUTPUT" | grep -oE 'https?://[^[:space:]]+' | head -1 || echo "SUCCESS")
                  fi
                  echo "âœ… ë°°í¬ ì„±ê³µ: ${DEPLOY_URL}"
                  DEPLOY_RESULTS="${DEPLOY_RESULTS}${OS_DISPLAY} - ${UNITY_VERSION}: ${DEPLOY_URL}\n"
                else
                  echo "âŒ ë°°í¬ ì‹¤íŒ¨ (exit code: $DEPLOY_STATUS)"
                  DEPLOY_RESULTS="${DEPLOY_RESULTS}${OS_DISPLAY} - ${UNITY_VERSION}: FAILED\n"
                  HAS_FAILURE=true
                fi
              else
                echo "::warning::ë¹Œë“œ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤: ${build_dir}"
                DEPLOY_RESULTS="${DEPLOY_RESULTS}${OS_DISPLAY} - ${UNITY_VERSION}: FAILED (no build dir)\n"
                HAS_FAILURE=true
              fi
            fi
          done

          # ê²°ê³¼ ì €ì¥
          echo "deploy_results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DEPLOY_RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ "$HAS_FAILURE" = true ]; then
            echo "has_failure=true" >> $GITHUB_OUTPUT
          else
            echo "has_failure=false" >> $GITHUB_OUTPUT
          fi

          # Step Summary ì‘ì„±
          echo "## AIT ë°°í¬ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í”Œë«í¼ | Unity ë²„ì „ | ìƒíƒœ | URL | QR |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----------|------|-----|:--:|" >> $GITHUB_STEP_SUMMARY

          echo -e "$DEPLOY_RESULTS" | while IFS= read -r line; do
            if [ -n "$line" ]; then
              PLATFORM=$(echo "$line" | cut -d: -f1 | xargs)
              STATUS=$(echo "$line" | cut -d: -f2- | xargs)
              # PLATFORM í˜•ì‹: "macOS - 2021.3" â†’ OSì™€ Unity ë²„ì „ ë¶„ë¦¬
              OS_NAME=$(echo "$PLATFORM" | cut -d'-' -f1 | xargs)
              UV=$(echo "$PLATFORM" | cut -d'-' -f2- | xargs)
              if [[ "$STATUS" == *"FAILED"* ]] || [[ "$STATUS" == *"TIMEOUT"* ]]; then
                echo "| ${OS_NAME} | ${UV} | âŒ | ${STATUS} | - |" >> $GITHUB_STEP_SUMMARY
              elif echo "$STATUS" | grep -qE '^intoss-private://'; then
                ENCODED_URL=$(printf '%s' "$STATUS" | jq -sRr @uri)
                QR_IMG="![QR](https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${ENCODED_URL})"
                echo "| ${OS_NAME} | ${UV} | âœ… | \`${STATUS}\` | ${QR_IMG} |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| ${OS_NAME} | ${UV} | âœ… | ${STATUS} | - |" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: ë°°í¬ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì €ì¥
        if: always() && steps.check-packages.outputs.package_count > 0
        run: |
          VERSION="${{ needs.create-release-tag.outputs.version }}"
          DEPLOY_RESULTS="${{ steps.deploy.outputs.deploy_results }}"
          HAS_FAILURE="${{ steps.deploy.outputs.has_failure }}"

          echo "version=${VERSION}" > deploy-results.txt
          echo "has_failure=${HAS_FAILURE}" >> deploy-results.txt
          echo "---RESULTS---" >> deploy-results.txt
          echo -e "$DEPLOY_RESULTS" >> deploy-results.txt

          echo "ì €ì¥ëœ ë°°í¬ ê²°ê³¼:"
          cat deploy-results.txt

      - name: ë°°í¬ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        if: always() && steps.check-packages.outputs.package_count > 0
        uses: actions/upload-artifact@v6
        with:
          name: deploy-results-${{ needs.create-release-tag.outputs.version }}
          path: deploy-results.txt
          retention-days: 1

      - name: ë°°í¬ ì•Œë¦¼ ì „ì†¡
        if: always() && steps.check-packages.outputs.package_count > 0 && inputs.skip_notification != true
        env:
          DEPLOY_WEBHOOK_URL: "https://ipd-public-gateway.core.toss-internal.com/api-public/v3/ipd-public-gateway/webhooks/ipd-corp-core-automation-webhook/8b6db539-6cb4-4b99-b2a8-8981c43b2592"
        run: |
          VERSION="${{ needs.create-release-tag.outputs.version }}"
          DEPLOY_RESULTS="${{ steps.deploy.outputs.deploy_results }}"

          if [ -z "$DEPLOY_RESULTS" ]; then
            URLS_FOR_EDITION="ë°°í¬ ê²°ê³¼ ì—†ìŒ"
          else
            echo "=== markdown link í˜•ì‹ìœ¼ë¡œ ë³€í™˜ ==="
            URLS_FOR_EDITION=""
            while IFS= read -r line; do
              if [ -n "$line" ]; then
                # "macOS - 2021.3: URL" í˜•ì‹ì—ì„œ í”Œë«í¼ê³¼ URL ë¶„ë¦¬
                PLATFORM=$(echo "$line" | cut -d: -f1 | xargs)
                URL=$(echo "$line" | cut -d: -f2- | xargs)

                if [ -n "$URL" ] && [ "$URL" != "FAILED" ] && [ "$URL" != "TIMEOUT" ]; then
                  LINE="${PLATFORM}: <${URL}|${VERSION}>"
                else
                  LINE="${PLATFORM}: ${VERSION}(${URL})"
                fi

                if [ -n "$URLS_FOR_EDITION" ]; then
                  URLS_FOR_EDITION="${URLS_FOR_EDITION}\n${LINE}"
                else
                  URLS_FOR_EDITION="${LINE}"
                fi
              fi
            done <<< "$(echo -e "$DEPLOY_RESULTS")"
          fi

          ACTIONS_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          echo "=== ë°°í¬ ì•Œë¦¼ ì „ì†¡ ==="
          echo "ë²„ì „: ${VERSION}"
          echo "Actions URL: ${ACTIONS_URL}"
          echo "ê²°ê³¼:"
          echo -e "$URLS_FOR_EDITION"

          # 1ì¤„(1í”Œë«í¼)ë‹¹ 1í•„ë“œë¡œ ë¶„í• 
          # Slack section blockì—ì„œ ì—¬ëŸ¬ ë§í¬ê°€ í•œ í•„ë“œì— ìˆìœ¼ë©´ ë Œë”ë§ ë²„ê·¸ ë°œìƒí•˜ë¯€ë¡œ ë¶„ë¦¬
          LINE_INDEX=1
          while IFS= read -r line; do
            if [ -z "$line" ]; then continue; fi
            eval "LINE_${LINE_INDEX}=\"\${line}\""
            LINE_INDEX=$((LINE_INDEX + 1))
          done <<< "$(echo -e "$URLS_FOR_EDITION")"

          TOTAL_LINES=$((LINE_INDEX - 1))
          echo "ì´ ${TOTAL_LINES}ê°œ ì¤„(í”Œë«í¼)ë¡œ ë¶„í• "

          # jqë¡œ ì•ˆì „í•œ JSON ìƒì„±
          # urlsForEdition (ì²« ë²ˆì§¸), urlsForEdition2, ..., urlsForEditionN í•„ë“œë¡œ ì „ì†¡
          # lineCount í•„ë“œë¡œ ì´ ì¤„ ìˆ˜ ì „ë‹¬ (Slack í…œí”Œë¦¿ì—ì„œ ë°˜ë³µ ë²”ìœ„ë¡œ ì‚¬ìš©)
          JSON_PAYLOAD=$(jq -n \
            --arg version "$VERSION" \
            --arg urls "$LINE_1" \
            --arg actionsUrl "$ACTIONS_URL" \
            --argjson lineCount "$TOTAL_LINES" \
            '{version: $version, urlsForEdition: $urls, actionsUrl: $actionsUrl, lineCount: $lineCount}')

          for i in $(seq 2 $TOTAL_LINES); do
            [ "$i" -gt "$TOTAL_LINES" ] && break
            eval "LINE_VAL=\"\${LINE_${i}}\""
            JSON_PAYLOAD=$(echo "$JSON_PAYLOAD" | jq \
              --arg key "urlsForEdition${i}" \
              --arg val "$LINE_VAL" \
              '. + {($key): $val}')
          done

          echo "ì „ì†¡í•  JSON:"
          echo "$JSON_PAYLOAD"

          # HTTP ìƒíƒœ ì½”ë“œ í™•ì¸í•˜ì—¬ ì‹¤íŒ¨ ì²˜ë¦¬
          HTTP_STATUS=$(curl -s -o /tmp/webhook_response.txt -w "%{http_code}" -X POST "$DEPLOY_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")

          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "âœ… ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ (HTTP ${HTTP_STATUS})"
          else
            echo "::error::ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨ (HTTP ${HTTP_STATUS})"
            cat /tmp/webhook_response.txt
            exit 1
          fi
