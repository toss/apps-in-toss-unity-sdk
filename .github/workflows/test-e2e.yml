name: E2E Tests

on:
  # PR ì½”ë©˜íŠ¸ì—ì„œ /test-e2e ì»¤ë§¨ë“œë¡œ íŠ¸ë¦¬ê±°
  issue_comment:
    types: [created]

  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      clean_library:
        description: 'Clean Unity Library cache (for cache corruption issues)'
        type: boolean
        default: false

  # update.ymlì—ì„œ í˜¸ì¶œ
  workflow_call:
    inputs:
      clean_library:
        description: 'Clean Unity Library cache'
        type: boolean
        default: false
      ref:
        description: 'Git ref to checkout (branch name)'
        type: string
        required: false

permissions:
  contents: read
  pull-requests: write
  issues: write
  statuses: write

jobs:
  # =====================================================
  # ìŠ¬ëž˜ì‹œ ì»¤ë§¨ë“œ íŒŒì‹± (/test-e2e)
  # =====================================================
  parse-command:
    name: Parse Command
    runs-on: ubuntu-latest
    # PR ì½”ë©˜íŠ¸ì—ì„œ /test-e2eë¡œ ì‹œìž‘í•˜ëŠ” ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: |
      github.event_name != 'issue_comment' ||
      (github.event.issue.pull_request && startsWith(github.event.comment.body, '/test-e2e'))

    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      ref: ${{ steps.pr.outputs.head_ref }}
      pr_number: ${{ steps.pr.outputs.pr_number }}
      comment_id: ${{ github.event.comment.id }}

    steps:
      - name: Check Trigger Type
        id: check
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "Triggered by /test-e2e command"
          elif [ "${{ github.event_name }}" = "workflow_call" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "Triggered by workflow_call"
          else
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "Triggered by workflow_dispatch"
          fi

      - name: Add Reaction to Comment
        if: github.event_name == 'issue_comment'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api "repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions" \
            -X POST \
            -f content="eyes"

      - name: Get PR Info
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            PR_DATA=$(gh api "repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}")
            HEAD_REF=$(echo "$PR_DATA" | jq -r '.head.ref')
            echo "head_ref=${HEAD_REF}" >> $GITHUB_OUTPUT
            echo "pr_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "PR branch: ${HEAD_REF}"
          elif [ -n "${{ inputs.ref }}" ]; then
            echo "head_ref=${{ inputs.ref }}" >> $GITHUB_OUTPUT
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "Using provided ref: ${{ inputs.ref }}"
          else
            echo "head_ref=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "Using current ref: ${{ github.ref_name }}"
          fi

      - name: Post Starting Comment
        if: github.event_name == 'issue_comment'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.issue.number }}"

          COMMENT_BODY=$(cat <<'EOF'
          ## ðŸ§ª E2E Tests Started

          **Build targets:**
          - macOS: Unity 2021.3, 2022.3, 6000.0, 6000.2, 6000.3
          - Windows: Unity 2021.3, 2022.3, 6000.0, 6000.2, 6000.3

          **Workflow:** [View Progress](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          _Running E2E tests + benchmarks... This may take 30-60 minutes._
          EOF
          )

          gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            -X POST \
            -f body="$COMMENT_BODY"

  # =====================================================
  # Pending Status ë³´ê³  (í…ŒìŠ¤íŠ¸ ì‹œìž‘ ì‹œ)
  # =====================================================
  report-pending:
    name: Report Pending Status
    runs-on: ubuntu-latest
    needs: parse-command
    if: needs.parse-command.outputs.should_run == 'true' && needs.parse-command.outputs.ref != ''

    steps:
      - name: Get Commit SHA
        id: sha
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REF="${{ needs.parse-command.outputs.ref }}"
          SHA=$(gh api "repos/${{ github.repository }}/git/ref/heads/${REF}" --jq '.object.sha' 2>/dev/null || echo "")

          if [ -z "$SHA" ]; then
            echo "::warning::Could not get SHA for ref ${REF}"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "sha=${SHA}" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Report Pending Status
        if: steps.sha.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.sha.outputs.sha }}"
          TARGET_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          gh api "repos/${{ github.repository }}/statuses/${SHA}" \
            -X POST \
            -f state="pending" \
            -f target_url="$TARGET_URL" \
            -f description="E2E tests running..." \
            -f context="E2E Tests"

          echo "Reported pending status for commit $SHA"

  # =====================================================
  # E2E Tests - macOS (ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰)
  # =====================================================
  e2e-test-macos:
    name: E2E (macOS, Unity ${{ matrix.unity-version }})
    needs: parse-command
    if: needs.parse-command.outputs.should_run == 'true'

    strategy:
      fail-fast: false
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2", "6000.3"]

    uses: ./.github/workflows/unity-build.yml
    with:
      ref: ${{ needs.parse-command.outputs.ref || '' }}
      os: macos
      unity-version: ${{ matrix.unity-version }}
      run-build: true
      run-e2e-test: true
      run-benchmark: true
      clean-library: ${{ inputs.clean_library || false }}

  # =====================================================
  # E2E Tests - Windows (í…ŒìŠ¤íŠ¸ 1-5ë§Œ ì‹¤í–‰)
  # =====================================================
  e2e-test-windows:
    name: E2E 1-5 (Windows, Unity ${{ matrix.unity-version }})
    needs: parse-command
    if: needs.parse-command.outputs.should_run == 'true'

    strategy:
      fail-fast: false
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2", "6000.3"]

    uses: ./.github/workflows/unity-build.yml
    with:
      ref: ${{ needs.parse-command.outputs.ref || '' }}
      os: windows
      unity-version: ${{ matrix.unity-version }}
      run-build: true
      run-e2e-test: true
      run-benchmark: false
      clean-library: ${{ inputs.clean_library || false }}

  # =====================================================
  # Test Report Summary
  # =====================================================
  test-report:
    name: Test Report Summary
    runs-on: ubuntu-latest
    needs: [parse-command, e2e-test-macos, e2e-test-windows]
    if: always() && needs.parse-command.outputs.should_run == 'true'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Download All Artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: Generate Benchmark Report
        run: node .github/scripts/generate-benchmark-report.js

      - name: Write Job Summary
        run: cat benchmark-report.md >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: needs.parse-command.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ needs.parse-command.outputs.pr_number }}"
          REPORT=$(cat benchmark-report.md)

          # ê¸°ì¡´ ë²¤ì¹˜ë§ˆí¬ ì½”ë©˜íŠ¸ ì°¾ê¸°
          EXISTING_COMMENT=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '.[] | select(.user.type == "Bot" and (.body | contains("## ðŸ“Š Benchmark Results"))) | .id' \
            | head -1)

          if [ -n "$EXISTING_COMMENT" ]; then
            # ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
            gh api "repos/${{ github.repository }}/issues/comments/${EXISTING_COMMENT}" \
              -X PATCH \
              -f body="$REPORT"
            echo "Updated existing benchmark comment"
          else
            # ìƒˆ ì½”ë©˜íŠ¸ ìƒì„±
            gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
              -X POST \
              -f body="$REPORT"
            echo "Created new benchmark comment"
          fi

      - name: Upload Benchmark Report
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-report
          path: benchmark-report.md
          if-no-files-found: warn
          retention-days: 30

  # =====================================================
  # Commit Status ë³´ê³ 
  # =====================================================
  report-status:
    name: Report Status
    runs-on: ubuntu-latest
    needs: [parse-command, e2e-test-macos, e2e-test-windows]
    if: always() && needs.parse-command.outputs.should_run == 'true' && needs.parse-command.outputs.ref != ''

    steps:
      - name: Determine Status
        id: status
        run: |
          MACOS_RESULT="${{ needs.e2e-test-macos.result }}"
          WINDOWS_RESULT="${{ needs.e2e-test-windows.result }}"

          if [ "$MACOS_RESULT" = "success" ] && [ "$WINDOWS_RESULT" = "success" ]; then
            echo "state=success" >> $GITHUB_OUTPUT
            echo "description=All E2E tests passed (macOS:1-9, Windows:1-5)" >> $GITHUB_OUTPUT
          elif [ "$MACOS_RESULT" = "cancelled" ] || [ "$WINDOWS_RESULT" = "cancelled" ]; then
            echo "state=error" >> $GITHUB_OUTPUT
            echo "description=Tests cancelled" >> $GITHUB_OUTPUT
          else
            echo "state=failure" >> $GITHUB_OUTPUT
            echo "description=Tests failed (macOS: $MACOS_RESULT, Windows: $WINDOWS_RESULT)" >> $GITHUB_OUTPUT
          fi

      - name: Get Commit SHA
        id: sha
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REF="${{ needs.parse-command.outputs.ref }}"
          SHA=$(gh api "repos/${{ github.repository }}/git/ref/heads/${REF}" --jq '.object.sha' 2>/dev/null || echo "")

          if [ -z "$SHA" ]; then
            echo "::warning::Could not get SHA for ref ${REF}"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "sha=${SHA}" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Report Commit Status
        if: steps.sha.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.sha.outputs.sha }}"
          STATE="${{ steps.status.outputs.state }}"
          DESCRIPTION="${{ steps.status.outputs.description }}"
          TARGET_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          gh api "repos/${{ github.repository }}/statuses/${SHA}" \
            -X POST \
            -f state="$STATE" \
            -f target_url="$TARGET_URL" \
            -f description="$DESCRIPTION" \
            -f context="E2E Tests"

          echo "Reported status: $STATE for commit $SHA"

      - name: Add Reaction to Comment
        if: github.event_name == 'issue_comment' && steps.status.outputs.state == 'success'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          COMMENT_ID="${{ needs.parse-command.outputs.comment_id }}"
          if [ -n "$COMMENT_ID" ]; then
            gh api "repos/${{ github.repository }}/issues/comments/${COMMENT_ID}/reactions" \
              -X POST \
              -f content="rocket"
          fi

      - name: Add Failure Reaction
        if: github.event_name == 'issue_comment' && steps.status.outputs.state != 'success'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          COMMENT_ID="${{ needs.parse-command.outputs.comment_id }}"
          if [ -n "$COMMENT_ID" ]; then
            gh api "repos/${{ github.repository }}/issues/comments/${COMMENT_ID}/reactions" \
              -X POST \
              -f content="-1"
          fi
