name: E2E Tests

on:
  # 수동 실행
  workflow_dispatch:
    inputs:
      ref:
        description: '테스트할 브랜치 (비워두면 현재 브랜치)'
        type: string
        required: false
      clean_library:
        description: 'Clean Unity Library cache'
        type: boolean
        default: false

  # update.yml에서 호출
  workflow_call:
    inputs:
      ref:
        description: 'Git ref to checkout (branch name)'
        type: string
        required: false
      clean_library:
        description: 'Clean Unity Library cache'
        type: boolean
        default: false

jobs:
  # =====================================================
  # Ref 결정
  # =====================================================
  setup:
    name: Setup
    runs-on: ubuntu-latest

    outputs:
      ref: ${{ steps.ref.outputs.ref }}

    steps:
      - name: Determine Ref
        id: ref
        run: |
          if [ -n "${{ inputs.ref }}" ]; then
            echo "ref=${{ inputs.ref }}" >> $GITHUB_OUTPUT
            echo "Using provided ref: ${{ inputs.ref }}"
          else
            echo "ref=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "Using current ref: ${{ github.ref_name }}"
          fi

  # =====================================================
  # Pending Status 보고
  # =====================================================
  report-pending:
    name: Report Pending Status
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.ref != ''

    steps:
      - name: Get Commit SHA
        id: sha
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REF="${{ needs.setup.outputs.ref }}"
          SHA=$(gh api "repos/${{ github.repository }}/git/ref/heads/${REF}" --jq '.object.sha' 2>/dev/null || echo "")

          if [ -z "$SHA" ]; then
            echo "::warning::Could not get SHA for ref ${REF}"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "sha=${SHA}" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Report Pending Status
        if: steps.sha.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.sha.outputs.sha }}"
          TARGET_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          gh api "repos/${{ github.repository }}/statuses/${SHA}" \
            -X POST \
            -f state="pending" \
            -f target_url="$TARGET_URL" \
            -f description="E2E tests running..." \
            -f context="E2E Tests"

          echo "Reported pending status for commit $SHA"

  # =====================================================
  # E2E Tests - macOS (모든 테스트 실행)
  # =====================================================
  e2e-test-macos:
    name: E2E (macOS, Unity ${{ matrix.unity-version }})
    needs: setup

    strategy:
      fail-fast: false
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2", "6000.3"]

    uses: ./.github/workflows/unity-build.yml
    with:
      ref: ${{ needs.setup.outputs.ref }}
      os: macos
      unity-version: ${{ matrix.unity-version }}
      run-build: true
      run-e2e-test: true
      run-benchmark: true
      clean-library: ${{ inputs.clean_library || false }}

  # =====================================================
  # E2E Tests - Windows (테스트 1-5만 실행)
  # =====================================================
  e2e-test-windows:
    name: E2E 1-5 (Windows, Unity ${{ matrix.unity-version }})
    needs: setup

    strategy:
      fail-fast: false
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2", "6000.3"]

    uses: ./.github/workflows/unity-build.yml
    with:
      ref: ${{ needs.setup.outputs.ref }}
      os: windows
      unity-version: ${{ matrix.unity-version }}
      run-build: true
      run-e2e-test: true
      run-benchmark: false
      clean-library: ${{ inputs.clean_library || false }}

  # =====================================================
  # Test Report Summary
  # =====================================================
  test-report:
    name: Test Report Summary
    runs-on: ubuntu-latest
    needs: [setup, e2e-test-macos, e2e-test-windows]
    if: always()

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Download All Artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: Generate Benchmark Report
        run: node .github/scripts/generate-benchmark-report.js

      - name: Write Job Summary
        run: cat benchmark-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Benchmark Report
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-report
          path: benchmark-report.md
          if-no-files-found: warn
          retention-days: 30

  # =====================================================
  # Commit Status 보고
  # =====================================================
  report-status:
    name: Report Status
    runs-on: ubuntu-latest
    needs: [setup, e2e-test-macos, e2e-test-windows]
    if: always() && needs.setup.outputs.ref != ''

    steps:
      - name: Determine Status
        id: status
        run: |
          MACOS_RESULT="${{ needs.e2e-test-macos.result }}"
          WINDOWS_RESULT="${{ needs.e2e-test-windows.result }}"

          if [ "$MACOS_RESULT" = "success" ] && [ "$WINDOWS_RESULT" = "success" ]; then
            echo "state=success" >> $GITHUB_OUTPUT
            echo "description=All E2E tests passed (macOS:1-9, Windows:1-5)" >> $GITHUB_OUTPUT
          elif [ "$MACOS_RESULT" = "cancelled" ] || [ "$WINDOWS_RESULT" = "cancelled" ]; then
            echo "state=error" >> $GITHUB_OUTPUT
            echo "description=Tests cancelled" >> $GITHUB_OUTPUT
          else
            echo "state=failure" >> $GITHUB_OUTPUT
            echo "description=Tests failed (macOS: $MACOS_RESULT, Windows: $WINDOWS_RESULT)" >> $GITHUB_OUTPUT
          fi

      - name: Get Commit SHA
        id: sha
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REF="${{ needs.setup.outputs.ref }}"
          SHA=$(gh api "repos/${{ github.repository }}/git/ref/heads/${REF}" --jq '.object.sha' 2>/dev/null || echo "")

          if [ -z "$SHA" ]; then
            echo "::warning::Could not get SHA for ref ${REF}"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "sha=${SHA}" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Report Commit Status
        if: steps.sha.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.sha.outputs.sha }}"
          STATE="${{ steps.status.outputs.state }}"
          DESCRIPTION="${{ steps.status.outputs.description }}"
          TARGET_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          gh api "repos/${{ github.repository }}/statuses/${SHA}" \
            -X POST \
            -f state="$STATE" \
            -f target_url="$TARGET_URL" \
            -f description="$DESCRIPTION" \
            -f context="E2E Tests"

          echo "Reported status: $STATE for commit $SHA"
