name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      clean_library:
        description: 'Clean Unity Library cache (for cache corruption issues)'
        type: boolean
        default: false
  # update.ymlì—ì„œ í˜¸ì¶œë  ë•Œ ì‚¬ìš© (GITHUB_TOKEN ì œí•œ ìš°íšŒ)
  workflow_call:
    inputs:
      clean_library:
        description: 'Clean Unity Library cache'
        type: boolean
        default: false
      ref:
        description: 'Git ref to checkout (branch name)'
        type: string
        required: false

# ë™ì¼ ë¸Œëžœì¹˜ì—ì„œ ìƒˆ ì‹¤í–‰ ì‹œ ì´ì „ ì‹¤í–‰ ìžë™ ì·¨ì†Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =====================================================
  # E2E Tests - macOS (ë³‘ë ¬ ì‹¤í–‰)
  # =====================================================
  e2e-test-macos:
    name: E2E (macOS, Unity ${{ matrix.unity-version }})
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2"]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Clean Previous Build Artifacts
        run: |
          PROJECT_PATH="Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}"
          echo "Cleaning previous build artifacts..."
          rm -rf "${PROJECT_PATH}/ait-build" 2>/dev/null || true
          rm -rf "${PROJECT_PATH}/webgl" 2>/dev/null || true
          # Library ìºì‹œëŠ” ìœ ì§€í•˜ì—¬ ì¦ë¶„ ë¹Œë“œ í™œìš© (self-hosted runner ìž¥ì )
          # ìºì‹œ ë¬¸ì œ ë°œìƒ ì‹œ workflow_dispatchì—ì„œ clean_library=trueë¡œ ì‹¤í–‰
          if [ "${{ inputs.clean_library }}" = "true" ]; then
            echo "Cleaning Library cache (requested via workflow_dispatch)..."
            rm -rf "${PROJECT_PATH}/Library" 2>/dev/null || true
          fi
          echo "Done."

      - name: Detect Unity Installation
        id: unity
        run: |
          UNITY_BASE="/Applications/Unity/Hub/Editor"
          UNITY_VERSION_PATTERN="${{ matrix.unity-version }}"

          echo "Searching for Unity ${UNITY_VERSION_PATTERN}.x in ${UNITY_BASE}..."

          UNITY_DIR=$(ls -d "${UNITY_BASE}/${UNITY_VERSION_PATTERN}"* 2>/dev/null | sort -rV | head -1)

          if [ -z "$UNITY_DIR" ]; then
            echo "::error::Unity ${UNITY_VERSION_PATTERN}.x not found"
            echo "Available versions:"
            ls -la "${UNITY_BASE}" 2>/dev/null || echo "Unity Hub Editor directory not found"
            exit 1
          fi

          UNITY_PATH="${UNITY_DIR}/Unity.app/Contents/MacOS/Unity"

          if [ ! -f "$UNITY_PATH" ]; then
            echo "::error::Unity executable not found at ${UNITY_PATH}"
            exit 1
          fi

          DETECTED_VERSION=$(basename "${UNITY_DIR}")
          echo "âœ“ Found Unity ${DETECTED_VERSION}"
          echo "  Path: ${UNITY_PATH}"

          echo "UNITY_PATH=${UNITY_PATH}" >> $GITHUB_OUTPUT
          echo "UNITY_VERSION=${DETECTED_VERSION}" >> $GITHUB_OUTPUT

      - name: Build Unity WebGL
        env:
          AIT_DEBUG_CONSOLE: "true"
        run: |
          UNITY_PATH="${{ steps.unity.outputs.UNITY_PATH }}"
          PROJECT_PATH="${{ github.workspace }}/Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Unity Build Configuration"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Unity Version: ${{ steps.unity.outputs.UNITY_VERSION }}"
          echo "Unity Path: ${UNITY_PATH}"
          echo "Project Path: ${PROJECT_PATH}"
          echo "AIT_DEBUG_CONSOLE: ${AIT_DEBUG_CONSOLE}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          "$UNITY_PATH" -quit -batchmode -nographics \
            -projectPath "$PROJECT_PATH" \
            -executeMethod E2EBuildRunner.CommandLineBuild \
            -buildTarget WebGL \
            -logFile -

      - name: Verify Build Output
        run: |
          DIST_PATH="Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/dist/web"
          if [ -d "$DIST_PATH" ]; then
            echo "âœ… Build output found"
            ls -la "$DIST_PATH"
          else
            echo "âŒ Build output not found at $DIST_PATH"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Install Playwright Dependencies
        working-directory: Tests~/E2E/tests
        run: |
          rm -rf node_modules package-lock.json
          npm install
          npx playwright install chromium --with-deps
          npx playwright --version

      - name: Run E2E Tests
        working-directory: Tests~/E2E/tests
        env:
          UNITY_PROJECT_PATH: ${{ github.workspace }}/Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}
        run: npm test

      - name: Upload Benchmark Results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: benchmark-results-macos-${{ matrix.unity-version }}
          path: Tests~/E2E/tests/benchmark-results.json
          if-no-files-found: ignore

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: playwright-report-macos-${{ matrix.unity-version }}
          path: Tests~/E2E/tests/playwright-report/
          if-no-files-found: ignore

  # =====================================================
  # E2E Tests - Windows (ë³‘ë ¬ ì‹¤í–‰)
  # =====================================================
  e2e-test-windows:
    name: E2E (Windows, Unity ${{ matrix.unity-version }})
    runs-on: [self-hosted, Windows, X64, enabled]
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2"]

    steps:
      - name: Configure Git Long Paths
        shell: cmd
        run: git config --global core.longPaths true

      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Exclude Project from Windows Defender
        shell: cmd
        continue-on-error: true
        run: |
          @echo off
          REM Windows Defender ì‹¤ì‹œê°„ ê²€ì‚¬ì—ì„œ ë¹Œë“œ í´ë” ì œì™¸ (ë¹Œë“œ ì„±ëŠ¥ í–¥ìƒ)
          REM ê´€ë¦¬ìž ê¶Œí•œì´ ì—†ìœ¼ë©´ ì‹¤íŒ¨í•˜ì§€ë§Œ ë¹Œë“œëŠ” ê³„ì† ì§„í–‰
          powershell -Command "Add-MpPreference -ExclusionPath '${{ github.workspace }}' -ErrorAction SilentlyContinue" 2>nul
          powershell -Command "Add-MpPreference -ExclusionPath 'C:\Program Files\Unity' -ErrorAction SilentlyContinue" 2>nul
          echo Windows Defender exclusions configured (or skipped if no admin rights)
          exit /b 0

      - name: Clean Previous Build Artifacts
        shell: cmd
        run: |
          @echo off
          set "PROJECT_PATH=Tests~\E2E\SampleUnityProject-${{ matrix.unity-version }}"
          set "CLEAN_LIBRARY=${{ inputs.clean_library }}"
          echo Cleaning previous build artifacts...
          if exist "%PROJECT_PATH%\ait-build" rmdir /s /q "%PROJECT_PATH%\ait-build"
          if exist "%PROJECT_PATH%\webgl" rmdir /s /q "%PROJECT_PATH%\webgl"
          rem Library ìºì‹œëŠ” ìœ ì§€í•˜ì—¬ ì¦ë¶„ ë¹Œë“œ í™œìš© (self-hosted runner ìž¥ì )
          rem ìºì‹œ ë¬¸ì œ ë°œìƒ ì‹œ workflow_dispatchì—ì„œ clean_library=trueë¡œ ì‹¤í–‰
          if "%CLEAN_LIBRARY%"=="true" (
            echo Cleaning Library cache requested via workflow_dispatch...
            if exist "%PROJECT_PATH%\Library" rmdir /s /q "%PROJECT_PATH%\Library"
          )
          echo Done.

      - name: Detect Unity Installation
        id: unity
        shell: cmd
        run: |
          @echo off
          setlocal enabledelayedexpansion

          set "UNITY_BASE=C:\Program Files\Unity\Hub\Editor"
          set "VERSION_PATTERN=${{ matrix.unity-version }}"

          echo Searching for Unity %VERSION_PATTERN%.x in %UNITY_BASE%...

          set "UNITY_DIR="
          for /d %%d in ("%UNITY_BASE%\%VERSION_PATTERN%*") do (
            set "UNITY_DIR=%%d"
          )

          if not defined UNITY_DIR (
            echo ::error::Unity %VERSION_PATTERN%.x not found
            echo Available versions:
            dir /b "%UNITY_BASE%" 2>nul
            exit /b 1
          )

          set "UNITY_PATH=%UNITY_DIR%\Editor\Unity.exe"

          if not exist "%UNITY_PATH%" (
            echo ::error::Unity executable not found at %UNITY_PATH%
            exit /b 1
          )

          for %%i in ("%UNITY_DIR%") do set "DETECTED_VERSION=%%~nxi"
          echo Found Unity %DETECTED_VERSION%
          echo   Path: %UNITY_PATH%

          echo UNITY_PATH=%UNITY_PATH%>> %GITHUB_OUTPUT%
          echo UNITY_VERSION=%DETECTED_VERSION%>> %GITHUB_OUTPUT%

      - name: Build Unity WebGL
        shell: powershell -ExecutionPolicy Bypass -File {0}
        env:
          AIT_DEBUG_CONSOLE: "true"
        run: |
          $unityPath = "${{ steps.unity.outputs.UNITY_PATH }}"
          $projectPath = "${{ github.workspace }}\Tests~\E2E\SampleUnityProject-${{ matrix.unity-version }}"

          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "Unity Build Configuration"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "Unity Version: ${{ steps.unity.outputs.UNITY_VERSION }}"
          Write-Host "Unity Path: $unityPath"
          Write-Host "Project Path: $projectPath"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          $logFile = "$env:TEMP\unity-build-${{ matrix.unity-version }}.log"
          Write-Host "Starting Unity build..."
          Write-Host "Log file: $logFile"

          $unityProcess = Start-Process -FilePath $unityPath -ArgumentList @(
            "-quit", "-batchmode", "-nographics",
            "-projectPath", $projectPath,
            "-executeMethod", "E2EBuildRunner.CommandLineBuild",
            "-buildTarget", "WebGL",
            "-logFile", $logFile
          ) -PassThru -NoNewWindow

          # Unity ë¹Œë“œ ì™„ë£Œ ëŒ€ê¸° (ë¡œê·¸ ì‹¤ì‹œê°„ ì¶œë ¥)
          Write-Host "Waiting for Unity build to complete..."
          $lastSize = 0
          while (-not $unityProcess.HasExited) {
            Start-Sleep -Seconds 2
            if (Test-Path $logFile) {
              $content = Get-Content $logFile -Raw -ErrorAction SilentlyContinue
              if ($content -and $content.Length -gt $lastSize) {
                $newContent = $content.Substring($lastSize)
                Write-Host $newContent
                $lastSize = $content.Length
              }
            }
          }

          # ìµœì¢… ë¡œê·¸ ì¶œë ¥
          if (Test-Path $logFile) {
            $content = Get-Content $logFile -Raw -ErrorAction SilentlyContinue
            if ($content -and $content.Length -gt $lastSize) {
              Write-Host $content.Substring($lastSize)
            }
          }

          if ($unityProcess.ExitCode -ne 0) {
            Write-Host "::error::Unity build failed with exit code: $($unityProcess.ExitCode)"
            exit $unityProcess.ExitCode
          }

          Write-Host "Unity build completed successfully"

      - name: Verify Build Output
        shell: cmd
        run: |
          @echo off
          set "DIST_PATH=Tests~\E2E\SampleUnityProject-${{ matrix.unity-version }}\ait-build\dist\web"
          if exist "%DIST_PATH%" (
            echo Build output found
            dir "%DIST_PATH%"
          ) else (
            echo ::error::Build output not found at %DIST_PATH%
            exit /b 1
          )

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Install Playwright Dependencies
        working-directory: Tests~/E2E/tests
        shell: cmd
        run: |
          @echo off
          if exist node_modules rmdir /s /q node_modules
          if exist package-lock.json del /f package-lock.json
          call npm install
          call npx playwright install chromium --with-deps
          call npx playwright --version

      - name: Run E2E Tests
        working-directory: Tests~/E2E/tests
        shell: cmd
        env:
          UNITY_PROJECT_PATH: ${{ github.workspace }}\Tests~\E2E\SampleUnityProject-${{ matrix.unity-version }}
        run: call npm test

      - name: Upload Benchmark Results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: benchmark-results-windows-${{ matrix.unity-version }}
          path: Tests~/E2E/tests/benchmark-results.json
          if-no-files-found: ignore

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: playwright-report-windows-${{ matrix.unity-version }}
          path: Tests~/E2E/tests/playwright-report/
          if-no-files-found: ignore

  # =====================================================
  # Test Report Summary
  # =====================================================
  test-report:
    name: Test Report Summary
    runs-on: ubuntu-latest
    needs: [e2e-test-macos, e2e-test-windows]
    if: always()

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts

      - name: Generate Summary
        run: |
          echo "## ðŸ“Š E2E Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Self-hosted Runner ì •ë³´
          echo "### ðŸ–¥ï¸ Test Environment" >> $GITHUB_STEP_SUMMARY
          echo "| OS | Unity Versions | Runner Type |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|---------------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | 2021.3, 2022.3, 6000.0, 6000.2 | Self-hosted ARM64 (ë³‘ë ¬) |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | 2021.3, 2022.3, 6000.0, 6000.2 | Self-hosted X64 (ë³‘ë ¬) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Benchmark ê²°ê³¼
          echo "### ðŸ“ˆ Benchmark Results" >> $GITHUB_STEP_SUMMARY

          for os in macos windows; do
            for version in 2021.3 2022.3 6000.0 6000.2; do
              RESULTS_FILE="artifacts/benchmark-results-${os}-${version}/benchmark-results.json"
              if [ -f "$RESULTS_FILE" ]; then
                echo "#### ${os^} - Unity ${version}" >> $GITHUB_STEP_SUMMARY
                echo '```json' >> $GITHUB_STEP_SUMMARY
                cat "$RESULTS_FILE" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            done
          done

          # ê²°ê³¼ ì—†ëŠ” ê²½ìš°
          if [ ! -d "artifacts" ] || [ -z "$(ls -A artifacts 2>/dev/null)" ]; then
            echo "âš ï¸ No benchmark results available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Combined Report
        uses: actions/upload-artifact@v5
        with:
          name: combined-test-report
          path: artifacts/
          if-no-files-found: ignore

  # =====================================================
  # Commit Status ë³´ê³  (workflow_callë¡œ í˜¸ì¶œëœ ê²½ìš°)
  # GITHUB_TOKENìœ¼ë¡œ ìƒì„±ëœ ì›Œí¬í”Œë¡œìš°ëŠ” PR checkë¡œ í‘œì‹œë˜ì§€ ì•Šìœ¼ë¯€ë¡œ
  # commit status APIë¥¼ ì‚¬ìš©í•˜ì—¬ ê²°ê³¼ë¥¼ ë³´ê³ 
  # =====================================================
  report-status:
    name: Report Status to PR
    runs-on: ubuntu-latest
    needs: [e2e-test-macos, e2e-test-windows]
    if: always() && inputs.ref != ''

    steps:
      - name: Determine Status
        id: status
        run: |
          MACOS_RESULT="${{ needs.e2e-test-macos.result }}"
          WINDOWS_RESULT="${{ needs.e2e-test-windows.result }}"

          if [ "$MACOS_RESULT" = "success" ] && [ "$WINDOWS_RESULT" = "success" ]; then
            echo "state=success" >> $GITHUB_OUTPUT
            echo "description=E2E tests passed (macOS + Windows)" >> $GITHUB_OUTPUT
          elif [ "$MACOS_RESULT" = "cancelled" ] || [ "$WINDOWS_RESULT" = "cancelled" ]; then
            echo "state=error" >> $GITHUB_OUTPUT
            echo "description=E2E tests cancelled" >> $GITHUB_OUTPUT
          else
            echo "state=failure" >> $GITHUB_OUTPUT
            echo "description=E2E tests failed (macOS: $MACOS_RESULT, Windows: $WINDOWS_RESULT)" >> $GITHUB_OUTPUT
          fi

      - name: Get Commit SHA
        id: sha
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REF="${{ inputs.ref }}"
          SHA=$(gh api "repos/${{ github.repository }}/git/ref/heads/${REF}" --jq '.object.sha' 2>/dev/null || echo "")

          if [ -z "$SHA" ]; then
            echo "::warning::Could not get SHA for ref ${REF}"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "sha=${SHA}" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Report Commit Status
        if: steps.sha.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.sha.outputs.sha }}"
          STATE="${{ steps.status.outputs.state }}"
          DESCRIPTION="${{ steps.status.outputs.description }}"
          TARGET_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          gh api "repos/${{ github.repository }}/statuses/${SHA}" \
            -X POST \
            -f state="$STATE" \
            -f target_url="$TARGET_URL" \
            -f description="$DESCRIPTION" \
            -f context="E2E Tests (via SDK Update)"

          echo "Reported status: $STATE for commit $SHA"
