name: Tests

on:
  push:
    branches: [master, dave, chore/github-actions-runner]
  pull_request:
    branches: [master]
  workflow_dispatch:

# ë™ì¼ ë¸Œëžœì¹˜ì—ì„œ ìƒˆ ì‹¤í–‰ ì‹œ ì´ì „ ì‹¤í–‰ ìžë™ ì·¨ì†Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =====================================================
  # E2E Tests - macOS (ë³‘ë ¬ ì‹¤í–‰)
  # =====================================================
  e2e-test-macos:
    name: E2E (macOS, Unity ${{ matrix.unity-version }})
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2"]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Clean Previous Build Artifacts
        run: |
          PROJECT_PATH="Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}"
          echo "Cleaning previous build artifacts..."
          rm -rf "${PROJECT_PATH}/ait-build" 2>/dev/null || true
          rm -rf "${PROJECT_PATH}/webgl" 2>/dev/null || true
          rm -rf "${PROJECT_PATH}/Library/Bee" 2>/dev/null || true
          echo "Done."

      - name: Detect Unity Installation
        id: unity
        run: |
          UNITY_BASE="/Applications/Unity/Hub/Editor"
          UNITY_VERSION_PATTERN="${{ matrix.unity-version }}"

          echo "Searching for Unity ${UNITY_VERSION_PATTERN}.x in ${UNITY_BASE}..."

          UNITY_DIR=$(ls -d "${UNITY_BASE}/${UNITY_VERSION_PATTERN}"* 2>/dev/null | sort -rV | head -1)

          if [ -z "$UNITY_DIR" ]; then
            echo "::error::Unity ${UNITY_VERSION_PATTERN}.x not found"
            echo "Available versions:"
            ls -la "${UNITY_BASE}" 2>/dev/null || echo "Unity Hub Editor directory not found"
            exit 1
          fi

          UNITY_PATH="${UNITY_DIR}/Unity.app/Contents/MacOS/Unity"

          if [ ! -f "$UNITY_PATH" ]; then
            echo "::error::Unity executable not found at ${UNITY_PATH}"
            exit 1
          fi

          DETECTED_VERSION=$(basename "${UNITY_DIR}")
          echo "âœ“ Found Unity ${DETECTED_VERSION}"
          echo "  Path: ${UNITY_PATH}"

          echo "UNITY_PATH=${UNITY_PATH}" >> $GITHUB_OUTPUT
          echo "UNITY_VERSION=${DETECTED_VERSION}" >> $GITHUB_OUTPUT

      - name: Build Unity WebGL
        run: |
          UNITY_PATH="${{ steps.unity.outputs.UNITY_PATH }}"
          PROJECT_PATH="${{ github.workspace }}/Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Unity Build Configuration"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Unity Version: ${{ steps.unity.outputs.UNITY_VERSION }}"
          echo "Unity Path: ${UNITY_PATH}"
          echo "Project Path: ${PROJECT_PATH}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          "$UNITY_PATH" -quit -batchmode -nographics \
            -projectPath "$PROJECT_PATH" \
            -executeMethod E2EBuildRunner.CommandLineBuild \
            -buildTarget WebGL \
            -logFile -

      - name: Verify Build Output
        run: |
          DIST_PATH="Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/dist/web"
          if [ -d "$DIST_PATH" ]; then
            echo "âœ… Build output found"
            ls -la "$DIST_PATH"
          else
            echo "âŒ Build output not found at $DIST_PATH"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Playwright Dependencies
        working-directory: Tests~/E2E/tests
        run: |
          rm -rf node_modules package-lock.json
          npm install
          npx playwright install chromium --with-deps
          npx playwright --version

      - name: Run E2E Tests
        working-directory: Tests~/E2E/tests
        env:
          UNITY_PROJECT_PATH: ${{ github.workspace }}/Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}
        run: npm test

      - name: Upload Benchmark Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-results-macos-${{ matrix.unity-version }}
          path: Tests~/E2E/tests/benchmark-results.json
          if-no-files-found: ignore

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-macos-${{ matrix.unity-version }}
          path: Tests~/E2E/tests/playwright-report/
          if-no-files-found: ignore

  # =====================================================
  # E2E Tests - Windows (ìˆœì°¨ ì‹¤í–‰ - ë¼ì´ì„ ìŠ¤ ì¶©ëŒ ë°©ì§€)
  # =====================================================
  e2e-test-windows:
    name: E2E (Windows, Unity ${{ matrix.unity-version }})
    runs-on: [self-hosted, Windows, X64]
    timeout-minutes: 60

    strategy:
      fail-fast: false
      # Windowsì—ì„œëŠ” ë™ì¼ ë¨¸ì‹ ì—ì„œ ì—¬ëŸ¬ Unity ë²„ì „ì´ ë™ì‹œì— ì‹¤í–‰ë  ë•Œ
      # ë¼ì´ì„ ì‹± í´ë¼ì´ì–¸íŠ¸ ì¶©ëŒ ë°œìƒ (Code 10 signature error)
      # ìˆœì°¨ ì‹¤í–‰ìœ¼ë¡œ ì¶©ëŒ ë°©ì§€
      max-parallel: 1
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2"]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Clean Previous Build Artifacts
        shell: cmd
        run: |
          @echo off
          set "PROJECT_PATH=Tests~\E2E\SampleUnityProject-${{ matrix.unity-version }}"
          echo Cleaning previous build artifacts...
          if exist "%PROJECT_PATH%\ait-build" rmdir /s /q "%PROJECT_PATH%\ait-build"
          if exist "%PROJECT_PATH%\webgl" rmdir /s /q "%PROJECT_PATH%\webgl"
          if exist "%PROJECT_PATH%\Library\Bee" rmdir /s /q "%PROJECT_PATH%\Library\Bee"
          echo Done.

      - name: Detect Unity Installation
        id: unity
        shell: cmd
        run: |
          @echo off
          setlocal enabledelayedexpansion

          set "UNITY_BASE=C:\Program Files\Unity\Hub\Editor"
          set "VERSION_PATTERN=${{ matrix.unity-version }}"

          echo Searching for Unity %VERSION_PATTERN%.x in %UNITY_BASE%...

          set "UNITY_DIR="
          for /d %%d in ("%UNITY_BASE%\%VERSION_PATTERN%*") do (
            set "UNITY_DIR=%%d"
          )

          if not defined UNITY_DIR (
            echo ::error::Unity %VERSION_PATTERN%.x not found
            echo Available versions:
            dir /b "%UNITY_BASE%" 2>nul
            exit /b 1
          )

          set "UNITY_PATH=%UNITY_DIR%\Editor\Unity.exe"

          if not exist "%UNITY_PATH%" (
            echo ::error::Unity executable not found at %UNITY_PATH%
            exit /b 1
          )

          for %%i in ("%UNITY_DIR%") do set "DETECTED_VERSION=%%~nxi"
          echo Found Unity %DETECTED_VERSION%
          echo   Path: %UNITY_PATH%

          echo UNITY_PATH=%UNITY_PATH%>> %GITHUB_OUTPUT%
          echo UNITY_VERSION=%DETECTED_VERSION%>> %GITHUB_OUTPUT%

      - name: Build Unity WebGL
        shell: cmd
        run: |
          @echo off
          set "UNITY_PATH=${{ steps.unity.outputs.UNITY_PATH }}"
          set "PROJECT_PATH=${{ github.workspace }}\Tests~\E2E\SampleUnityProject-${{ matrix.unity-version }}"

          echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          echo Unity Build Configuration
          echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          echo Unity Version: ${{ steps.unity.outputs.UNITY_VERSION }}
          echo Unity Path: %UNITY_PATH%
          echo Project Path: %PROJECT_PATH%
          echo â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

          "%UNITY_PATH%" -quit -batchmode -nographics -projectPath "%PROJECT_PATH%" -executeMethod E2EBuildRunner.CommandLineBuild -buildTarget WebGL -logFile -

          if %ERRORLEVEL% neq 0 (
            echo Unity build failed with exit code: %ERRORLEVEL%
            exit /b %ERRORLEVEL%
          )

      - name: Verify Build Output
        shell: cmd
        run: |
          @echo off
          set "DIST_PATH=Tests~\E2E\SampleUnityProject-${{ matrix.unity-version }}\ait-build\dist\web"
          if exist "%DIST_PATH%" (
            echo Build output found
            dir "%DIST_PATH%"
          ) else (
            echo ::error::Build output not found at %DIST_PATH%
            exit /b 1
          )

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Playwright Dependencies
        shell: cmd
        working-directory: Tests~/E2E/tests
        run: |
          @echo off
          if exist node_modules rmdir /s /q node_modules
          if exist package-lock.json del /f package-lock.json
          call npm install
          call npx playwright install chromium --with-deps
          call npx playwright --version

      - name: Run E2E Tests
        shell: cmd
        working-directory: Tests~/E2E/tests
        env:
          UNITY_PROJECT_PATH: ${{ github.workspace }}\Tests~\E2E\SampleUnityProject-${{ matrix.unity-version }}
        run: call npm test

      - name: Upload Benchmark Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-results-windows-${{ matrix.unity-version }}
          path: Tests~/E2E/tests/benchmark-results.json
          if-no-files-found: ignore

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-windows-${{ matrix.unity-version }}
          path: Tests~/E2E/tests/playwright-report/
          if-no-files-found: ignore

  # =====================================================
  # Test Report Summary
  # =====================================================
  test-report:
    name: Test Report Summary
    runs-on: ubuntu-latest
    needs: [e2e-test-macos, e2e-test-windows]
    if: always()

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate Summary
        run: |
          echo "## ðŸ“Š E2E Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Self-hosted Runner ì •ë³´
          echo "### ðŸ–¥ï¸ Test Environment" >> $GITHUB_STEP_SUMMARY
          echo "| OS | Unity Versions | Runner Type |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|---------------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | 2021.3, 2022.3, 6000.0, 6000.2 | Self-hosted ARM64 (ë³‘ë ¬) |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | 2021.3, 2022.3, 6000.0, 6000.2 | Self-hosted X64 (ìˆœì°¨) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Benchmark ê²°ê³¼
          echo "### ðŸ“ˆ Benchmark Results" >> $GITHUB_STEP_SUMMARY

          for os in macos windows; do
            for version in 2021.3 2022.3 6000.0 6000.2; do
              RESULTS_FILE="artifacts/benchmark-results-${os}-${version}/benchmark-results.json"
              if [ -f "$RESULTS_FILE" ]; then
                echo "#### ${os^} - Unity ${version}" >> $GITHUB_STEP_SUMMARY
                echo '```json' >> $GITHUB_STEP_SUMMARY
                cat "$RESULTS_FILE" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            done
          done

          # ê²°ê³¼ ì—†ëŠ” ê²½ìš°
          if [ ! -d "artifacts" ] || [ -z "$(ls -A artifacts 2>/dev/null)" ]; then
            echo "âš ï¸ No benchmark results available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Combined Report
        uses: actions/upload-artifact@v4
        with:
          name: combined-test-report
          path: artifacts/
          if-no-files-found: ignore
