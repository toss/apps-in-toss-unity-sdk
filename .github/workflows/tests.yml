name: Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      clean_library:
        description: 'Clean Unity Library cache (for cache corruption issues)'
        type: boolean
        default: false
  # update.ymlì—ì„œ í˜¸ì¶œë  ë•Œ ì‚¬ìš© (GITHUB_TOKEN ì œí•œ ìš°íšŒ)
  workflow_call:
    inputs:
      clean_library:
        description: 'Clean Unity Library cache'
        type: boolean
        default: false
      ref:
        description: 'Git ref to checkout (branch name)'
        type: string
        required: false

# ì›Œí¬í”Œë¡œìš° ë ˆë²¨ concurrency ì œê±° - job ë ˆë²¨ì—ì„œ OS+Unity ë²„ì „ë³„ë¡œ ì œì–´

jobs:
  # =====================================================
  # Pending Status ë³´ê³  (í…ŒìŠ¤íŠ¸ ì‹œìž‘ ì‹œ)
  # =====================================================
  report-pending:
    name: Report Pending Status
    runs-on: ubuntu-latest
    if: inputs.ref != ''

    steps:
      - name: Get Commit SHA
        id: sha
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REF="${{ inputs.ref }}"
          SHA=$(gh api "repos/${{ github.repository }}/git/ref/heads/${REF}" --jq '.object.sha' 2>/dev/null || echo "")

          if [ -z "$SHA" ]; then
            echo "::warning::Could not get SHA for ref ${REF}"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "sha=${SHA}" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Report Pending Status
        if: steps.sha.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.sha.outputs.sha }}"
          TARGET_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          gh api "repos/${{ github.repository }}/statuses/${SHA}" \
            -X POST \
            -f state="pending" \
            -f target_url="$TARGET_URL" \
            -f description="E2E tests running..." \
            -f context="E2E Tests (via SDK Update)"

          echo "Reported pending status for commit $SHA"

  # =====================================================
  # SDK Generator Unit Tests
  # =====================================================
  sdk-generator-tests:
    name: SDK Generator Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Mono (for C# compilation tests)
        run: |
          sudo apt-get update
          sudo apt-get install -y mono-mcs
          mcs --version

      - name: Install Dependencies
        working-directory: sdk-runtime-generator~
        run: pnpm install

      - name: Run Unit Tests (Tier 1 - C# compilation)
        working-directory: sdk-runtime-generator~
        run: pnpm run test:tier1

      - name: Run Unit Tests (Tier 2 - C#/jslib invariants)
        working-directory: sdk-runtime-generator~
        run: pnpm run test:tier2

  # =====================================================
  # E2E Tests - macOS
  # =====================================================
  e2e-test-macos:
    name: E2E (macOS, Unity ${{ matrix.unity-version }})
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 60

    # ë™ì¼ ë¸Œëžœì¹˜ + Unity ë²„ì „ ì¡°í•©ì—ì„œë§Œ ë™ì‹œ ì‹¤í–‰ ë°©ì§€
    # ë‹¤ë¥¸ ë¸Œëžœì¹˜ëŠ” ë…ë¦½ ì‹¤í–‰, ê°™ì€ ë¸Œëžœì¹˜ ë‚´ ì´ì „ ì‹¤í–‰ì€ ì·¨ì†Œ
    concurrency:
      group: ${{ github.workflow }}-macos-${{ matrix.unity-version }}-${{ github.head_ref || github.ref }}
      cancel-in-progress: true

    strategy:
      fail-fast: false
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2", "6000.3"]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Clean Previous Build Artifacts
        run: |
          PROJECT_PATH="Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}"
          echo "Cleaning previous build artifacts..."
          rm -rf "${PROJECT_PATH}/ait-build" 2>/dev/null || true
          rm -rf "${PROJECT_PATH}/webgl" 2>/dev/null || true
          # Library ìºì‹œëŠ” ìœ ì§€í•˜ì—¬ ì¦ë¶„ ë¹Œë“œ í™œìš© (self-hosted runner ìž¥ì )
          # ìºì‹œ ë¬¸ì œ ë°œìƒ ì‹œ workflow_dispatchì—ì„œ clean_library=trueë¡œ ì‹¤í–‰
          if [ "${{ inputs.clean_library }}" = "true" ]; then
            echo "Cleaning Library cache (requested via workflow_dispatch)..."
            rm -rf "${PROJECT_PATH}/Library" 2>/dev/null || true
          fi
          echo "Done."

      - name: Detect Unity Installation
        id: unity
        run: |
          UNITY_BASE="/Applications/Unity/Hub/Editor"
          UNITY_VERSION_PATTERN="${{ matrix.unity-version }}"

          echo "Searching for Unity ${UNITY_VERSION_PATTERN}.x in ${UNITY_BASE}..."

          UNITY_DIR=$(ls -d "${UNITY_BASE}/${UNITY_VERSION_PATTERN}"* 2>/dev/null | sort -rV | head -1)

          if [ -z "$UNITY_DIR" ]; then
            echo "::error::Unity ${UNITY_VERSION_PATTERN}.x not found"
            echo "Available versions:"
            ls -la "${UNITY_BASE}" 2>/dev/null || echo "Unity Hub Editor directory not found"
            exit 1
          fi

          UNITY_PATH="${UNITY_DIR}/Unity.app/Contents/MacOS/Unity"

          if [ ! -f "$UNITY_PATH" ]; then
            echo "::error::Unity executable not found at ${UNITY_PATH}"
            exit 1
          fi

          DETECTED_VERSION=$(basename "${UNITY_DIR}")
          echo "âœ“ Found Unity ${DETECTED_VERSION}"
          echo "  Path: ${UNITY_PATH}"

          echo "UNITY_PATH=${UNITY_PATH}" >> $GITHUB_OUTPUT
          echo "UNITY_VERSION=${DETECTED_VERSION}" >> $GITHUB_OUTPUT

      - name: Build Unity WebGL
        env:
          AIT_DEBUG_CONSOLE: "true"
        run: |
          UNITY_PATH="${{ steps.unity.outputs.UNITY_PATH }}"
          PROJECT_PATH="${{ github.workspace }}/Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Unity Build Configuration"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Unity Version: ${{ steps.unity.outputs.UNITY_VERSION }}"
          echo "Unity Path: ${UNITY_PATH}"
          echo "Project Path: ${PROJECT_PATH}"
          echo "AIT_DEBUG_CONSOLE: ${AIT_DEBUG_CONSOLE}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          "$UNITY_PATH" -quit -batchmode -nographics \
            -projectPath "$PROJECT_PATH" \
            -executeMethod E2EBuildRunner.CommandLineBuild \
            -buildTarget WebGL \
            -logFile -

      - name: Verify Build Output
        run: |
          DIST_PATH="Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/dist"
          AIT_BUILD_PATH="Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build"

          if [ ! -d "$DIST_PATH" ]; then
            echo "âŒ Build output not found at $DIST_PATH"
            exit 1
          fi

          echo "âœ… dist/ í´ë” í™•ì¸ë¨"
          echo ""
          echo "dist/ ë‚´ìš©:"
          ls -la "$DIST_PATH"
          echo ""
          echo "dist/web/ ë‚´ìš©:"
          ls -la "$DIST_PATH/web" || true
          echo ""

          # .ait íŒŒì¼ í™•ì¸ (dist/ ë˜ëŠ” ait-build/ í´ë”ì—ì„œ)
          AIT_FILE=$(find "$DIST_PATH" -maxdepth 1 -name "*.ait" -type f 2>/dev/null | head -1)
          if [ -z "$AIT_FILE" ]; then
            AIT_FILE=$(find "$AIT_BUILD_PATH" -maxdepth 1 -name "*.ait" -type f 2>/dev/null | head -1)
          fi

          if [ -z "$AIT_FILE" ]; then
            echo "âŒ .ait íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            echo "ait-build/ ë£¨íŠ¸ ë‚´ìš©:"
            ls -la "$AIT_BUILD_PATH"
            echo ""
            echo "::error::.ait íŒŒì¼ ë¯¸ìƒì„± - ë°°í¬ì— í•„ìš”í•œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi

          echo "âœ… .ait íŒŒì¼ ìƒì„± í™•ì¸: $AIT_FILE"

      # ait deployëŠ” ait-build/ ë””ë ‰í† ë¦¬ ë‚´ì—ì„œ ì‹¤í–‰ë˜ì–´ì•¼ í•¨
      # ë°°í¬ì— í•„ìš”í•œ íŒŒì¼ë§Œ ì—…ë¡œë“œ (node_modules, public ë“± ì œì™¸í•˜ì—¬ ìš©ëŸ‰ ì ˆê°)
      - name: Upload AIT Build
        uses: actions/upload-artifact@v6
        with:
          name: ait-build-macos-${{ matrix.unity-version }}
          path: |
            Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/dist/
            Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/*.ait
            Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/package.json
            Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/pnpm-lock.yaml
            Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}/ait-build/granite.config.ts
          if-no-files-found: error
          retention-days: 7

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Install Playwright Dependencies
        working-directory: Tests~/E2E/tests
        run: |
          rm -rf node_modules package-lock.json
          npm install
          npx playwright install chromium --with-deps
          npx playwright --version

      - name: Run E2E Tests
        working-directory: Tests~/E2E/tests
        env:
          UNITY_PROJECT_PATH: ${{ github.workspace }}/Tests~/E2E/SampleUnityProject-${{ matrix.unity-version }}
          MOBILE_EMULATION: "true"
        run: npm test

      - name: Upload Benchmark Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: benchmark-results-macos-${{ matrix.unity-version }}
          path: Tests~/E2E/tests/benchmark-results.json
          if-no-files-found: ignore

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: playwright-report-macos-${{ matrix.unity-version }}
          path: Tests~/E2E/tests/playwright-report/
          if-no-files-found: ignore
          compression-level: 9
          retention-days: 7

  # =====================================================
  # E2E Tests - Windows (í…ŒìŠ¤íŠ¸ 1-5ë§Œ ì‹¤í–‰)
  # ëª©ì : Windowsì—ì„œ ë¹Œë“œ ë° ê¸°ë³¸ ì„œë²„ ë™ìž‘ ê²€ì¦
  # í…ŒìŠ¤íŠ¸ 6-9 (ë²¤ì¹˜ë§ˆí¬, API ê²€ì¦, ì§ë ¬í™”, ë©”ëª¨ë¦¬ ì••ë°•)ëŠ” macOSì—ì„œë§Œ ì‹¤í–‰
  # =====================================================
  e2e-test-windows:
    name: E2E 1-5 (Windows, Unity ${{ matrix.unity-version }})
    runs-on: [self-hosted, Windows, X64, enabled]
    timeout-minutes: 50

    # ë™ì¼ ë¸Œëžœì¹˜ + Unity ë²„ì „ ì¡°í•©ì—ì„œë§Œ ë™ì‹œ ì‹¤í–‰ ë°©ì§€
    # ë‹¤ë¥¸ ë¸Œëžœì¹˜ëŠ” ë…ë¦½ ì‹¤í–‰, ê°™ì€ ë¸Œëžœì¹˜ ë‚´ ì´ì „ ì‹¤í–‰ì€ ì·¨ì†Œ
    concurrency:
      group: ${{ github.workflow }}-windows-${{ matrix.unity-version }}-${{ github.head_ref || github.ref }}
      cancel-in-progress: true

    strategy:
      fail-fast: false
      matrix:
        unity-version: ["2021.3", "2022.3", "6000.0", "6000.2", "6000.3"]

    steps:
      - name: Configure Git Long Paths
        shell: cmd
        run: |
          @echo off
          REM ì—¬ëŸ¬ jobì´ ë™ì‹œì— ì‹¤í–‰ë  ë•Œ .gitconfig ìž ê¸ˆ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•œ retry ë¡œì§
          setlocal enabledelayedexpansion
          set MAX_RETRIES=5
          set RETRY=0
          :retry_loop
          git config --global core.longPaths true 2>nul && (
            echo Git longPaths configured successfully
            exit /b 0
          )
          set /a RETRY+=1
          if !RETRY! LSS %MAX_RETRIES% (
            echo Retry !RETRY!/%MAX_RETRIES%...
            timeout /t 2 /nobreak >nul
            goto retry_loop
          )
          echo Git longPaths configuration completed (may have been set by another job)
          exit /b 0

      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Exclude Project from Windows Defender
        shell: cmd
        continue-on-error: true
        run: |
          @echo off
          REM Windows Defender ì‹¤ì‹œê°„ ê²€ì‚¬ì—ì„œ ë¹Œë“œ í´ë” ì œì™¸ (ë¹Œë“œ ì„±ëŠ¥ í–¥ìƒ)
          REM ê´€ë¦¬ìž ê¶Œí•œì´ ì—†ìœ¼ë©´ ì‹¤íŒ¨í•˜ì§€ë§Œ ë¹Œë“œëŠ” ê³„ì† ì§„í–‰
          powershell -Command "Add-MpPreference -ExclusionPath '${{ github.workspace }}' -ErrorAction SilentlyContinue" 2>nul
          powershell -Command "Add-MpPreference -ExclusionPath 'C:\Program Files\Unity' -ErrorAction SilentlyContinue" 2>nul
          echo Windows Defender exclusions configured (or skipped if no admin rights)
          exit /b 0

      - name: Clean Previous Build Artifacts
        shell: cmd
        run: |
          @echo off
          set "PROJECT_PATH=Tests~\E2E\SampleUnityProject-${{ matrix.unity-version }}"
          set "CLEAN_LIBRARY=${{ inputs.clean_library }}"
          echo Cleaning previous build artifacts...
          if exist "%PROJECT_PATH%\ait-build" rmdir /s /q "%PROJECT_PATH%\ait-build"
          if exist "%PROJECT_PATH%\webgl" rmdir /s /q "%PROJECT_PATH%\webgl"
          rem Library ìºì‹œëŠ” ìœ ì§€í•˜ì—¬ ì¦ë¶„ ë¹Œë“œ í™œìš© (self-hosted runner ìž¥ì )
          rem ìºì‹œ ë¬¸ì œ ë°œìƒ ì‹œ workflow_dispatchì—ì„œ clean_library=trueë¡œ ì‹¤í–‰
          if "%CLEAN_LIBRARY%"=="true" (
            echo Cleaning Library cache requested via workflow_dispatch...
            if exist "%PROJECT_PATH%\Library" rmdir /s /q "%PROJECT_PATH%\Library"
          )
          echo Done.

      - name: Detect Unity Installation
        id: unity
        shell: cmd
        run: |
          @echo off
          setlocal enabledelayedexpansion

          set "UNITY_BASE=C:\Program Files\Unity\Hub\Editor"
          set "VERSION_PATTERN=${{ matrix.unity-version }}"

          echo Searching for Unity %VERSION_PATTERN%.x in %UNITY_BASE%...

          set "UNITY_DIR="
          for /d %%d in ("%UNITY_BASE%\%VERSION_PATTERN%*") do (
            set "UNITY_DIR=%%d"
          )

          if not defined UNITY_DIR (
            echo ::error::Unity %VERSION_PATTERN%.x not found
            echo Available versions:
            dir /b "%UNITY_BASE%" 2>nul
            exit /b 1
          )

          set "UNITY_PATH=%UNITY_DIR%\Editor\Unity.exe"

          if not exist "%UNITY_PATH%" (
            echo ::error::Unity executable not found at %UNITY_PATH%
            exit /b 1
          )

          for %%i in ("%UNITY_DIR%") do set "DETECTED_VERSION=%%~nxi"
          echo Found Unity %DETECTED_VERSION%
          echo   Path: %UNITY_PATH%

          echo UNITY_PATH=%UNITY_PATH%>> %GITHUB_OUTPUT%
          echo UNITY_VERSION=%DETECTED_VERSION%>> %GITHUB_OUTPUT%

      - name: Wait for Unity License Client
        shell: powershell -ExecutionPolicy Bypass -File {0}
        run: |
          $targetVersion = "${{ matrix.unity-version }}"
          $maxWait = 60
          $interval = 10
          $waited = 0

          Write-Host "Checking for conflicting Unity License Client processes..."

          while ($waited -lt $maxWait) {
            # ë‹¤ë¥¸ ë²„ì „ì˜ LicenseClient ì°¾ê¸°
            $otherClients = Get-Process -Name "Unity.Licensing.Client" -ErrorAction SilentlyContinue |
              Where-Object { $_.Path -notlike "*$targetVersion*" }

            if (-not $otherClients) {
              Write-Host "No conflicting License Client found"
              break
            }

            Write-Host "Found License Client from other Unity version, waiting... ($waited/$maxWait sec)"
            foreach ($proc in $otherClients) {
              Write-Host "  - PID: $($proc.Id), Path: $($proc.Path)"
            }
            Start-Sleep -Seconds $interval
            $waited += $interval
          }

          # ëŒ€ê¸° í›„ì—ë„ ì¡´ìž¬í•˜ë©´ kill
          $otherClients = Get-Process -Name "Unity.Licensing.Client" -ErrorAction SilentlyContinue |
            Where-Object { $_.Path -notlike "*$targetVersion*" }

          if ($otherClients) {
            Write-Host "::warning::Killing stale License Client processes after ${maxWait}s timeout..."
            foreach ($proc in $otherClients) {
              Write-Host "  Killing PID: $($proc.Id), Path: $($proc.Path)"
              Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
            }
            Start-Sleep -Seconds 2
          }

          Write-Host "License Client check completed"

      - name: Build Unity WebGL
        shell: powershell -ExecutionPolicy Bypass -File {0}
        env:
          AIT_DEBUG_CONSOLE: "true"
        run: |
          $unityPath = "${{ steps.unity.outputs.UNITY_PATH }}"
          $projectPath = "${{ github.workspace }}\Tests~\E2E\SampleUnityProject-${{ matrix.unity-version }}"

          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "Unity Build Configuration"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "Unity Version: ${{ steps.unity.outputs.UNITY_VERSION }}"
          Write-Host "Unity Path: $unityPath"
          Write-Host "Project Path: $projectPath"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          $logFile = "$env:TEMP\unity-build-${{ matrix.unity-version }}.log"
          Write-Host "Starting Unity build..."
          Write-Host "Log file: $logFile"

          $unityProcess = Start-Process -FilePath $unityPath -ArgumentList @(
            "-quit", "-batchmode", "-nographics",
            "-projectPath", $projectPath,
            "-executeMethod", "E2EBuildRunner.CommandLineBuild",
            "-buildTarget", "WebGL",
            "-logFile", $logFile
          ) -PassThru -NoNewWindow

          # Unity ë¹Œë“œ ì™„ë£Œ ëŒ€ê¸° (ë¡œê·¸ ì‹¤ì‹œê°„ ì¶œë ¥)
          Write-Host "Waiting for Unity build to complete..."
          $lastSize = 0
          while (-not $unityProcess.HasExited) {
            Start-Sleep -Seconds 2
            if (Test-Path $logFile) {
              $content = Get-Content $logFile -Raw -ErrorAction SilentlyContinue
              if ($content -and $content.Length -gt $lastSize) {
                $newContent = $content.Substring($lastSize)
                Write-Host $newContent
                $lastSize = $content.Length
              }
            }
          }

          # ìµœì¢… ë¡œê·¸ ì¶œë ¥
          if (Test-Path $logFile) {
            $content = Get-Content $logFile -Raw -ErrorAction SilentlyContinue
            if ($content -and $content.Length -gt $lastSize) {
              Write-Host $content.Substring($lastSize)
            }
          }

          if ($unityProcess.ExitCode -ne 0) {
            Write-Host "::error::Unity build failed with exit code: $($unityProcess.ExitCode)"
            exit $unityProcess.ExitCode
          }

          Write-Host "Unity build completed successfully"

      - name: Verify Build Output
        shell: cmd
        run: |
          @echo off
          setlocal enabledelayedexpansion
          set "DIST_PATH=Tests~\E2E\SampleUnityProject-${{ matrix.unity-version }}\ait-build\dist"
          set "AIT_BUILD_PATH=Tests~\E2E\SampleUnityProject-${{ matrix.unity-version }}\ait-build"

          if not exist "%DIST_PATH%" (
            echo ::error::Build output not found at %DIST_PATH%
            exit /b 1
          )

          echo âœ… dist\ í´ë” í™•ì¸ë¨
          echo.
          echo dist\ ë‚´ìš©:
          dir "%DIST_PATH%"
          echo.
          echo dist\web\ ë‚´ìš©:
          dir "%DIST_PATH%\web" 2>nul
          echo.

          REM .ait íŒŒì¼ í™•ì¸ (dist\ ë˜ëŠ” ait-build\ í´ë”ì—ì„œ)
          set "AIT_FILE="
          for %%f in ("%DIST_PATH%\*.ait") do (
            set "AIT_FILE=%%f"
            goto :found_ait
          )
          for %%f in ("%AIT_BUILD_PATH%\*.ait") do (
            set "AIT_FILE=%%f"
            goto :found_ait
          )

          echo âŒ .ait íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!
          echo ait-build\ ë£¨íŠ¸ ë‚´ìš©:
          dir "%AIT_BUILD_PATH%"
          echo.
          echo ::error::.ait íŒŒì¼ ë¯¸ìƒì„± - ë°°í¬ì— í•„ìš”í•œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤
          exit /b 1

          :found_ait
          echo âœ… .ait íŒŒì¼ ìƒì„± í™•ì¸: !AIT_FILE!

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Install Playwright Dependencies
        working-directory: Tests~/E2E/tests
        shell: cmd
        run: |
          if exist node_modules rmdir /s /q node_modules
          if exist package-lock.json del package-lock.json
          npm install
          npx playwright install chromium --with-deps

      # Windowsì—ì„œëŠ” E2E í…ŒìŠ¤íŠ¸ 1-5ë§Œ ì‹¤í–‰ (ë¹Œë“œ/ì„œë²„ ê²€ì¦)
      # í…ŒìŠ¤íŠ¸ 6-9 (ë²¤ì¹˜ë§ˆí¬, API ê²€ì¦, ì§ë ¬í™”, ë©”ëª¨ë¦¬ ì••ë°•)ëŠ” macOSì—ì„œë§Œ ì‹¤í–‰
      - name: Run E2E Tests (1-5 only)
        working-directory: Tests~/E2E/tests
        shell: powershell
        env:
          UNITY_PROJECT_PATH: ${{ github.workspace }}\Tests~\E2E\SampleUnityProject-${{ matrix.unity-version }}
        run: npx playwright test --grep "[1-5]\. "

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: playwright-report-windows-${{ matrix.unity-version }}
          path: Tests~/E2E/tests/playwright-report/
          if-no-files-found: ignore
          compression-level: 9
          retention-days: 7

  # =====================================================
  # Test Report Summary
  # =====================================================
  test-report:
    name: Test Report Summary
    runs-on: ubuntu-latest
    needs: [sdk-generator-tests, e2e-test-macos, e2e-test-windows]
    if: always()

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Download All Artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: Generate Benchmark Report
        run: node .github/scripts/generate-benchmark-report.js

      - name: Write Job Summary
        run: cat benchmark-report.md >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('benchmark-report.md', 'utf8');

            // ê¸°ì¡´ ë²¤ì¹˜ë§ˆí¬ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('## ðŸ“Š Benchmark Results')
            );

            if (botComment) {
              // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
              console.log('Updated existing benchmark comment');
            } else {
              // ìƒˆ ì½”ë©˜íŠ¸ ìƒì„±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
              console.log('Created new benchmark comment');
            }

      # combined-test-report ì œê±°ë¨: ëª¨ë“  ì•„í‹°íŒ©íŠ¸ë¥¼ ì¤‘ë³µ ì €ìž¥í•˜ì—¬ ìš©ëŸ‰ ë‚­ë¹„
      # ê°œë³„ ì•„í‹°íŒ©íŠ¸(ait-build-*, benchmark-results-*, playwright-report-*)ëŠ” ì—¬ì „ížˆ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥

      - name: Upload Benchmark Report
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-report
          path: benchmark-report.md
          if-no-files-found: warn
          retention-days: 30

  # =====================================================
  # Commit Status ë³´ê³  (workflow_callë¡œ í˜¸ì¶œëœ ê²½ìš°)
  # GITHUB_TOKENìœ¼ë¡œ ìƒì„±ëœ ì›Œí¬í”Œë¡œìš°ëŠ” PR checkë¡œ í‘œì‹œë˜ì§€ ì•Šìœ¼ë¯€ë¡œ
  # commit status APIë¥¼ ì‚¬ìš©í•˜ì—¬ ê²°ê³¼ë¥¼ ë³´ê³ 
  # =====================================================
  report-status:
    name: Report Status to PR
    runs-on: ubuntu-latest
    needs: [sdk-generator-tests, e2e-test-macos, e2e-test-windows]
    if: always() && inputs.ref != ''

    steps:
      - name: Determine Status
        id: status
        run: |
          SDK_RESULT="${{ needs.sdk-generator-tests.result }}"
          MACOS_RESULT="${{ needs.e2e-test-macos.result }}"
          WINDOWS_RESULT="${{ needs.e2e-test-windows.result }}"

          if [ "$SDK_RESULT" = "success" ] && [ "$MACOS_RESULT" = "success" ] && [ "$WINDOWS_RESULT" = "success" ]; then
            echo "state=success" >> $GITHUB_OUTPUT
            echo "description=All tests passed (SDK + E2E macOS:1-9, Windows:1-5)" >> $GITHUB_OUTPUT
          elif [ "$SDK_RESULT" = "cancelled" ] || [ "$MACOS_RESULT" = "cancelled" ] || [ "$WINDOWS_RESULT" = "cancelled" ]; then
            echo "state=error" >> $GITHUB_OUTPUT
            echo "description=Tests cancelled" >> $GITHUB_OUTPUT
          else
            echo "state=failure" >> $GITHUB_OUTPUT
            echo "description=Tests failed (SDK: $SDK_RESULT, macOS: $MACOS_RESULT, Windows: $WINDOWS_RESULT)" >> $GITHUB_OUTPUT
          fi

      - name: Get Commit SHA
        id: sha
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REF="${{ inputs.ref }}"
          SHA=$(gh api "repos/${{ github.repository }}/git/ref/heads/${REF}" --jq '.object.sha' 2>/dev/null || echo "")

          if [ -z "$SHA" ]; then
            echo "::warning::Could not get SHA for ref ${REF}"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "sha=${SHA}" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Report Commit Status
        if: steps.sha.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ steps.sha.outputs.sha }}"
          STATE="${{ steps.status.outputs.state }}"
          DESCRIPTION="${{ steps.status.outputs.description }}"
          TARGET_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          gh api "repos/${{ github.repository }}/statuses/${SHA}" \
            -X POST \
            -f state="$STATE" \
            -f target_url="$TARGET_URL" \
            -f description="$DESCRIPTION" \
            -f context="E2E Tests (via SDK Update)"

          echo "Reported status: $STATE for commit $SHA"
