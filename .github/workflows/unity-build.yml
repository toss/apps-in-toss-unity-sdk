name: Unity Build

on:
  workflow_call:
    inputs:
      repository:
        description: 'Repository to checkout (for fork PRs)'
        type: string
        required: false
        default: ''
      ref:
        description: 'Git ref to checkout'
        type: string
        required: false
        default: ''
      os:
        description: 'Operating system (macos or windows)'
        type: string
        required: true
      unity-version:
        description: 'Unity version pattern (e.g., 2021.3, 6000.2)'
        type: string
        required: true
      web-framework-version:
        description: '@apps-in-toss/web-framework version for BuildConfig'
        type: string
        required: false
        default: ''
      run-build:
        description: 'Run Unity WebGL build'
        type: boolean
        required: false
        default: true
      run-e2e-test:
        description: 'Run E2E tests after build'
        type: boolean
        required: false
        default: false
      run-benchmark:
        description: 'Run benchmark tests'
        type: boolean
        required: false
        default: false
      sdk-version:
        description: 'SDK version for artifact naming (bulk release)'
        type: string
        required: false
        default: ''
      sdk-version-override:
        description: 'Override SDK version in package.json (for compatibility testing)'
        type: string
        required: false
        default: ''
      clean-library:
        description: 'Clean Unity Library cache'
        type: boolean
        required: false
        default: false
    secrets:
      AIT_AD_INTERSTITIAL_ID:
        description: 'Interstitial ad ID for testing'
        required: false
      AIT_AD_REWARDED_ID:
        description: 'Rewarded ad ID for testing'
        required: false
    outputs:
      artifact-name:
        description: 'Uploaded artifact name'
        value: ${{ jobs.build.outputs.artifact-name }}
      unity-version-full:
        description: 'Detected full Unity version'
        value: ${{ jobs.build.outputs.unity-version-full }}

jobs:
  build:
    name: Build (${{ inputs.os }}, Unity ${{ inputs.unity-version }})
    runs-on: ${{ inputs.os == 'macos' && fromJSON('["self-hosted", "macOS", "ARM64"]') || fromJSON('["self-hosted", "Windows", "X64", "enabled"]') }}
    timeout-minutes: 60
    concurrency:
      group: unity-build-${{ inputs.os }}-${{ inputs.unity-version }}${{ inputs.sdk-version-override && format('-sdk{0}', inputs.sdk-version-override) || '' }}
      cancel-in-progress: false

    outputs:
      artifact-name: ${{ steps.artifact.outputs.name }}
      unity-version-full: ${{ steps.unity.outputs.UNITY_VERSION }}

    steps:
      # =====================================================
      # Windows 전용 설정
      # =====================================================
      - name: Configure Git Long Paths (Windows)
        if: inputs.os == 'windows'
        shell: cmd
        run: |
          @echo off
          setlocal enabledelayedexpansion
          set MAX_RETRIES=5
          set RETRY=0
          :retry_loop
          git config --global core.longPaths true 2>nul && (
            echo Git longPaths configured successfully
            exit /b 0
          )
          set /a RETRY+=1
          if !RETRY! LSS %MAX_RETRIES% (
            echo Retry !RETRY!/%MAX_RETRIES%...
            timeout /t 2 /nobreak >nul
            goto retry_loop
          )
          echo Git longPaths configuration completed
          exit /b 0

      # =====================================================
      # Checkout
      # =====================================================
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          repository: ${{ inputs.repository || github.repository }}
          ref: ${{ inputs.ref || github.ref }}

      # =====================================================
      # SDK 버전 오버라이드 (런타임 호환성 테스트용)
      # SDK 코드는 재생성하지 않고, BuildConfig의 web-framework 버전만 변경
      # 이를 통해 현재 SDK 코드가 다른 버전의 web-framework와 호환되는지 테스트
      # =====================================================
      - name: Override SDK Version
        if: inputs.sdk-version-override != ''
        shell: bash
        run: |
          OVERRIDE_VERSION="${{ inputs.sdk-version-override }}"
          PACKAGE_JSON="package.json"

          echo "=== SDK Version Override (BuildConfig Only) ==="
          echo "Target SDK version: ${OVERRIDE_VERSION}"
          echo ""
          echo "NOTE: SDK 코드는 재생성하지 않고 현재 저장소의 코드를 사용합니다."
          echo "      BuildConfig의 web-framework 버전만 변경하여 런타임 호환성을 테스트합니다."
          echo ""

          # 1. package.json 버전 변경 (메타데이터용)
          echo "=== Updating package.json version ==="
          echo "Original version: $(grep '"version"' $PACKAGE_JSON)"
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            sed -i '' "s/\"version\": \"[^\"]*\"/\"version\": \"${OVERRIDE_VERSION}\"/" $PACKAGE_JSON
          else
            sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"${OVERRIDE_VERSION}\"/" $PACKAGE_JSON
          fi
          echo "Overridden version: $(grep '"version"' $PACKAGE_JSON)"

          # 2. BuildConfig의 web-framework 버전 동기화
          echo ""
          echo "=== Syncing BuildConfig web-framework version ==="
          BUILDCONFIG_PKG="WebGLTemplates/AITTemplate/BuildConfig~/package.json"
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            sed -i '' 's/"@apps-in-toss\/web-framework": "[^"]*"/"@apps-in-toss\/web-framework": "'"${OVERRIDE_VERSION}"'"/' "$BUILDCONFIG_PKG"
          else
            sed -i 's/"@apps-in-toss\/web-framework": "[^"]*"/"@apps-in-toss\/web-framework": "'"${OVERRIDE_VERSION}"'"/' "$BUILDCONFIG_PKG"
          fi
          echo "BuildConfig updated:"
          grep "web-framework" "$BUILDCONFIG_PKG"

          # 3. 현재 SDK 파일 확인
          echo ""
          echo "=== Current SDK files (not regenerated) ==="
          ls -la Runtime/SDK/ | head -20

          echo ""
          echo "=== Version Info ==="
          echo "SDK version override: ${OVERRIDE_VERSION}"
          echo "SDK code: Using current repository version (not regenerated)"

      # =====================================================
      # Windows Defender 제외 (Windows)
      # =====================================================
      - name: Exclude Project from Windows Defender (Windows)
        if: inputs.os == 'windows'
        shell: cmd
        continue-on-error: true
        run: |
          @echo off
          powershell -Command "Add-MpPreference -ExclusionPath '${{ github.workspace }}' -ErrorAction SilentlyContinue" 2>nul
          powershell -Command "Add-MpPreference -ExclusionPath 'C:\Program Files\Unity' -ErrorAction SilentlyContinue" 2>nul
          echo Windows Defender exclusions configured (or skipped if no admin rights)
          exit /b 0

      # =====================================================
      # 이전 빌드 정리
      # =====================================================
      - name: Clean Previous Build Artifacts (macOS)
        if: inputs.os == 'macos'
        run: |
          PROJECT_PATH="Tests~/E2E/SampleUnityProject-${{ inputs.unity-version }}"
          echo "Cleaning previous build artifacts..."
          rm -rf "${PROJECT_PATH}/ait-build" 2>/dev/null || true
          rm -rf "${PROJECT_PATH}/webgl" 2>/dev/null || true
          if [ "${{ inputs.clean-library }}" = "true" ]; then
            echo "Cleaning Library cache (requested via input)..."
            rm -rf "${PROJECT_PATH}/Library" 2>/dev/null || true
          fi
          echo "Done."

      - name: Clean Previous Build Artifacts (Windows)
        if: inputs.os == 'windows'
        shell: cmd
        run: |
          @echo off
          set "PROJECT_PATH=Tests~\E2E\SampleUnityProject-${{ inputs.unity-version }}"
          set "CLEAN_LIBRARY=${{ inputs.clean-library }}"
          echo Cleaning previous build artifacts...
          if exist "%PROJECT_PATH%\ait-build" rmdir /s /q "%PROJECT_PATH%\ait-build"
          if exist "%PROJECT_PATH%\webgl" rmdir /s /q "%PROJECT_PATH%\webgl"
          if "%CLEAN_LIBRARY%"=="true" (
            echo Cleaning Library cache requested via input...
            if exist "%PROJECT_PATH%\Library" rmdir /s /q "%PROJECT_PATH%\Library"
          )
          echo Done.

      # =====================================================
      # Unity 설치 감지
      # =====================================================
      - name: Detect Unity Installation (macOS)
        if: inputs.os == 'macos'
        id: unity-macos
        run: |
          UNITY_BASE="/Applications/Unity/Hub/Editor"
          UNITY_VERSION_PATTERN="${{ inputs.unity-version }}"

          echo "Searching for Unity ${UNITY_VERSION_PATTERN}.x in ${UNITY_BASE}..."

          UNITY_DIR=$(ls -d "${UNITY_BASE}/${UNITY_VERSION_PATTERN}"* 2>/dev/null | sort -rV | head -1)

          if [ -z "$UNITY_DIR" ]; then
            echo "::error::Unity ${UNITY_VERSION_PATTERN}.x not found"
            echo "Available versions:"
            ls -la "${UNITY_BASE}" 2>/dev/null || echo "Unity Hub Editor directory not found"
            exit 1
          fi

          UNITY_PATH="${UNITY_DIR}/Unity.app/Contents/MacOS/Unity"

          if [ ! -f "$UNITY_PATH" ]; then
            echo "::error::Unity executable not found at ${UNITY_PATH}"
            exit 1
          fi

          DETECTED_VERSION=$(basename "${UNITY_DIR}")
          echo "Found Unity ${DETECTED_VERSION}"
          echo "  Path: ${UNITY_PATH}"

          echo "UNITY_PATH=${UNITY_PATH}" >> $GITHUB_OUTPUT
          echo "UNITY_VERSION=${DETECTED_VERSION}" >> $GITHUB_OUTPUT

      - name: Detect Unity Installation (Windows)
        if: inputs.os == 'windows'
        id: unity-windows
        shell: cmd
        run: |
          @echo off
          setlocal enabledelayedexpansion

          set "UNITY_BASE=C:\Program Files\Unity\Hub\Editor"
          set "VERSION_PATTERN=${{ inputs.unity-version }}"

          echo Searching for Unity %VERSION_PATTERN%.x in %UNITY_BASE%...

          set "UNITY_DIR="
          for /d %%d in ("%UNITY_BASE%\%VERSION_PATTERN%*") do (
            set "UNITY_DIR=%%d"
          )

          if not defined UNITY_DIR (
            echo ::error::Unity %VERSION_PATTERN%.x not found
            echo Available versions:
            dir /b "%UNITY_BASE%" 2>nul
            exit /b 1
          )

          set "UNITY_PATH=%UNITY_DIR%\Editor\Unity.exe"

          if not exist "%UNITY_PATH%" (
            echo ::error::Unity executable not found at %UNITY_PATH%
            exit /b 1
          )

          for %%i in ("%UNITY_DIR%") do set "DETECTED_VERSION=%%~nxi"
          echo Found Unity %DETECTED_VERSION%
          echo   Path: %UNITY_PATH%

          echo UNITY_PATH=%UNITY_PATH%>> %GITHUB_OUTPUT%
          echo UNITY_VERSION=%DETECTED_VERSION%>> %GITHUB_OUTPUT%

      - name: Set Unity Outputs
        id: unity
        shell: bash
        run: |
          if [ "${{ inputs.os }}" = "macos" ]; then
            echo "UNITY_PATH=${{ steps.unity-macos.outputs.UNITY_PATH }}" >> $GITHUB_OUTPUT
            echo "UNITY_VERSION=${{ steps.unity-macos.outputs.UNITY_VERSION }}" >> $GITHUB_OUTPUT
          else
            echo "UNITY_PATH=${{ steps.unity-windows.outputs.UNITY_PATH }}" >> $GITHUB_OUTPUT
            echo "UNITY_VERSION=${{ steps.unity-windows.outputs.UNITY_VERSION }}" >> $GITHUB_OUTPUT
          fi

      # =====================================================
      # BuildConfig 버전 업데이트 (선택적)
      # =====================================================
      - name: Update BuildConfig SDK Version
        if: inputs.web-framework-version != ''
        shell: bash
        run: |
          VERSION="${{ inputs.web-framework-version }}"
          BUILD_CONFIG_DIR="WebGLTemplates/AITTemplate/BuildConfig~"
          BUILD_CONFIG="${BUILD_CONFIG_DIR}/package.json"
          LOCK_FILE="${BUILD_CONFIG_DIR}/pnpm-lock.yaml"

          echo "Updating @apps-in-toss/web-framework to ${VERSION}"

          # sed로 버전 업데이트 (macOS/Windows 호환)
          if [ "${{ inputs.os }}" = "macos" ]; then
            sed -i '' 's/"@apps-in-toss\/web-framework": "[^"]*"/"@apps-in-toss\/web-framework": "'"$VERSION"'"/' "$BUILD_CONFIG"
          else
            sed -i 's/"@apps-in-toss\/web-framework": "[^"]*"/"@apps-in-toss\/web-framework": "'"$VERSION"'"/' "$BUILD_CONFIG"
          fi

          echo "Updated BuildConfig:"
          cat "$BUILD_CONFIG"

          # pnpm-lock.yaml 삭제 후 재생성 (frozen-lockfile 호환성 유지)
          rm -f "$LOCK_FILE"
          echo "Regenerating pnpm-lock.yaml..."
          cd "$BUILD_CONFIG_DIR"
          pnpx pnpm@9 install --lockfile-only
          echo "pnpm-lock.yaml regenerated"

      # =====================================================
      # Windows: Unity License Client 대기
      # =====================================================
      - name: Wait for Unity License Client (Windows)
        if: inputs.os == 'windows' && inputs.run-build
        shell: powershell -ExecutionPolicy Bypass -File {0}
        run: |
          $targetVersion = "${{ inputs.unity-version }}"
          $maxWait = 60
          $interval = 10
          $waited = 0

          Write-Host "Checking for conflicting Unity License Client processes..."

          while ($waited -lt $maxWait) {
            $otherClients = Get-Process -Name "Unity.Licensing.Client" -ErrorAction SilentlyContinue |
              Where-Object { $_.Path -notlike "*$targetVersion*" }

            if (-not $otherClients) {
              Write-Host "No conflicting License Client found"
              break
            }

            Write-Host "Found License Client from other Unity version, waiting... ($waited/$maxWait sec)"
            foreach ($proc in $otherClients) {
              Write-Host "  - PID: $($proc.Id), Path: $($proc.Path)"
            }
            Start-Sleep -Seconds $interval
            $waited += $interval
          }

          $otherClients = Get-Process -Name "Unity.Licensing.Client" -ErrorAction SilentlyContinue |
            Where-Object { $_.Path -notlike "*$targetVersion*" }

          if ($otherClients) {
            Write-Host "::warning::Killing stale License Client processes after ${maxWait}s timeout..."
            foreach ($proc in $otherClients) {
              Write-Host "  Killing PID: $($proc.Id), Path: $($proc.Path)"
              Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
            }
            Start-Sleep -Seconds 2
          }

          Write-Host "License Client check completed"

      # =====================================================
      # 광고 ID 치환 (빌드 전)
      # =====================================================
      - name: Inject Ad IDs (macOS)
        if: inputs.os == 'macos' && inputs.run-build
        env:
          AIT_AD_INTERSTITIAL_ID: ${{ secrets.AIT_AD_INTERSTITIAL_ID }}
          AIT_AD_REWARDED_ID: ${{ secrets.AIT_AD_REWARDED_ID }}
        run: |
          AD_TESTER="Tests~/E2E/SharedScripts/Runtime/AdV2Tester.cs"

          # SharedScripts가 없으면 스킵 (릴리즈 빌드에서는 제거됨)
          if [ ! -f "$AD_TESTER" ]; then
            echo "SharedScripts not found (release build), skipping ad ID injection"
            exit 0
          fi

          if [ -n "$AIT_AD_INTERSTITIAL_ID" ]; then
            echo "Injecting interstitial ad ID..."
            sed -i '' 's/ait-ad-test-interstitial-id/'"$AIT_AD_INTERSTITIAL_ID"'/g' "$AD_TESTER"
          fi

          if [ -n "$AIT_AD_REWARDED_ID" ]; then
            echo "Injecting rewarded ad ID..."
            sed -i '' 's/ait-ad-test-rewarded-id/'"$AIT_AD_REWARDED_ID"'/g' "$AD_TESTER"
          fi

          echo "Ad IDs injected successfully"

      - name: Inject Ad IDs (Windows)
        if: inputs.os == 'windows' && inputs.run-build
        shell: powershell
        env:
          AIT_AD_INTERSTITIAL_ID: ${{ secrets.AIT_AD_INTERSTITIAL_ID }}
          AIT_AD_REWARDED_ID: ${{ secrets.AIT_AD_REWARDED_ID }}
        run: |
          $adTester = "Tests~\E2E\SharedScripts\Runtime\AdV2Tester.cs"

          # SharedScripts가 없으면 스킵 (릴리즈 빌드에서는 제거됨)
          if (-not (Test-Path $adTester)) {
            Write-Host "SharedScripts not found (release build), skipping ad ID injection"
            exit 0
          }

          $content = Get-Content $adTester -Raw

          if ($env:AIT_AD_INTERSTITIAL_ID) {
            Write-Host "Injecting interstitial ad ID..."
            $content = $content -replace 'ait-ad-test-interstitial-id', $env:AIT_AD_INTERSTITIAL_ID
          }

          if ($env:AIT_AD_REWARDED_ID) {
            Write-Host "Injecting rewarded ad ID..."
            $content = $content -replace 'ait-ad-test-rewarded-id', $env:AIT_AD_REWARDED_ID
          }

          Set-Content $adTester -Value $content -NoNewline
          Write-Host "Ad IDs injected successfully"

      # =====================================================
      # Unity WebGL 빌드
      # =====================================================
      - name: Build Unity WebGL (macOS)
        if: inputs.os == 'macos' && inputs.run-build
        uses: nick-invision/retry@v3
        env:
          AIT_DEBUG_CONSOLE: "true"
        with:
          timeout_minutes: 30
          max_attempts: 3
          retry_wait_seconds: 30
          shell: bash
          command: |
            UNITY_PATH="${{ steps.unity.outputs.UNITY_PATH }}"
            PROJECT_PATH="${{ github.workspace }}/Tests~/E2E/SampleUnityProject-${{ inputs.unity-version }}"

            echo "Unity Version: ${{ steps.unity.outputs.UNITY_VERSION }}"
            echo "Unity Path: ${UNITY_PATH}"
            echo "Project Path: ${PROJECT_PATH}"

            "$UNITY_PATH" -quit -batchmode -nographics \
              -projectPath "$PROJECT_PATH" \
              -executeMethod E2EBuildRunner.CommandLineBuild \
              -buildTarget WebGL \
              -logFile -

      - name: Build Unity WebGL (Windows)
        if: inputs.os == 'windows' && inputs.run-build
        uses: nick-invision/retry@v3
        env:
          AIT_DEBUG_CONSOLE: "true"
        with:
          timeout_minutes: 30
          max_attempts: 3
          retry_wait_seconds: 30
          shell: powershell
          command: |
            $unityPath = "${{ steps.unity.outputs.UNITY_PATH }}"
            $projectPath = "${{ github.workspace }}\Tests~\E2E\SampleUnityProject-${{ inputs.unity-version }}"

            Write-Host "Unity Version: ${{ steps.unity.outputs.UNITY_VERSION }}"
            Write-Host "Unity Path: $unityPath"
            Write-Host "Project Path: $projectPath"

            $logFile = "$env:TEMP\unity-build-${{ inputs.unity-version }}.log"
            Write-Host "Starting Unity build..."
            Write-Host "Log file: $logFile"

            $unityProcess = Start-Process -FilePath $unityPath -ArgumentList @(
              "-quit", "-batchmode", "-nographics",
              "-projectPath", $projectPath,
              "-executeMethod", "E2EBuildRunner.CommandLineBuild",
              "-buildTarget", "WebGL",
              "-logFile", $logFile
            ) -PassThru -NoNewWindow

            Write-Host "Waiting for Unity build to complete..."
            $lastSize = 0
            while (-not $unityProcess.HasExited) {
              Start-Sleep -Seconds 2
              if (Test-Path $logFile) {
                $content = Get-Content $logFile -Raw -ErrorAction SilentlyContinue
                if ($content -and $content.Length -gt $lastSize) {
                  $newContent = $content.Substring($lastSize)
                  Write-Host $newContent
                  $lastSize = $content.Length
                }
              }
            }

            if (Test-Path $logFile) {
              $content = Get-Content $logFile -Raw -ErrorAction SilentlyContinue
              if ($content -and $content.Length -gt $lastSize) {
                Write-Host $content.Substring($lastSize)
              }
            }

            $exitCode = $unityProcess.ExitCode
            if ($null -ne $exitCode -and $exitCode -ne 0) {
              Write-Host "::error::Unity build failed with exit code: $exitCode"
              exit $exitCode
            }

            Write-Host "Unity build completed successfully (exit code: $exitCode)"

      # =====================================================
      # 빌드 출력 검증
      # =====================================================
      - name: Verify Build Output (macOS)
        if: inputs.os == 'macos' && inputs.run-build
        run: |
          DIST_PATH="Tests~/E2E/SampleUnityProject-${{ inputs.unity-version }}/ait-build/dist"
          AIT_BUILD_PATH="Tests~/E2E/SampleUnityProject-${{ inputs.unity-version }}/ait-build"

          if [ ! -d "$DIST_PATH" ]; then
            echo "::error::Build output not found at $DIST_PATH"
            exit 1
          fi

          echo "dist/ folder verified"
          ls -la "$DIST_PATH"

          AIT_FILE=$(find "$DIST_PATH" -maxdepth 1 -name "*.ait" -type f 2>/dev/null | head -1)
          if [ -z "$AIT_FILE" ]; then
            AIT_FILE=$(find "$AIT_BUILD_PATH" -maxdepth 1 -name "*.ait" -type f 2>/dev/null | head -1)
          fi

          if [ -z "$AIT_FILE" ]; then
            echo "::error::.ait file not generated"
            ls -la "$AIT_BUILD_PATH"
            exit 1
          fi

          echo ".ait file verified: $AIT_FILE"

      - name: Verify Build Output (Windows)
        if: inputs.os == 'windows' && inputs.run-build
        shell: cmd
        run: |
          @echo off
          setlocal enabledelayedexpansion
          set "DIST_PATH=Tests~\E2E\SampleUnityProject-${{ inputs.unity-version }}\ait-build\dist"
          set "AIT_BUILD_PATH=Tests~\E2E\SampleUnityProject-${{ inputs.unity-version }}\ait-build"

          if not exist "%DIST_PATH%" (
            echo ::error::Build output not found at %DIST_PATH%
            exit /b 1
          )

          echo dist\ folder verified
          dir "%DIST_PATH%"

          set "AIT_FILE="
          for %%f in ("%DIST_PATH%\*.ait") do (
            set "AIT_FILE=%%f"
            goto :found_ait
          )
          for %%f in ("%AIT_BUILD_PATH%\*.ait") do (
            set "AIT_FILE=%%f"
            goto :found_ait
          )

          echo ::error::.ait file not generated
          dir "%AIT_BUILD_PATH%"
          exit /b 1

          :found_ait
          echo .ait file verified: !AIT_FILE!

      # =====================================================
      # 아티팩트 업로드
      # =====================================================
      - name: Set Artifact Name
        id: artifact
        shell: bash
        run: |
          SDK_VERSION="${{ inputs.sdk-version }}"
          if [ -n "$SDK_VERSION" ]; then
            echo "name=ait-build-${{ inputs.os }}-${{ inputs.unity-version }}-v${SDK_VERSION}" >> $GITHUB_OUTPUT
          else
            echo "name=ait-build-${{ inputs.os }}-${{ inputs.unity-version }}" >> $GITHUB_OUTPUT
          fi

      - name: Upload AIT Build
        if: inputs.run-build
        uses: actions/upload-artifact@v6
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: |
            Tests~/E2E/SampleUnityProject-${{ inputs.unity-version }}/ait-build/dist/
            Tests~/E2E/SampleUnityProject-${{ inputs.unity-version }}/ait-build/*.ait
            Tests~/E2E/SampleUnityProject-${{ inputs.unity-version }}/ait-build/package.json
            Tests~/E2E/SampleUnityProject-${{ inputs.unity-version }}/ait-build/pnpm-lock.yaml
            Tests~/E2E/SampleUnityProject-${{ inputs.unity-version }}/ait-build/granite.config.ts
          if-no-files-found: error
          retention-days: 7

      # =====================================================
      # E2E 테스트 (선택적)
      # =====================================================
      - name: Setup Node.js
        if: inputs.run-e2e-test
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Install Playwright Dependencies (macOS)
        if: inputs.os == 'macos' && inputs.run-e2e-test
        working-directory: Tests~/E2E/tests
        run: |
          rm -rf node_modules package-lock.json pnpm-lock.yaml
          pnpm install
          pnpx playwright install chromium --with-deps
          pnpx playwright --version

      - name: Install Playwright Dependencies (Windows)
        if: inputs.os == 'windows' && inputs.run-e2e-test
        working-directory: Tests~/E2E/tests
        shell: powershell
        env:
          # Use job-local Playwright cache to avoid race conditions between parallel runners
          PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}\.playwright-browsers
        run: |
          # Clean node_modules and lock files
          if (Test-Path node_modules) { Remove-Item -Recurse -Force node_modules }
          if (Test-Path package-lock.json) { Remove-Item -Force package-lock.json }
          if (Test-Path pnpm-lock.yaml) { Remove-Item -Force pnpm-lock.yaml }

          # Clean job-local Playwright cache
          if (Test-Path $env:PLAYWRIGHT_BROWSERS_PATH) {
            Write-Host "Cleaning job-local Playwright cache: $env:PLAYWRIGHT_BROWSERS_PATH"
            Remove-Item -Recurse -Force $env:PLAYWRIGHT_BROWSERS_PATH
          }

          pnpm install
          pnpx playwright install chromium --with-deps
          pnpx playwright --version

      - name: Run E2E Tests (macOS - Full)
        if: inputs.os == 'macos' && inputs.run-e2e-test
        working-directory: Tests~/E2E/tests
        env:
          UNITY_PROJECT_PATH: ${{ github.workspace }}/Tests~/E2E/SampleUnityProject-${{ inputs.unity-version }}
          MOBILE_EMULATION: "true"
        run: pnpm test

      - name: Run E2E Tests (Windows - 1-5 only)
        if: inputs.os == 'windows' && inputs.run-e2e-test
        working-directory: Tests~/E2E/tests
        shell: powershell
        env:
          UNITY_PROJECT_PATH: ${{ github.workspace }}\Tests~\E2E\SampleUnityProject-${{ inputs.unity-version }}
          # Use job-local Playwright cache to avoid race conditions between parallel runners
          PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}\.playwright-browsers
        run: pnpx playwright test --grep "[1-5]\. "

      # =====================================================
      # 벤치마크 결과 업로드 (선택적)
      # =====================================================
      - name: Upload Benchmark Results
        if: inputs.run-benchmark && inputs.os == 'macos'
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-results-${{ inputs.os }}-${{ inputs.unity-version }}
          path: Tests~/E2E/tests/benchmark-results.json
          if-no-files-found: ignore

      - name: Upload Playwright Report
        if: inputs.run-e2e-test && always()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-report-${{ inputs.os }}-${{ inputs.unity-version }}
          path: Tests~/E2E/tests/playwright-report/
          if-no-files-found: ignore
          compression-level: 9
          retention-days: 7
