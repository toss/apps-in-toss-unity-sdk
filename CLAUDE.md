# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## âš ï¸ Critical Rules

### Git Commit Guidelines
- **ALL commit messages MUST be written in Korean (í•œêµ­ì–´)**
- Commit message format: `<íƒ€ì…>: <ì„¤ëª…>`
  - íƒ€ì… ì˜ˆì‹œ: ê¸°ëŠ¥, ìˆ˜ì •, ê°œì„ , ë¬¸ì„œ, ë¦¬íŒ©í† ë§, í…ŒìŠ¤íŠ¸, ë¹Œë“œ
- Examples:
  - âœ… `ê¸°ëŠ¥: ì‚¬ìš©ì ì¸ì¦ API ì¶”ê°€`
  - âœ… `ìˆ˜ì •: WebGL ë¹Œë“œ ì˜¤ë¥˜ í•´ê²°`
  - âŒ `feat: Add user authentication API` (English - NOT ALLOWED)

### Documentation Generation Policy
- **NEVER create or modify *.md files without explicit user permission**
- This includes but not limited to:
  - README.md, CHANGELOG.md, CONTRIBUTING.md
  - PRD.md, USER_GUIDE.md, API.md
  - Any other markdown documentation files
- **Exception**: You may update CLAUDE.md when explicitly instructed
- **Rationale**: AI-generated documentation may appear unprofessional or inappropriate for corporate repositories

### Repository Ownership
- This is a **proprietary corporate repository** (not open source)
- Do not add LICENSE files or open source licensing information
- Do not add package.json "license" fields

### Auto-Generated Code Policy
- **NEVER directly modify files in `Runtime/SDK/` directory**
- All files in `Runtime/SDK/` are auto-generated by `sdk-runtime-generator~/`
- To fix bugs or make changes:
  1. Modify the generator code in `sdk-runtime-generator~/`
  2. Run `pnpm run generate` to regenerate SDK files
  3. Verify changes with `./run-local-tests.sh --all`
- Direct edits to generated files will be overwritten on next generation

### File Hygiene
- **Proactively add unnecessary files to .gitignore** when discovered
- Common files to ignore:
  - Unity: `Library/`, `Temp/`, `Logs/`, `UserSettings/`, `*.csproj`, `*.sln`
  - Build artifacts: `ait-build/`, `webgl/`, `dist/`, `node_modules/`
  - Logs: `*.log`, `*.log.meta`
  - IDE: `.idea/`, `.vscode/`, `*.swp`
- When you see untracked files that should not be committed, add them to the appropriate `.gitignore` file

## Overview

This is the **Apps in Toss Unity SDK** - a Unity package that enables Unity/Tuanjie engine game projects to be converted and deployed as mini-apps on the Apps in Toss platform. The SDK provides:

- WebGL build automation with Apps in Toss platform optimization
- Unity Editor integration with a custom Build & Deploy window
- Custom WebGL template (AITTemplate) with platform-specific bridge code
- Vite-based build pipeline using granite build system
- Comprehensive C# API for platform features (payments, user auth, device APIs, etc.)

## Project Structure

```
apps-in-toss-unity-sdk/
â”œâ”€â”€ Runtime/                          # Runtime SDK code
â”‚   â””â”€â”€ SDK/                          # Auto-generated SDK API files
â”‚       â”œâ”€â”€ AITCore.cs               # Core infrastructure (jslib bridge)
â”‚       â””â”€â”€ AIT.*.cs                 # Individual API methods
â”œâ”€â”€ Editor/                           # Unity Editor scripts
â”‚   â”œâ”€â”€ AppsInTossBuildWindow.cs     # Main build & deploy UI window
â”‚   â”œâ”€â”€ AITConvertCore.cs            # Core build pipeline logic
â”‚   â”œâ”€â”€ AITNodeJSDownloader.cs       # Embedded Node.js installer
â”‚   â””â”€â”€ AITEditorScriptObject.cs     # Configuration ScriptableObject
â”œâ”€â”€ WebGLTemplates/                   # Unity WebGL templates
â”‚   â””â”€â”€ AITTemplate/                  # Template for Unity 2021.3+
â”‚       â”œâ”€â”€ index.html               # Template HTML with placeholders
â”‚       â”œâ”€â”€ Runtime/                 # Platform bridge JavaScript
â”‚       â”‚   â””â”€â”€ appsintoss-unity-bridge.js
â”‚       â””â”€â”€ BuildConfig/             # Vite build configuration
â”‚           â”œâ”€â”€ package.json         # npm dependencies
â”‚           â”œâ”€â”€ vite.config.ts       # Vite configuration
â”‚           â””â”€â”€ granite.config.ts    # Granite build config
â”œâ”€â”€ Tools~/                           # Development tools (excluded from UPM)
â”‚   â””â”€â”€ NodeJS/                      # Embedded Node.js (auto-downloaded)
â”œâ”€â”€ Tests~/                           # Test files (excluded from UPM)
â”‚   â””â”€â”€ E2E/                         # E2E benchmark tests
â””â”€â”€ sdk-runtime-generator~/           # SDK code generator (excluded from UPM)
```

**Note**: Directories with `~` suffix are excluded from Unity Package Manager distribution.

## Build Pipeline Architecture

The SDK uses a **two-phase build system**:

### Phase 1: Unity WebGL Build
1. `AITConvertCore.Init()` configures Unity PlayerSettings:
   - Sets WebGL template to `PROJECT:AITTemplate`
   - Disables compression (required by Apps in Toss)
   - Optimizes memory and threading for mobile browsers
2. `BuildWebGL()` executes Unity's BuildPipeline to `webgl/` folder
3. Produces standard Unity WebGL output with custom template

### Phase 2: Granite Build (Packaging)
1. `PackageWebGLBuild()` creates `ait-build/` directory
2. **Copies BuildConfig** from `WebGLTemplates/AITTemplate/BuildConfig/`:
   - `package.json`, `vite.config.ts`, `tsconfig.json` (no substitution)
   - `granite.config.ts` (with placeholder substitution for app metadata)
3. **Copies WebGL build** to proper structure:
   - `index.html` â†’ project root (with Unity placeholder substitution)
   - `Build/`, `TemplateData/`, `Runtime/` â†’ `public/` folder
4. **Runs npm install** (only if `node_modules/` doesn't exist)
5. **Runs `npm run build`** which executes `granite build`:
   - Generates final deployable package in `ait-build/dist/`

### Placeholder Substitution

Two types of placeholders are replaced during the build:

**In index.html (Unity placeholders):**
- `%UNITY_WEB_NAME%`, `%UNITY_COMPANY_NAME%`, etc. â†’ Unity PlayerSettings values
- `%UNITY_WEBGL_LOADER_FILENAME%`, etc. â†’ Actual WebGL build filenames
- `%AIT_IS_PRODUCTION%` â†’ "true" or "false" based on config

**In granite.config.ts (Apps in Toss placeholders):**
- `%AIT_APP_NAME%` â†’ App ID from config
- `%AIT_DISPLAY_NAME%` â†’ Display name from config
- `%AIT_PRIMARY_COLOR%` â†’ Brand color from config
- `%AIT_ICON_URL%` â†’ App icon URL (required field)
- `%AIT_LOCAL_PORT%` â†’ Dev server port

## Key Commands

### Development
The SDK is a Unity package - there are no traditional build/test commands. Development happens within Unity Editor:

1. **Open in Unity**: Load the package in a Unity project via Package Manager
2. **Access Build Window**: Unity menu `Apps in Toss > Build & Deploy Window`
3. **Run Build**: Click "ğŸš€ Build & Package" in the window

### Testing Build Pipeline
To test the build pipeline without Unity:

```bash
# Navigate to build output
cd ait-build/

# Install dependencies (first time only)
npm install

# Run dev server
npm run dev

# Build for production
npm run build

# Deploy to Apps in Toss
npm run deploy
```

### Unity Version Requirements

**Primary Supported Versions (ìš°ì„  ì§€ì› ë²„ì „):**
- Unity 6000.2.14f1 (Unity 6 LTS)
- Unity 6000.0.63f1 (Unity 6)
- Unity 2022.3.62f3 (LTS)
- Unity 2021.3.45f2 (LTS - ìµœì†Œ ì§€ì› ë²„ì „)

All development, testing, and QA should prioritize these 4 versions.

- Tuanjie Engine supported

**IMPORTANT**: The SDK must support Unity 2021.3 and all higher versions.

## Important Implementation Details

### WebGL Template System
Unity WebGL template is in `WebGLTemplates/AITTemplate/`. The template is automatically:
1. Copied to Unity project's `Assets/WebGLTemplates/` on first use
2. Selected in PlayerSettings as `PROJECT:AITTemplate`
3. Used during WebGL build to inject Apps in Toss bridge code

### Build Settings Auto-Configuration
`AITConvertCore.Init()` automatically configures optimal settings:
- **Compression**: Disabled (Apps in Toss requirement)
- **Threading**: Disabled (mobile browser compatibility)
- **Memory**: 512MB for Unity 2022.3, 1024MB for Unity 6
- **Data caching**: Disabled
- **Linker target**: Wasm

### Embedded Node.js System
The SDK uses embedded Node.js with automatic download:
1. First checks system Node.js installation
2. Falls back to `Tools~/NodeJS/{platform}/` embedded version
3. Auto-downloads with SHA256 checksum verification

**Download sources (fallback order):**
1. https://nodejs.org (official)
2. https://cdn.npmmirror.com
3. https://repo.huaweicloud.com

**Node.js version**: v24.11.1 (checksums in `Editor/AITNodeJSDownloader.cs`)

### Configuration Storage
Settings are stored in `Assets/AppsInToss/Editor/AITConfig.asset` (ScriptableObject):
- App metadata (name, version, description, icon URL)
- Build settings (production mode, optimization flags)
- Branding (primary color, icon URL)
- Deployment key (for `ait deploy`)

**Critical**: The icon URL (`config.iconUrl`) is mandatory for builds.

## SDK Runtime Generator

Auto-generates C# SDK code from TypeScript definitions in `@apps-in-toss/web-framework`.

### Workflow
```bash
cd sdk-runtime-generator~
pnpm install
pnpm generate   # TypeScript â†’ C# + JavaScript bridge (~1.5s)
pnpm format     # CSharpier formatting (optional, requires dotnet)
pnpm validate   # Compile check with Mono mcs
pnpm test       # Run unit tests
```

### Type Mapping
| TypeScript | C# |
|------------|-----|
| `string` | `string` |
| `number` | `double` |
| `boolean` | `bool` |
| `Promise<T>` | `System.Action<T>` callback |
| `T \| U` | Discriminated union class |

## Testing Strategy

### E2E Benchmark Tests
The SDK uses an E2E-focused testing strategy with Playwright:

```
Tests~/E2E/
â”œâ”€â”€ SampleUnityProject/           # Minimal Unity project for testing
â”‚   â”œâ”€â”€ Assets/
â”‚   â”‚   â”œâ”€â”€ Scripts/
â”‚   â”‚   â”‚   â”œâ”€â”€ AutoBenchmarkRunner.cs  # Benchmark data collection
â”‚   â”‚   â”‚   â””â”€â”€ RuntimeAPITester.cs     # SDK API testing
â”‚   â”‚   â””â”€â”€ Editor/
â”‚   â”‚       â””â”€â”€ E2EBuildRunner.cs       # CLI build automation
â”‚   â””â”€â”€ ait-build/dist/           # Built artifacts (gitignored)
â””â”€â”€ tests/
    â”œâ”€â”€ e2e-full-pipeline.test.js # Playwright E2E tests (7 tests)
    â”œâ”€â”€ playwright.config.ts
    â””â”€â”€ benchmark-results.json    # Test results
```

### Running Tests

**Local test runner:**
```bash
./run-local-tests.sh --help     # Show options
./run-local-tests.sh --validate # Quick validation only
./run-local-tests.sh --all      # Full Unity build + E2E tests
./run-local-tests.sh --e2e      # E2E tests only (requires existing build)
```

**Manual Playwright execution:**
```bash
cd Tests~/E2E/tests
npm install
npx playwright install chromium
npm test
```

### CI/CD Integration

`.github/workflows/tests.yml` runs:
1. Unity WebGL build via game-ci/unity-builder
2. Playwright E2E tests (7 tests)
3. Benchmark results uploaded as artifacts
4. Job summary with performance metrics

