# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## ‚ö†Ô∏è Critical Rules

### Git Commit Guidelines
- **ALL commit messages MUST be written in Korean (ÌïúÍµ≠Ïñ¥)**
- Commit message format: `<ÌÉÄÏûÖ>: <ÏÑ§Î™Ö>`
  - ÌÉÄÏûÖ ÏòàÏãú: Í∏∞Îä•, ÏàòÏ†ï, Í∞úÏÑ†, Î¨∏ÏÑú, Î¶¨Ìå©ÌÜ†ÎßÅ, ÌÖåÏä§Ìä∏, ÎπåÎìú
- Examples:
  - ‚úÖ `Í∏∞Îä•: ÏÇ¨Ïö©Ïûê Ïù∏Ï¶ù API Ï∂îÍ∞Ä`
  - ‚úÖ `ÏàòÏ†ï: WebGL ÎπåÎìú Ïò§Î•ò Ìï¥Í≤∞`
  - ‚ùå `feat: Add user authentication API` (English - NOT ALLOWED)

### Documentation Generation Policy
- **NEVER create or modify *.md files without explicit user permission**
- This includes but not limited to:
  - README.md, CHANGELOG.md, CONTRIBUTING.md
  - PRD.md, USER_GUIDE.md, API.md
  - Any other markdown documentation files
- **Exception**: You may update CLAUDE.md when explicitly instructed
- **Rationale**: AI-generated documentation may appear unprofessional or inappropriate for corporate repositories

### Repository Ownership
- This is a **proprietary corporate repository** (not open source)
- Do not add LICENSE files or open source licensing information
- Do not add package.json "license" fields

### Auto-Generated Code Policy
- **NEVER directly modify files in `Runtime/SDK/` directory**
- All files in `Runtime/SDK/` are auto-generated by `sdk-runtime-generator~/`
- To fix bugs or make changes:
  1. Modify the generator code in `sdk-runtime-generator~/`
  2. Run `pnpm run generate` to regenerate SDK files
  3. Verify changes with `./run-local-tests.sh --all`
- Direct edits to generated files will be overwritten on next generation

### File Hygiene
- **Proactively add unnecessary files to .gitignore** when discovered
- Common files to ignore:
  - Unity: `Library/`, `Temp/`, `Logs/`, `UserSettings/`, `*.csproj`, `*.sln`
  - Build artifacts: `ait-build/`, `webgl/`, `dist/`, `node_modules/`
  - Logs: `*.log`, `*.log.meta`
  - IDE: `.idea/`, `.vscode/`, `*.swp`
- When you see untracked files that should not be committed, add them to the appropriate `.gitignore` file

## Overview

This is the **Apps in Toss Unity SDK** - a Unity package that enables Unity/Tuanjie engine game projects to be converted and deployed as mini-apps on the Apps in Toss platform. The SDK provides:

- WebGL build automation with Apps in Toss platform optimization
- Unity Editor integration with a custom Build & Deploy window
- Custom WebGL template (AITTemplate) with platform-specific bridge code
- Vite-based build pipeline using granite build system
- Comprehensive C# API for platform features (payments, user auth, device APIs, etc.)

## Project Structure

```
apps-in-toss-unity-sdk/
‚îú‚îÄ‚îÄ Runtime/                          # Runtime SDK code
‚îÇ   ‚îî‚îÄ‚îÄ SDK/                          # Auto-generated SDK API files
‚îÇ       ‚îú‚îÄ‚îÄ AITCore.cs               # Core infrastructure (jslib bridge)
‚îÇ       ‚îî‚îÄ‚îÄ AIT.*.cs                 # Individual API methods
‚îú‚îÄ‚îÄ Editor/                           # Unity Editor scripts
‚îÇ   ‚îú‚îÄ‚îÄ AppsInTossBuildWindow.cs     # Main build & deploy UI window
‚îÇ   ‚îú‚îÄ‚îÄ AITConvertCore.cs            # Core build pipeline logic
‚îÇ   ‚îú‚îÄ‚îÄ AITNodeJSDownloader.cs       # Embedded Node.js installer
‚îÇ   ‚îî‚îÄ‚îÄ AITEditorScriptObject.cs     # Configuration ScriptableObject
‚îú‚îÄ‚îÄ WebGLTemplates/                   # Unity WebGL templates
‚îÇ   ‚îî‚îÄ‚îÄ AITTemplate/                  # Template for Unity 2021.3+
‚îÇ       ‚îú‚îÄ‚îÄ index.html               # Template HTML with placeholders
‚îÇ       ‚îú‚îÄ‚îÄ Runtime/                 # Platform bridge JavaScript
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ appsintoss-unity-bridge.js
‚îÇ       ‚îî‚îÄ‚îÄ BuildConfig/             # Vite build configuration
‚îÇ           ‚îú‚îÄ‚îÄ package.json         # npm dependencies
‚îÇ           ‚îú‚îÄ‚îÄ vite.config.ts       # Vite configuration
‚îÇ           ‚îî‚îÄ‚îÄ granite.config.ts    # Granite build config
‚îú‚îÄ‚îÄ Tools~/                           # Development tools (excluded from UPM)
‚îÇ   ‚îî‚îÄ‚îÄ NodeJS/                      # Embedded Node.js (auto-downloaded)
‚îú‚îÄ‚îÄ Tests~/                           # Test files (excluded from UPM)
‚îÇ   ‚îî‚îÄ‚îÄ E2E/                         # E2E benchmark tests
‚îî‚îÄ‚îÄ sdk-runtime-generator~/           # SDK code generator (excluded from UPM)
```

**Note**: Directories with `~` suffix are excluded from Unity Package Manager distribution.

## Build Pipeline Architecture

The SDK uses a **two-phase build system**:

### Phase 1: Unity WebGL Build
1. `AITConvertCore.Init()` configures Unity PlayerSettings:
   - Sets WebGL template to `PROJECT:AITTemplate`
   - Disables compression (required by Apps in Toss)
   - Optimizes memory and threading for mobile browsers
2. `BuildWebGL()` executes Unity's BuildPipeline to `webgl/` folder
3. Produces standard Unity WebGL output with custom template

### Phase 2: Granite Build (Packaging)
1. `PackageWebGLBuild()` creates `ait-build/` directory
2. **Copies BuildConfig** from `WebGLTemplates/AITTemplate/BuildConfig/`:
   - `package.json`, `vite.config.ts`, `tsconfig.json` (no substitution)
   - `granite.config.ts` (with placeholder substitution for app metadata)
3. **Copies WebGL build** to proper structure:
   - `index.html` ‚Üí project root (with Unity placeholder substitution)
   - `Build/`, `TemplateData/`, `Runtime/` ‚Üí `public/` folder
4. **Runs npm install** (only if `node_modules/` doesn't exist)
5. **Runs `npm run build`** which executes `granite build`:
   - Generates final deployable package in `ait-build/dist/`

### Placeholder Substitution

Two types of placeholders are replaced during the build:

**In index.html (Unity placeholders):**
- `%UNITY_WEB_NAME%`, `%UNITY_COMPANY_NAME%`, etc. ‚Üí Unity PlayerSettings values
- `%UNITY_WEBGL_LOADER_FILENAME%`, etc. ‚Üí Actual WebGL build filenames
- `%AIT_IS_PRODUCTION%` ‚Üí "true" or "false" based on config

**In granite.config.ts (Apps in Toss placeholders):**
- `%AIT_APP_NAME%` ‚Üí App ID from config
- `%AIT_DISPLAY_NAME%` ‚Üí Display name from config
- `%AIT_PRIMARY_COLOR%` ‚Üí Brand color from config
- `%AIT_ICON_URL%` ‚Üí App icon URL (required field)
- `%AIT_LOCAL_PORT%` ‚Üí Dev server port

## Key Commands

### Development
The SDK is a Unity package - there are no traditional build/test commands. Development happens within Unity Editor:

1. **Open in Unity**: Load the package in a Unity project via Package Manager
2. **Access Build Window**: Unity menu `Apps in Toss > Build & Deploy Window`
3. **Run Build**: Click "üöÄ Build & Package" in the window

### Testing Build Pipeline
To test the build pipeline without Unity:

```bash
# Navigate to build output
cd ait-build/

# Install dependencies (first time only)
npm install

# Run dev server
npm run dev

# Build for production
npm run build

# Deploy to Apps in Toss
npm run deploy
```

### Unity Version Requirements
- **Minimum**: Unity 2021.3 LTS
- **Recommended**: Unity 2022.3 LTS or higher
- **E2E Testing**: Unity 2021.3.45f1 to ensure backward compatibility
- Tuanjie Engine supported

**IMPORTANT**: The SDK must support Unity 2021.3 and all higher versions.

## Important Implementation Details

### WebGL Template System
Unity WebGL template is in `WebGLTemplates/AITTemplate/`. The template is automatically:
1. Copied to Unity project's `Assets/WebGLTemplates/` on first use
2. Selected in PlayerSettings as `PROJECT:AITTemplate`
3. Used during WebGL build to inject Apps in Toss bridge code

### Build Settings Auto-Configuration
`AITConvertCore.Init()` automatically configures optimal settings:
- **Compression**: Disabled (Apps in Toss requirement)
- **Threading**: Disabled (mobile browser compatibility)
- **Memory**: 512MB for Unity 2022.3, 1024MB for Unity 6
- **Data caching**: Disabled
- **Linker target**: Wasm

### Node.js/npm Detection
The SDK uses embedded Node.js with automatic download:
1. First checks system Node.js installation
2. Falls back to `Tools~/NodeJS/{platform}/` embedded version
3. Auto-downloads from nodejs.org with SHA256 checksum verification

See `Tools~/README.md` for details on the embedded Node.js system.

### Configuration Storage
Settings are stored in `Assets/AppsInToss/Editor/AITConfig.asset` (ScriptableObject):
- App metadata (name, version, description, icon URL)
- Build settings (production mode, optimization flags)
- Branding (primary color, icon URL)
- Deployment key (for `ait deploy`)

**Critical**: The icon URL (`config.iconUrl`) is mandatory for builds.

## SDK Runtime Generator

The `sdk-runtime-generator~/` directory contains tools for auto-generating C# SDK code from TypeScript definitions. This ensures the Unity SDK stays in sync with the web framework APIs.

Key files:
- `jslib.ts` - Generates the .jslib bridge file
- `csharp.ts` - Generates C# API wrapper classes
- `templates/` - Handlebars templates for code generation

To regenerate SDK code:
```bash
cd sdk-runtime-generator~
pnpm install
pnpm run generate
```

## Testing Strategy

### E2E Benchmark Tests
The SDK uses an E2E-focused testing strategy with Playwright:

```
Tests~/E2E/
‚îú‚îÄ‚îÄ SampleUnityProject/           # Minimal Unity project for testing
‚îÇ   ‚îú‚îÄ‚îÄ Assets/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Scripts/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AutoBenchmarkRunner.cs  # Benchmark data collection
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RuntimeAPITester.cs     # SDK API testing
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Editor/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ E2EBuildRunner.cs       # CLI build automation
‚îÇ   ‚îî‚îÄ‚îÄ ait-build/dist/           # Built artifacts (gitignored)
‚îî‚îÄ‚îÄ tests/
    ‚îú‚îÄ‚îÄ e2e-full-pipeline.test.js # Playwright E2E tests (7 tests)
    ‚îú‚îÄ‚îÄ playwright.config.ts
    ‚îî‚îÄ‚îÄ benchmark-results.json    # Test results
```

### Running Tests

**Local test runner:**
```bash
./run-local-tests.sh --help     # Show options
./run-local-tests.sh --validate # Quick validation only
./run-local-tests.sh --all      # Full Unity build + E2E tests
./run-local-tests.sh --e2e      # E2E tests only (requires existing build)
```

**Manual Playwright execution:**
```bash
cd Tests~/E2E/tests
npm install
npx playwright install chromium
npm test
```

### CI/CD Integration

`.github/workflows/tests.yml` runs:
1. Unity WebGL build via game-ci/unity-builder
2. Playwright E2E tests (7 tests)
3. Benchmark results uploaded as artifacts
4. Job summary with performance metrics

## Version Compatibility

**Supported Unity Versions**: Unity 2021.3 LTS and above

| Unity Version | WebGL Template | Memory | Compression |
|--------------|----------------|--------|-------------|
| 2021.3 LTS   | AITTemplate    | 512MB  | Disabled |
| 2022.3 LTS   | AITTemplate    | 512MB  | Disabled |
| 2023.3+ (Unity 6) | AITTemplate | 1024MB | Disabled |

**Note**: Compression must be Disabled for Apps in Toss deployment (platform requirement).

## File Naming Patterns

- Editor scripts: `AIT*.cs` (e.g., `AITConvertCore.cs`, `AITNodeJSDownloader.cs`)
- Runtime API: `AIT.*.cs` (e.g., `AIT.GetDeviceId.cs`, `AIT.CheckoutPayment.cs`)
- Core infrastructure: `AITCore.cs`
- Template: `WebGLTemplates/AITTemplate/`
- Build output: `webgl/` (Unity), `ait-build/` (package), `ait-build/dist/` (deployable)
- Config files: `AITConfig.asset`, `granite.config.ts`, `vite.config.ts`

## Apps in Toss Platform Integration

The SDK integrates with the Apps in Toss platform through:
1. **@apps-in-toss/web-framework** npm package (runtime framework)
2. **granite** build tool (converts Unity WebGL to mini-app format)
3. **ait deploy** CLI (uploads to platform)
4. **appsintoss-unity-bridge.js** (JavaScript bridge for Unity C# ‚Üî platform APIs)

The bridge enables bidirectional communication:
- Unity ‚Üí Platform: jslib calls invoke platform APIs via window object
- Platform ‚Üí Unity: JavaScript calls Unity game object methods

## Documentation Files

- `README.md` - User-facing documentation (Korean)
- `Tools~/README.md` - Embedded Node.js documentation
- `sdk-runtime-generator~/README.md` - SDK generator documentation
