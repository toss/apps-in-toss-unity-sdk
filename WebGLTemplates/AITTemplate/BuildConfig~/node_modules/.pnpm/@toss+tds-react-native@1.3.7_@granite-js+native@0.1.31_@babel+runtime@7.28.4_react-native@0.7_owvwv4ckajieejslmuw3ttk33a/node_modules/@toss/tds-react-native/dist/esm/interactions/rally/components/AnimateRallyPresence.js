"use strict";import{jsx as f,Fragment as C}from"react/jsx-runtime";import{Children as y,isValidElement as U,useEffect as R,useLayoutEffect as I,useMemo as w,useRef as a}from"react";import{useForceRerender as M}from"../hooks/utils/useForceRerender";import{useIsMounted as O}from"../hooks/utils/useIsMounted";import{PresenceChild as h}from"./PresenceChild";const s=n=>n.key||"",F=n=>{const i=[];return y.forEach(n,t=>{U(t)&&i.push(t)}),i},K=(n,i)=>{n.forEach(t=>{const m=s(t);i.set(m,t)})};export function AnimateRallyPresence(n){const i=O(),t=a(!0),{forceRerender:m}=M(),c=w(()=>F(n.children),[n.children]);let r=c;const u=a(r),o=a(new Set).current,d=a(new Map).current;if(I(()=>{t.current=!1,K(c,d),u.current=r},[d,r,c]),R(()=>()=>{t.current=!0,d.clear(),o.clear()},[]),t.current)return f(C,{children:r.map(e=>f(h,{present:!0,preserveUntilCompleteAll:n.preserveUntilCompleteAll,children:e},s(e)))});r=[...r];const p=u.current.map(s),x=c.map(s);for(let e=0;e<p.length;e+=1){const l=p[e];x.indexOf(l)===-1&&o.add(l)}return o.forEach(e=>{if(x.indexOf(e)!==-1)return;const l=d.get(e);if(!l)return;const E=p.indexOf(e),v=()=>{d.delete(e),o.delete(e);const A=u.current.findIndex(g=>g.key===e);if(u.current.splice(A,1),n.preserveUntilCompleteAll!==!0&&m(),o.size===0){if(u.current=c,i===!1)return;m(),n.onExitEnd!==void 0&&n.onExitEnd()}};r.splice(E,0,f(h,{present:!1,onExitEnd:v,preserveUntilCompleteAll:n.preserveUntilCompleteAll,children:l},s(l)))}),r=r.map(e=>{const l=e.key;return o.has(l)?e:f(h,{present:!0,preserveUntilCompleteAll:n.preserveUntilCompleteAll,children:e},s(e))}),f(C,{children:r})}
