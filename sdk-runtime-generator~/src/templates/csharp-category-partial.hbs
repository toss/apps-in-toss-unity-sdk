// -----------------------------------------------------------------------
// <copyright file="AIT.{{categoryName}}.cs" company="Toss">
//     Copyright (c) Toss. All rights reserved.
//     Apps in Toss Unity SDK - {{categoryName}} APIs
// </copyright>
// -----------------------------------------------------------------------

using System;
using System.Threading.Tasks;
using Newtonsoft.Json;
using UnityEngine.Scripting;

namespace AppsInToss
{
    /// <summary>
    /// Apps in Toss Platform API - {{categoryName}}
    /// </summary>
    public static partial class AIT
    {
{{#each apis}}
{{#if this.isEventSubscription}}
{{!-- Event subscription API (persistent callback pattern) --}}
{{#if this.description}}
        /// <summary>
        /// {{{this.description}}}
        /// </summary>
{{/if}}
        /// <param name="onEvent">Event callback when the event is triggered</param>
        /// <param name="onError">Error callback (optional)</param>
        /// <returns>Action to call for unsubscribing from the event</returns>
        [Preserve]
        [APICategory("{{../categoryName}}")]
{{#if this.hasEventData}}
        public static Action {{this.pascalName}}(
            Action<{{this.eventDataType}}> onEvent,
            Action<AITException> onError = null)
{{else}}
        public static Action {{this.pascalName}}(
            Action onEvent,
            Action<AITException> onError = null)
{{/if}}
        {
#if UNITY_WEBGL && !UNITY_EDITOR
{{#if this.hasEventData}}
            string subscriptionId = AITCore.Instance.RegisterSubscriptionCallback<{{this.eventDataType}}>(
                onEvent,
                onError
            );
            __{{{this.name}}}_Internal(subscriptionId, "{{this.eventDataType}}");
{{else}}
            string subscriptionId = AITCore.Instance.RegisterVoidSubscriptionCallback(
                onEvent,
                onError
            );
            __{{{this.name}}}_Internal(subscriptionId, "void");
{{/if}}
            return () => AITCore.Instance.Unsubscribe(subscriptionId);
#else
            // Unity Editor mock implementation
            UnityEngine.Debug.Log($"[AIT Mock] {{this.pascalName}} subscribed");
            return () => UnityEngine.Debug.Log($"[AIT Mock] {{this.pascalName}} unsubscribed");
#endif
        }

#if UNITY_WEBGL && !UNITY_EDITOR
        [System.Runtime.InteropServices.DllImport("__Internal")]
        private static extern void __{{{this.name}}}_Internal(string subscriptionId, string typeName);
#endif
{{else if this.isNamespaceCallbackBased}}
{{!-- Namespace callback-based API (GoogleAdMob.loadAppsInTossAdMob pattern) --}}
{{!-- options 객체를 JSON으로 직렬화하여 전달 --}}
{{#if this.description}}
        /// <summary>
        /// {{{this.description}}}
        /// </summary>
{{/if}}
        /// <param name="onEvent">이벤트 콜백</param>
{{#each this.parameters}}
{{#if this.description}}
        /// <param name="{{this.paramName}}">{{xmlSafe this.description}}</param>
{{/if}}
{{/each}}
        /// <param name="onError">에러 콜백</param>
        /// <returns>구독 취소를 위한 Action</returns>
{{#if this.isDeprecated}}
        [Obsolete("{{{this.deprecatedMessage}}}")]
{{/if}}
        [Preserve]
        [APICategory("{{../categoryName}}")]
        public static Action {{{this.pascalName}}}(
            Action<{{{this.callbackEventType}}}> onEvent,
{{#each this.parameters}}
            {{{this.paramType}}} {{this.paramName}}{{#if this.optional}} = null{{/if}},
{{/each}}
            Action<AITException> onError = null)
        {
#if UNITY_WEBGL && !UNITY_EDITOR
            string subscriptionId = AITCore.Instance.RegisterSubscriptionCallback<{{{this.callbackEventType}}}>(
                onEvent,
                onError
            );
            __{{{this.name}}}_Internal(AITJsonSettings.Serialize({{#if this.parameters}}{{#with (lookup this.parameters 0)}}{{this.paramName}}{{/with}}{{else}}(object)null{{/if}}), subscriptionId, "{{{this.callbackEventType}}}");
            return () => AITCore.Instance.Unsubscribe(subscriptionId);
#else
            // Unity Editor mock implementation
            UnityEngine.Debug.Log($"[AIT Mock] {{{this.pascalName}}} called");
            return () => UnityEngine.Debug.Log($"[AIT Mock] {{{this.pascalName}}} cancelled");
#endif
        }

#if UNITY_WEBGL && !UNITY_EDITOR
        [System.Runtime.InteropServices.DllImport("__Internal")]
        private static extern void __{{{this.name}}}_Internal(string options, string subscriptionId, string typeName);
#endif
{{else if this.isCallbackBased}}
{{!-- Callback-based API (loadFullScreenAd, showFullScreenAd pattern) --}}
{{#if this.description}}
        /// <summary>
        /// {{{this.description}}}
        /// </summary>
{{/if}}
{{#each this.parameters}}
{{#if this.description}}
        /// <param name="{{this.paramName}}">{{xmlSafe this.description}}</param>
{{/if}}
{{/each}}
        /// <param name="onEvent">이벤트 콜백</param>
        /// <param name="onError">에러 콜백</param>
        /// <returns>구독 취소를 위한 Action</returns>
        [Preserve]
        [APICategory("{{../categoryName}}")]
        public static Action {{{this.pascalName}}}(
{{#each this.parameters}}
            {{{this.paramType}}} {{this.paramName}},
{{/each}}
            Action<{{{this.callbackEventType}}}> onEvent,
            Action<AITException> onError = null)
        {
#if UNITY_WEBGL && !UNITY_EDITOR
            string subscriptionId = AITCore.Instance.RegisterSubscriptionCallback<{{{this.callbackEventType}}}>(
                onEvent,
                onError
            );
            __{{{this.name}}}_Internal({{#each this.parameters}}{{this.paramName}}, {{/each}}subscriptionId, "{{{this.callbackEventType}}}");
            return () => AITCore.Instance.Unsubscribe(subscriptionId);
#else
            // Unity Editor mock implementation
            UnityEngine.Debug.Log($"[AIT Mock] {{{this.pascalName}}} called");
            return () => UnityEngine.Debug.Log($"[AIT Mock] {{{this.pascalName}}} cancelled");
#endif
        }

#if UNITY_WEBGL && !UNITY_EDITOR
        [System.Runtime.InteropServices.DllImport("__Internal")]
        private static extern void __{{{this.name}}}_Internal({{#each this.parameters}}string {{this.paramName}}, {{/each}}string subscriptionId, string typeName);
#endif
{{else if this.hasNestedCallbacks}}
{{!-- Nested callback API (IAPCreateOneTimePurchaseOrder with processProductGrant pattern) --}}
{{#if this.description}}
        /// <summary>
        /// {{{this.description}}}
        /// </summary>
{{/if}}
{{#each this.parameters}}
{{#if this.description}}
        /// <param name="{{this.paramName}}">{{xmlSafe this.description}}</param>
{{/if}}
{{/each}}
        /// <returns>구독 취소를 위한 Action</returns>
        [Preserve]
        [APICategory("{{../categoryName}}")]
        public static Action {{{this.pascalName}}}({{{this.nestedCallbackParamType}}} options)
        {
#if UNITY_WEBGL && !UNITY_EDITOR
            string subscriptionId = Guid.NewGuid().ToString();

            // 중첩 콜백 등록
{{#each this.nestedCallbacks}}
            if (options.Options?.{{this.pascalName}} != null)
            {
                AITCore.Instance.RegisterNestedCallback(
                    subscriptionId,
                    "{{this.name}}",
                    options.Options.{{this.pascalName}}
                );
            }
{{/each}}

            // 이벤트 콜백 등록
            AITCore.Instance.RegisterSubscriptionCallback<{{{this.nestedCallbackEventType}}}>(
                subscriptionId,
                options.OnEvent,
                options.OnError
            );

            __{{{this.name}}}_Internal(AITJsonSettings.Serialize(options), subscriptionId, "{{{this.nestedCallbackEventType}}}");

            return () => {
                AITCore.Instance.Unsubscribe(subscriptionId);
                AITCore.Instance.RemoveNestedCallbacks(subscriptionId);
            };
#else
            // Unity Editor mock implementation
            UnityEngine.Debug.Log($"[AIT Mock] {{{this.pascalName}}} called");
            return () => UnityEngine.Debug.Log($"[AIT Mock] {{{this.pascalName}}} cancelled");
#endif
        }

#if UNITY_WEBGL && !UNITY_EDITOR
        [System.Runtime.InteropServices.DllImport("__Internal")]
        private static extern void __{{{this.name}}}_Internal(string options, string subscriptionId, string typeName);
#endif
{{else}}
{{!-- Regular API (one-time callback pattern) --}}
{{#if this.description}}
        /// <summary>
        /// {{{this.description}}}
        /// </summary>
{{/if}}
{{#each this.parameters}}
{{#if this.description}}
        /// <param name="{{this.paramName}}">{{xmlSafe this.description}}</param>
{{/if}}
{{/each}}
{{#if this.returnDescription}}
        /// <returns>{{xmlSafe this.returnDescription}}{{#if this.isNullableReturn}} 값이 없으면 null을 반환합니다.{{/if}}</returns>
{{else if this.isNullableReturn}}
        /// <returns>결과 값 또는 null</returns>
{{/if}}
{{#if this.isAsync}}
        /// <exception cref="AITException">Thrown when the API call fails</exception>
{{#if this.isDeprecated}}
        [Obsolete("{{this.deprecatedMessage}}")]
{{/if}}
        [Preserve]
        [APICategory("{{../categoryName}}")]
        public static async {{#if (eq this.callbackType "void")}}Task{{else}}Task<{{{this.callbackType}}}>{{/if}} {{{this.pascalName}}}({{#each this.parameters}}{{{this.paramType}}} {{this.paramName}}{{#if this.optional}} = null{{/if}}{{#unless @last}}, {{/unless}}{{/each}})
        {
#if UNITY_WEBGL && !UNITY_EDITOR
{{#if (eq this.callbackType "void")}}
            var tcs = new TaskCompletionSource<bool>();
            string callbackId = AITCore.Instance.RegisterCallback<object>(
                result => tcs.TrySetResult(true),
                error => tcs.TrySetException(error)
            );
            __{{{this.name}}}_Internal({{#each this.parameters}}{{#if this.isPrimitive}}{{this.paramName}}{{else}}AITJsonSettings.Serialize({{this.paramName}}){{/if}}, {{/each}}callbackId, "{{{this.callbackType}}}");
            await tcs.Task;
{{else}}
            var tcs = new TaskCompletionSource<{{{this.callbackType}}}>();
            string callbackId = AITCore.Instance.RegisterCallback<{{{this.callbackType}}}>(
                result => tcs.TrySetResult(result),
                error => tcs.TrySetException(error)
            );
            __{{{this.name}}}_Internal({{#each this.parameters}}{{#if this.isPrimitive}}{{this.paramName}}{{else}}AITJsonSettings.Serialize({{this.paramName}}){{/if}}, {{/each}}callbackId, "{{{this.callbackType}}}");
            return await tcs.Task;
{{/if}}
#else
            // Unity Editor mock implementation
            UnityEngine.Debug.Log($"[AIT Mock] {{{this.pascalName}}} called");
            await Task.CompletedTask;
{{#if (eq this.callbackType "void")}}
            // void return - nothing to return
{{else if (isNullable this.callbackType)}}
            return null;
{{else if (isArray this.callbackType)}}
            return new {{arrayElementType this.callbackType}}[0];
{{else if (eq this.callbackType "string")}}
            return "";
{{else if (eq this.callbackType "bool")}}
            return false;
{{else if (or (eq this.callbackType "int") (eq this.callbackType "float") (eq this.callbackType "double"))}}
            return 0;
{{else}}
            return default({{{this.callbackType}}});
{{/if}}
#endif
        }

#if UNITY_WEBGL && !UNITY_EDITOR
        [System.Runtime.InteropServices.DllImport("__Internal")]
        private static extern void __{{{this.name}}}_Internal({{#each this.parameters}}string {{this.paramName}}, {{/each}}string callbackId, string typeName);
#endif
{{else}}
        /// <exception cref="AITException">Thrown when the API call fails</exception>
{{#if this.isDeprecated}}
        [Obsolete("{{this.deprecatedMessage}}")]
{{/if}}
        [Preserve]
        [APICategory("{{../categoryName}}")]
        public static async {{#if (eq this.callbackType "void")}}Task{{else}}Task<{{{this.callbackType}}}>{{/if}} {{{this.pascalName}}}({{#each this.parameters}}{{{this.paramType}}} {{this.paramName}}{{#if this.optional}} = null{{/if}}{{#unless @last}}, {{/unless}}{{/each}})
        {
#if UNITY_WEBGL && !UNITY_EDITOR
{{#if (eq this.callbackType "void")}}
            var tcs = new TaskCompletionSource<bool>();
            string callbackId = AITCore.Instance.RegisterCallback<object>(
                result => tcs.TrySetResult(true),
                error => tcs.TrySetException(error)
            );
            __{{{this.name}}}_Internal({{#each this.parameters}}{{#if this.isPrimitive}}{{this.paramName}}{{else}}AITJsonSettings.Serialize({{this.paramName}}){{/if}}, {{/each}}callbackId, "{{{this.callbackType}}}");
            await tcs.Task;
{{else}}
            var tcs = new TaskCompletionSource<{{{this.callbackType}}}>();
            string callbackId = AITCore.Instance.RegisterCallback<{{{this.callbackType}}}>(
                result => tcs.TrySetResult(result),
                error => tcs.TrySetException(error)
            );
            __{{{this.name}}}_Internal({{#each this.parameters}}{{#if this.isPrimitive}}{{this.paramName}}{{else}}AITJsonSettings.Serialize({{this.paramName}}){{/if}}, {{/each}}callbackId, "{{{this.callbackType}}}");
            return await tcs.Task;
{{/if}}
#else
            // Unity Editor mock implementation
            UnityEngine.Debug.Log($"[AIT Mock] {{{this.pascalName}}} called");
            await Task.CompletedTask;
{{#if (eq this.callbackType "void")}}
            // void return - nothing to return
{{else if (isNullable this.callbackType)}}
            return null;
{{else if (eq this.callbackType "string")}}
            return "";
{{else if (eq this.callbackType "bool")}}
            return false;
{{else if (or (eq this.callbackType "int") (eq this.callbackType "float") (eq this.callbackType "double"))}}
            return 0;
{{else}}
            return default({{{this.callbackType}}});
{{/if}}
#endif
        }

#if UNITY_WEBGL && !UNITY_EDITOR
        [System.Runtime.InteropServices.DllImport("__Internal")]
        private static extern void __{{{this.name}}}_Internal({{#each this.parameters}}string {{this.paramName}}, {{/each}}string callbackId, string typeName);
#endif
{{/if}}
{{/if}}
{{/each}}
    }
}
